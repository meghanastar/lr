<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Life Reset">
    <title>‚ú® Life Reset v3</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        :root {
            /* Backgrounds */
            --bg-gradient: linear-gradient(135deg, #fdfcfb 0%, #f9f8f6 50%, #fefefe 100%);
            
            /* Powder Blue - Primary */
            --primary: #5dade2;
            --primary-light: #d6eaf8;
            --primary-lighter: #ebf5fb;
            --primary-dark: #1a5490;
            
            /* Deep Emerald Green */
            --emerald: #064e3b;
            --emerald-light: #d1fae5;
            --emerald-lighter: #ecfdf5;
            --emerald-dark: #022c22;
            
            /* Deep Royal Purple */
            --amethyst: #581c87;
            --amethyst-light: #e9d5ff;
            --amethyst-lighter: #f3e8ff;
            --amethyst-dark: #3b0764;
            
            /* Deep Wine Red */
            --ruby: #7f1d1d;
            --ruby-light: #fee2e2;
            --ruby-lighter: #fef2f2;
            --ruby-dark: #450a0a;
            
            /* Sapphire Blue */
            --sapphire: #1e3a8a;
            --sapphire-light: #dbeafe;
            --sapphire-lighter: #eff6ff;
            
            /* Gold & Topaz */
            --topaz: #92400e;
            --topaz-light: #fef3c7;
            --gold: #ca8a04;
            --gold-light: #fef9c3;
            
            /* Rose Gold */
            --rose-gold: #9f1239;
            --rose-gold-light: #ffe4e6;
            
            /* Jade */
            --jade: #14532d;
            --jade-light: #dcfce7;
            
            /* Text Colors */
            --text: #1a252f;
            --text-light: #2c3e50;
            --text-lighter: #5d6d7e;
            
            /* Semantic */
            --success: #064e3b;
            --warning: #ca8a04;
            --danger: #7f1d1d;
            
            /* Surface */
            --surface: #ffffff;
            --surface-hover: #f8f9fa;
            --border: #cbd5e0;
            
            /* Shadows */
            --shadow-sm: 0 2px 8px rgba(93, 173, 226, 0.12);
            --shadow-md: 0 4px 16px rgba(93, 173, 226, 0.16);
            --shadow-lg: 0 8px 32px rgba(93, 173, 226, 0.20);
        }
        
        body { font-family: 'DM Sans', sans-serif; background: var(--bg-gradient); color: var(--text); line-height: 1.6; overflow-x: hidden; min-height: 100vh; padding-bottom: 80px; }
        
        /* Header */
        .app-header { background: rgba(255, 255, 255, 0.95); border-bottom: 1px solid var(--border); padding: 20px; position: sticky; top: 0; z-index: 100; backdrop-filter: blur(10px); }
        .header-content { max-width: 800px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .app-title { font-family: 'Playfair Display', serif; font-size: 1.8rem; font-weight: 700; background: linear-gradient(135deg, var(--primary), var(--amethyst)); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; }
        .icon-btn { background: var(--surface); border: 1px solid var(--border); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease; font-size: 1.2rem; }
        .icon-btn:hover { background: var(--primary-light); border-color: var(--primary); transform: scale(1.05); }
        
        /* Container */
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        
        /* Today Card */
        .today-card { background: linear-gradient(135deg, var(--primary-lighter), var(--amethyst-lighter)); border-radius: 24px; padding: 30px; margin-bottom: 30px; box-shadow: var(--shadow-lg); animation: fadeInUp 0.6s ease; }
        .today-date { font-family: 'Playfair Display', serif; font-size: 2rem; font-weight: 700; color: var(--text); margin-bottom: 5px; }
        .today-subtitle { color: var(--text-light); font-size: 1rem; margin-bottom: 20px; }
        
        /* Progress Bar */
        .progress-bar-container { background: rgba(255, 255, 255, 0.7); border-radius: 12px; height: 12px; overflow: hidden; margin-bottom: 12px; }
        .progress-bar { background: linear-gradient(90deg, var(--primary), var(--emerald)); height: 100%; border-radius: 12px; transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); position: relative; }
        .progress-bar::after { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent); animation: shimmer 2s infinite; }
        @keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
        .progress-text { font-size: 0.9rem; color: var(--text-light); text-align: center; }
        
        /* View Selector */
        .view-selector { display: flex; gap: 8px; margin-bottom: 25px; background: var(--surface); padding: 6px; border-radius: 16px; box-shadow: var(--shadow-sm); }
        .view-btn { flex: 1; background: none; border: none; padding: 10px 16px; font-family: 'DM Sans', sans-serif; font-size: 0.9rem; font-weight: 500; color: var(--text-lighter); cursor: pointer; border-radius: 12px; transition: all 0.3s ease; }
        .view-btn.active { background: linear-gradient(135deg, var(--primary-light), var(--amethyst-lighter)); color: var(--primary-dark); }
        
        /* Day Section */
        .day-section { background: var(--surface); border-radius: 20px; padding: 20px; margin-bottom: 20px; box-shadow: var(--shadow-sm); animation: fadeInUp 0.4s ease; animation-fill-mode: backwards; }
        .day-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .day-title-group { display: flex; align-items: center; gap: 10px; }
        .day-title { font-family: 'Playfair Display', serif; font-size: 1.4rem; font-weight: 600; color: var(--text); }
        .day-date { font-size: 0.85rem; color: var(--text-lighter); }
        .day-stats { display: flex; align-items: center; gap: 10px; font-size: 0.85rem; }
        .completion-badge { background: var(--primary-light); color: var(--primary-dark); padding: 4px 12px; border-radius: 12px; font-weight: 500; }
        .completion-badge.complete { background: var(--emerald-light); color: var(--emerald-dark); }
        
        /* Daily Notes */
        .daily-notes { background: var(--surface-hover); border: 2px dashed var(--border); border-radius: 12px; padding: 15px; margin-bottom: 15px; }
        .daily-notes-title { font-weight: 600; color: var(--text); margin-bottom: 8px; font-size: 0.9rem; }
        .daily-notes-textarea { width: 100%; min-height: 60px; border: 1px solid var(--border); border-radius: 8px; padding: 10px; font-family: 'DM Sans', sans-serif; font-size: 0.9rem; resize: vertical; transition: all 0.3s ease; }
        .daily-notes-textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-lighter); }
        
        /* Task List */
        .task-list { display: flex; flex-direction: column; gap: 10px; }
        .task-item-wrapper { border-radius: 12px; overflow: hidden; }
        .task-item { display: flex; align-items: flex-start; gap: 12px; padding: 12px; background: var(--surface-hover); border: 1px solid var(--border); transition: all 0.3s ease; cursor: pointer; }
        .task-item:hover { background: var(--surface); box-shadow: var(--shadow-sm); }
        .task-item.completed { opacity: 0.6; }
        .task-item.completed .task-text { text-decoration: line-through; color: var(--text-lighter); }
        .task-item.expanded { border-bottom: none; border-radius: 12px 12px 0 0; }
                .task-item { 
            display: flex; 
            align-items: flex-start; 
            gap: 12px; 
            padding: 12px; 
            background: var(--surface-hover); 
            border: 1px solid var(--border); 
            transition: all 0.3s ease; 
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        
        /* Checkbox */
        .checkbox { width: 24px; height: 24px; border: 2px solid var(--primary); border-radius: 50%; flex-shrink: 0; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; margin-top: 2px; }
        .checkbox:hover { background: var(--primary-light); transform: scale(1.1); }
        .checkbox.checked { background: var(--primary); border-color: var(--primary); }
        .checkbox.checked::after { content: '‚úì'; color: white; font-size: 14px; font-weight: bold; }
        
        /* Task Content */
        .task-content { flex: 1; }
        .task-header-row { display: flex; justify-content: space-between; align-items: flex-start; }
        .task-text { font-size: 1rem; color: var(--text); margin-bottom: 6px; }
        .task-expand-icon { font-size: 0.8rem; color: var(--text-lighter); transition: transform 0.3s ease; }
        .task-item.expanded .task-expand-icon { transform: rotate(180deg); }
        
        /* Task Meta */
        .task-meta { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
        .task-tag { font-size: 0.75rem; padding: 3px 10px; border-radius: 8px; font-weight: 500; }
        .tag-habit { background: var(--sapphire-light); color: var(--sapphire); }
        .tag-cleaning { background: var(--rose-gold-light); color: var(--rose-gold); }
        .tag-skincare { background: var(--amethyst-light); color: var(--amethyst); }
        .tag-hair { background: var(--topaz-light); color: var(--topaz); }
        .tag-laundry { background: var(--jade-light); color: var(--jade); }
        .tag-special { background: var(--gold-light); color: var(--gold); }
        .tag-deepclean { background: var(--emerald-light); color: var(--emerald); }
        .task-time { font-size: 0.75rem; color: var(--text-lighter); }
        
        /* Task Details Dropdown */
        .task-details { background: white; border: 1px solid var(--border); border-top: none; padding: 20px; border-radius: 0 0 12px 12px; display: none; animation: slideDown 0.3s ease; }
        .task-details.active { display: block; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .task-details-section { margin-bottom: 15px; }
        .task-details-section:last-child { margin-bottom: 0; }
        .task-details-title { font-weight: 600; font-size: 0.9rem; color: var(--text); margin-bottom: 8px; }
        .task-details-content { color: var(--text-light); font-size: 0.9rem; line-height: 1.6; }
        .task-details-list { list-style: none; padding-left: 0; }
        .task-details-list li { padding: 4px 0; padding-left: 20px; position: relative; }
        .task-details-list li::before { content: '‚Ä¢'; position: absolute; left: 5px; color: var(--primary); }
        
        /* Task Notes Input */
        .task-notes-input { width: 100%; min-height: 80px; border: 2px solid var(--border); border-radius: 8px; padding: 10px; font-family: 'DM Sans', sans-serif; font-size: 0.9rem; resize: vertical; transition: all 0.3s ease; }
        .task-notes-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-lighter); }
        
        /* Task Action Buttons */
        .task-actions-row { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        .task-action-btn-small { padding: 8px 16px; border: none; border-radius: 8px; font-size: 0.85rem; font-weight: 500; cursor: pointer; transition: all 0.3s ease; color: white; }
        .btn-edit { background: var(--primary); }
        .btn-edit:hover { background: var(--primary-dark); }
        .btn-move { background: var(--amethyst); }
        .btn-move:hover { background: var(--amethyst-dark); }
        .btn-delete { background: var(--ruby); }
        .btn-delete:hover { background: var(--ruby-dark); }
        .task-action-btn-small:hover { transform: translateY(-2px); box-shadow: var(--shadow-sm); }
        
        /* Add Task Button */
        .add-task-btn { width: 100%; padding: 12px; background: var(--surface-hover); border: 2px dashed var(--border); border-radius: 12px; color: var(--text-lighter); font-size: 0.9rem; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .add-task-btn:hover { background: var(--primary-light); border-color: var(--primary); color: var(--primary-dark); }
        
        /* Bottom Navigation */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(255, 255, 255, 0.95); border-top: 1px solid var(--border); padding: 10px; display: flex; justify-content: space-around; box-shadow: 0 -4px 16px rgba(93, 173, 226, 0.08); z-index: 100; backdrop-filter: blur(10px); }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; padding: 8px; background: none; border: none; cursor: pointer; transition: all 0.3s ease; border-radius: 12px; }
        .nav-item:hover { background: var(--surface-hover); }
        .nav-item.active { background: var(--primary-light); }
        .nav-icon { font-size: 1.5rem; transition: color 0.3s ease; }
        .nav-item .nav-icon { color: var(--text-lighter); }
        .nav-item.active .nav-icon { color: var(--primary-dark); }
        .nav-label { font-size: 0.7rem; color: var(--text-lighter); }
        .nav-item.active .nav-label { color: var(--primary-dark); font-weight: 500; }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(5px); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background: var(--surface); border-radius: 24px; padding: 30px; max-width: 500px; width: 100%; max-height: 80vh; overflow-y: auto; box-shadow: var(--shadow-lg); animation: modalSlideUp 0.4s ease; }
        @keyframes modalSlideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-family: 'Playfair Display', serif; font-size: 1.6rem; font-weight: 600; }
        .modal-close { background: none; border: none; font-size: 2rem; color: var(--text-lighter); cursor: pointer; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.3s ease; }
        .modal-close:hover { background: var(--surface-hover); color: var(--text); }
        
        /* Forms */
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 0.9rem; font-weight: 500; color: var(--text); margin-bottom: 8px; }
        .form-input, .form-textarea, .form-select { width: 100%; padding: 12px 16px; border: 2px solid var(--border); border-radius: 12px; font-family: 'DM Sans', sans-serif; font-size: 1rem; color: var(--text); background: var(--surface); transition: all 0.3s ease; }
        .form-input:focus, .form-textarea:focus, .form-select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-lighter); }
        .form-textarea { min-height: 100px; resize: vertical; }
        
        /* Buttons */
        .btn { padding: 12px 24px; border: none; border-radius: 12px; font-family: 'DM Sans', sans-serif; font-size: 1rem; font-weight: 500; cursor: pointer; transition: all 0.3s ease; }
        .btn-primary { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; width: 100%; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        
        /* Settings */
        .settings-section { margin-bottom: 30px; }
        .settings-title { font-family: 'Playfair Display', serif; font-size: 1.3rem; font-weight: 600; margin-bottom: 15px; }
        .info-box { background: var(--primary-light); border-radius: 12px; padding: 15px; margin-bottom: 20px; color: var(--text); font-size: 0.9rem; line-height: 1.5; }
        
        /* Animations */
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .hidden { display: none !important; }
                /* Monthly Calendar */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .calendar-day-header {
            text-align: center;
            font-weight: 600;
            color: var(--text-light);
            padding: 10px;
            font-size: 0.85rem;
        }
        
        .calendar-day {
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 12px;
            min-height: 100px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .calendar-day:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-sm);
        }
        
        .calendar-day.today {
            border-color: var(--primary);
            background: var(--primary-lighter);
        }
        
        .calendar-day.other-month {
            opacity: 0.4;
        }
        
        .calendar-day-number {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 8px;
            color: var(--text);
        }
        
        .calendar-day-tasks {
            font-size: 0.75rem;
            color: var(--text-light);
        }
        
        .calendar-completion {
            margin-top: 8px;
            font-size: 0.7rem;
            padding: 3px 8px;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
        }
        
        .calendar-completion.high {
            background: var(--emerald-light);
            color: var(--emerald-dark);
        }
        
        .calendar-completion.medium {
            background: var(--primary-light);
            color: var(--primary-dark);
        }
        
        .calendar-completion.low {
            background: var(--ruby-light);
            color: var(--ruby-dark);
        }
                /* Drag & Drop */
        .task-item[draggable="true"] {
            cursor: move;
        }
        
        .task-item.dragging {
            opacity: 0.5;
            border: 2px dashed var(--primary);
        }
        
        .task-item.drag-over {
            border-top: 3px solid var(--primary);
        }
        /* Capture List */
        .filter-btn {
            padding: 8px 16px;
            border: 1px solid var(--border);
            background: var(--surface);
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .filter-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .capture-item {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }
        
        .capture-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .capture-item.unassigned {
            border-left: 4px solid #f59e0b;
        }
        
        .capture-item.assigned {
            border-left: 4px solid var(--primary);
        }
        
        .capture-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .capture-status.unassigned {
            background: #fef3c7;
            color: #92400e;
        }
        
        .capture-status.assigned {
            background: var(--primary-lighter);
            color: var(--primary-dark);
        }


        /* Responsive */
        @media (max-width: 768px) {
            .container { padding: 15px; }
            .today-card { padding: 20px; }
            .today-date { font-size: 1.6rem; }
            .day-title { font-size: 1.2rem; }
        }
    </style>
</head>
<body>
    <div class="app-header">
        <div class="header-content">
            <h1 class="app-title">‚ú® Life Reset</h1>
            <div class="header-actions">
                <button class="icon-btn" onclick="generateNewWeek()" title="Generate New Week">üîÑ</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div id="today-view" class="view-content">
            <div class="today-card">
                <div class="today-date" id="today-date">Loading...</div>
                <div class="today-subtitle" id="today-subtitle">Your tasks for today</div>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="today-progress" style="width: 0%"></div>
                </div>
                <div class="progress-text" id="progress-text">0 of 0 tasks complete</div>
            </div>
            <div id="today-tasks"></div>
        </div>

        <div id="week-view" class="view-content hidden">
            <div class="view-selector">
                <button class="view-btn active" onclick="showWeek('current')">This Week</button>
                <button class="view-btn" onclick="showWeek('next')">Next Week</button>
            </div>
            <div id="week-content"></div>
        </div>

        <div id="routines-view" class="view-content hidden">
            <h2 style="font-family: 'Playfair Display', serif; font-size: 1.8rem; margin-bottom: 20px;">üìñ Routines Library</h2>
            <div id="routines-content"></div>
        </div>

        <div id="settings-view" class="view-content hidden">
            <div class="settings-section">
                <h2 class="settings-title">About Your App</h2>
                <div class="info-box">
                    <strong>How it works:</strong><br>
                    ‚Ä¢ Your weekly routine auto-generates new weeks<br>
                    ‚Ä¢ Check off tasks as you complete them<br>
                    ‚Ä¢ Click tasks to see details & add notes<br>
                    ‚Ä¢ Your progress saves automatically
                </div>
            </div>

            <div class="settings-section">
                <h2 class="settings-title">Backup & Restore</h2>
                <div class="info-box" style="background: var(--amethyst-light);">
                    <strong>üíæ Protect your data!</strong><br>
                    Export: Download a backup file<br>
                    Import: Restore from a backup file
                </div>
                <button class="btn btn-primary" onclick="exportData()" style="margin-bottom: 10px;">üíæ Export Backup</button>
                <button class="btn btn-primary" onclick="document.getElementById('import-file').click()" style="margin-bottom: 10px; background: linear-gradient(135deg, var(--emerald), var(--jade));">üìÇ Import Backup</button>
                <input type="file" id="import-file" accept=".json" onchange="importData(event)" style="display: none;">
            </div>

            <div class="settings-section">
                <h2 class="settings-title">Quick Actions</h2>
                <button class="btn btn-primary" onclick="generateNewWeek()" style="margin-bottom: 10px;">üîÑ Generate New Week</button>
                <button class="btn btn-primary" onclick="resetApp()" style="background: linear-gradient(135deg, var(--ruby), var(--ruby-dark));">‚ö†Ô∏è Reset All Data</button>
            </div>
                        <div class="settings-section">
                <h2 class="settings-title">Recurring Tasks</h2>
                <div class="info-box">
                    <strong>üîÑ Manage your recurring tasks</strong><br>
                    These tasks auto-add to future weeks
                </div>
                <button class="btn btn-primary" onclick="showRecurringTasksModal()" style="margin-bottom: 10px; background: linear-gradient(135deg, var(--amethyst), var(--amethyst-dark));">View & Manage Recurring Tasks</button>
            </div>
        </div>
    </div>
            <div id="month-view" class="view-content hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <button class="icon-btn" onclick="previousMonth()">‚óÄ</button>
                <h2 id="month-title" style="font-family: 'Playfair Display', serif; font-size: 1.8rem;">February 2026</h2>
                <button class="icon-btn" onclick="nextMonth()">‚ñ∂</button>
            </div>
            <div id="month-calendar"></div>
        </div>

        
        <div id="metrics-view" class="view-content hidden">
            <h2 style="font-family: 'Playfair Display', serif; font-size: 1.8rem; margin-bottom: 30px;">üìä Your Metrics</h2>
            
            <div class="day-section" style="background: linear-gradient(135deg, var(--emerald-lighter), var(--primary-lighter)); padding: 25px;">
                <h3 style="font-family: 'Playfair Display', serif; font-size: 1.4rem; margin-bottom: 15px;">üî• Current Streak</h3>
                <div style="font-size: 3rem; font-weight: 700; color: var(--emerald); text-align: center;" id="streak-count">0</div>
                <div style="text-align: center; color: var(--text-light); margin-top: 10px;">days in a row</div>
            </div>

            <div class="day-section">
                <h3 style="font-family: 'Playfair Display', serif; font-size: 1.3rem; margin-bottom: 15px;">üìà This Week</h3>
                <div id="week-stats"></div>
            </div>

            <div class="day-section">
                <h3 style="font-family: 'Playfair Display', serif; font-size: 1.3rem; margin-bottom: 15px;">üèÜ All Time</h3>
                <div id="alltime-stats"></div>
            </div>
        </div>
    <div class="bottom-nav">
        <button class="nav-item active" onclick="switchView('today')">
            <div class="nav-icon">üìÖ</div>
            <div class="nav-label">Today</div>
        </button>
        <button class="nav-item" onclick="switchView('week')">
            <div class="nav-icon">üìÜ</div>
            <div class="nav-label">Week</div>
        </button>
        <button class="nav-item" onclick="switchView('month')">
            <div class="nav-icon">üóìÔ∏è</div>
            <div class="nav-label">Month</div>
        </button>
        <button class="nav-item" onclick="switchView('metrics')">
            <div class="nav-icon">üìä</div>
            <div class="nav-label">Metrics</div>
        </button>
        <button class="nav-item" onclick="switchView('routines')">
            <div class="nav-icon">üìñ</div>
            <div class="nav-label">Routines</div>
        </button>
        <button class="nav-item" onclick="switchView('settings')">
            <div class="nav-icon">‚öôÔ∏è</div>
            <div class="nav-label">Settings</div>
        </button>
        <button class="nav-item" onclick="switchView('capture')">
            <div class="nav-icon">üìù</div>
            <div class="nav-label">Capture</div>
        </button>
    </div>
    

    <div id="add-task-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Task</h2>
                <button class="modal-close" onclick="closeModal('add-task-modal')">√ó</button>
            </div>
            <form onsubmit="addCustomTask(event)">
                <div class="form-group">
                    <label class="form-label">Task Name</label>
                    <input type="text" class="form-input" id="task-name" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-select" id="task-category">
                        <option value="habit">Daily Habit</option>
                        <option value="cleaning">Cleaning</option>
                        <option value="skincare">Skincare</option>
                        <option value="hair">Hair Care</option>
                        <option value="laundry">Laundry</option>
                        <option value="special">Special</option>
                        <option value="deepclean">Deep Clean</option>
                    </select>
                </div>
            <div class="form-group">
                    <label class="form-label">Time Estimate (optional)</label>
                    <input type="text" class="form-input" id="task-time" placeholder="e.g., 5 min, 1 hour 30 min">
                </div>

                <button type="submit" class="btn btn-primary">Add Task</button>
            </form>
        </div>
    </div>

    <div id="edit-task-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Edit Task</h2>
                <button class="modal-close" onclick="closeModal('edit-task-modal')">√ó</button>
            </div>
            <form onsubmit="saveTaskEdit(event)">
                <div class="form-group">
                    <label class="form-label">Task Name</label>
                    <input type="text" class="form-input" id="edit-task-name" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-select" id="edit-task-category">
                        <option value="habit">Daily Habit</option>
                        <option value="cleaning">Cleaning</option>
                        <option value="skincare">Skincare</option>
                        <option value="hair">Hair Care</option>
                        <option value="laundry">Laundry</option>
                        <option value="special">Special</option>
                        <option value="deepclean">Deep Clean</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Time Estimate (optional)</label>
                    <input type="text" class="form-input" id="edit-task-time" placeholder="e.g., 5 min, 1 hour 30 min">
                </div>
                <button type="submit" class="btn btn-primary">Save Changes</button>
            </form>
        </div>
    </div>

    <div id="move-task-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Move Task</h2>
                <button class="modal-close" onclick="closeModal('move-task-modal')">√ó</button>
            </div>
            <div class="form-group">
                <label class="form-label">Move to which day?</label>
                <select class="form-select" id="move-task-day">
                    <option value="">Select a day...</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="confirmMoveTask()">Move Task</button>
        </div>
    </div>
    <div id="edit-routine-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Edit Routine</h2>
                <button class="modal-close" onclick="closeModal('edit-routine-modal')">√ó</button>
            </div>
            <form onsubmit="saveRoutineEdit(event)">
                <div class="form-group">
                    <label class="form-label">Routine Name</label>
                    <input type="text" class="form-input" id="edit-routine-name" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Time Estimate</label>
                    <input type="text" class="form-input" id="edit-routine-time" placeholder="e.g., 5 min" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-select" id="edit-routine-category">
                        <option value="habit">Daily Habit</option>
                        <option value="cleaning">Cleaning</option>
                        <option value="skincare">Skincare</option>
                        <option value="hair">Hair Care</option>
                        <option value="laundry">Laundry</option>
                        <option value="special">Special</option>
                        <option value="deepclean">Deep Clean</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Steps (one per line)</label>
                    <textarea class="form-textarea" id="edit-routine-steps" rows="6" required></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Save Changes</button>
            </form>
        </div>
    </div>

    <div id="create-routine-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Create New Routine</h2>
                <button class="modal-close" onclick="closeModal('create-routine-modal')">√ó</button>
            </div>
            <form onsubmit="saveNewRoutine(event)">
                <div class="form-group">
                    <label class="form-label">Routine Name</label>
                    <input type="text" class="form-input" id="new-routine-name" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Time Estimate</label>
                    <input type="text" class="form-input" id="new-routine-time" placeholder="e.g., 5 min" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-select" id="new-routine-category">
                        <option value="habit">Daily Habit</option>
                        <option value="cleaning">Cleaning</option>
                        <option value="skincare">Skincare</option>
                        <option value="hair">Hair Care</option>
                        <option value="laundry">Laundry</option>
                        <option value="special">Special</option>
                        <option value="deepclean">Deep Clean</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Steps (one per line)</label>
                    <textarea class="form-textarea" id="new-routine-steps" rows="6" placeholder="Step 1&#10;Step 2&#10;Step 3" required></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Create Routine</button>
            </form>
        </div>
    </div>

    <div id="add-routine-schedule-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add to Schedule</h2>
                <button class="modal-close" onclick="closeModal('add-routine-schedule-modal')">√ó</button>
            </div>
            <div class="form-group">
                <label class="form-label">Add to which day?</label>
                <select class="form-select" id="routine-schedule-day">
                    <option value="today">Today</option>
                    <option value="tomorrow">Tomorrow</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="confirmAddRoutineToSchedule()">Add to Schedule</button>
        </div>
    </div>
    <div id="add-to-routine-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add to Weekly Routine</h2>
                <button class="modal-close" onclick="closeModal('add-to-routine-modal')">√ó</button>
            </div>
            <form onsubmit="saveTaskToRoutine(event)">
                <div class="form-group">
                    <label class="form-label">Repeat Frequency</label>
                    <select class="form-select" id="routine-frequency">
                        <option value="daily">Daily (every day)</option>
                        <option value="weekly">Weekly (specific days)</option>
                        <option value="biweekly">Bi-weekly (every 2 weeks)</option>
                        <option value="monthly">Monthly (specific date)</option>
                    </select>
                </div>
                <div class="form-group" id="days-selector">
                    <label class="form-label">Repeat on these days:</label>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="day-monday" value="monday">
                            <span>Monday</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="day-tuesday" value="tuesday">
                            <span>Tuesday</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="day-wednesday" value="wednesday">
                            <span>Wednesday</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="day-thursday" value="thursday">
                            <span>Thursday</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="day-friday" value="friday">
                            <span>Friday</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="day-saturday" value="saturday">
                            <span>Saturday</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="day-sunday" value="sunday">
                            <span>Sunday</span>
                        </label>
                    </div>
                </div>
                <div class="info-box" style="background: var(--amethyst-light);">
                    <strong>üìÖ Note:</strong> This will add the task to your weekly template starting from next week. It won't affect previous weeks.
                </div>
                <button type="submit" class="btn btn-primary">Add to Routine</button>
            </form>
        </div>
    </div>
    <div id="delete-recurring-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Delete Recurring Task</h2>
                <button class="modal-close" onclick="closeModal('delete-recurring-modal')">√ó</button>
            </div>
            <p style="margin-bottom: 20px; color: var(--text-light);">This is a recurring task. What would you like to do?</p>
            <button class="btn btn-primary" onclick="deleteRecurringInstance()" style="margin-bottom: 10px; background: linear-gradient(135deg, var(--primary), var(--primary-dark));">Delete Only This Instance</button>
            <button class="btn btn-primary" onclick="deleteRecurringAll()" style="background: linear-gradient(135deg, var(--ruby), var(--ruby-dark));">Delete All Future Instances</button>
        </div>
    </div>
    
    <div id="recurring-tasks-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Recurring Tasks</h2>
                <button class="modal-close" onclick="closeModal('recurring-tasks-modal')">√ó</button>
            </div>
            <div id="recurring-tasks-list"></div>
        </div>
    </div>
    
            <div id="capture-view" class="view-content hidden">
                        <div id="add-capture-item-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Add Capture Item</h2>
                    <button class="modal-close" onclick="closeModal('add-capture-item-modal')">√ó</button>
                </div>
                
                <input type="text" id="capture-item-text" placeholder="What did you discover?" style="width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem;">
                
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Category</label>
                <select id="capture-item-category" style="width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem;">
                    <option value="deep-clean">Deep Clean</option>
                    <option value="maintenance">Maintenance</option>
                    <option value="projects">Projects</option>
                    <option value="shopping">Shopping</option>
                    <option value="organizing">Organizing</option>
                    <option value="other">Other</option>
                </select>
                
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Priority (optional)</label>
                <select id="capture-item-priority" style="width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem;">
                    <option value="">None</option>
                    <option value="low">Low</option>
                    <option value="medium">Medium</option>
                    <option value="high">High</option>
                </select>
                
                <textarea id="capture-item-notes" placeholder="Notes (optional)" style="width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem; min-height: 80px;"></textarea>
                
                <button class="btn btn-primary" onclick="saveCaptureItem()" style="width: 100%; background: linear-gradient(135deg, var(--primary), var(--primary-dark));">Add to Capture List</button>
            </div>
        </div>

            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="font-family: 'Playfair Display', serif; font-size: 1.8rem;">üìù Capture List</h2>
                <button class="btn btn-primary" onclick="openAddCaptureItemModal()">+ Add Item</button>
            </div>
            
            <div style="margin-bottom: 30px;">
                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
                    <button class="filter-btn active" onclick="filterCaptureList('all')">All</button>
                    <button class="filter-btn" onclick="filterCaptureList('unassigned')">Unassigned</button>
                    <button class="filter-btn" onclick="filterCaptureList('assigned')">Assigned</button>
                </div>
            </div>
            
            <div id="capture-list-content"></div>
        </div>
            
    <div id="day-detail-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="day-detail-title">Loading...</h2>
                <button class="modal-close" onclick="closeModal('day-detail-modal')">√ó</button>
            </div>
            
            <div class="daily-notes" style="margin-bottom: 20px;">
                <div class="daily-notes-title">üìî Notes for this day</div>
                <textarea class="daily-notes-textarea" id="day-detail-notes" placeholder="Add notes..."></textarea>
            </div>
            
            <div style="margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h3 style="font-size: 1.1rem; font-weight: 600;">Tasks</h3>
                    <span id="day-detail-completion" class="completion-badge">0/0</span>
                </div>
                <div id="day-detail-tasks"></div>
            </div>
            
            <button class="btn btn-primary" onclick="goToDay()" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark));">
                Go to This Day ‚Üí
            </button>
        </div>
    </div>




    <script>
        const ROUTINES_LIBRARY = {
            'make-bed': { name: 'Make Your Bed', time: '2 min', category: 'habit', steps: ['Pull covers up smooth', 'Fluff pillows', 'Takes 90 seconds', 'Sets the tone for your day'] },
            'dishes': { name: 'Dishes Protocol', time: '5 min', category: 'habit', steps: ['After every meal/snack', 'Immediately to sink OR dishwasher', 'No exceptions, no "later"', 'Wipe down counter/table', 'Future you will thank you!'] },
            'bathroom-wipe': { name: 'Bathroom Sink Wipe', time: '30 sec', category: 'habit', steps: ['Rinse electric toothbrush thoroughly', 'Wipe toothbrush handle with hand towel', 'Use same damp towel to swipe the sink', 'Takes 30 seconds max', 'Prevents gross buildup'] },
            'evening-tidy': { name: '10-Minute Evening Tidy', time: '10 min', category: 'habit', steps: ['Walk through apartment with "doesn\'t belong here" eyes', 'Return items to their homes', 'Clear kitchen counters', 'Quick dish check (catch any strays)', 'Lay out tomorrow\'s outfit', 'Check that bathroom is tidy', 'Sets you up for peaceful morning'] },
            'retinol': { name: 'Retinol Night Routine', time: '20 min', category: 'skincare', steps: ['Remove ALL makeup thoroughly (oil cleanser/micellar water)', 'Cleanse with regular face wash', 'Pat dry gently', 'WAIT 5-10 minutes (skin must be completely dry!)', 'Apply retinol (pea-sized amount)', 'Avoid eye area', 'WAIT another 10-15 minutes', 'Moisturizer + eye cream', 'NO vitamin C this night', 'NO other actives'] },
            'vitamin-c': { name: 'Vitamin C Night', time: '15 min', category: 'skincare', steps: ['Remove makeup thoroughly', 'Cleanse', 'Toner', 'Vitamin C serum (wait a few minutes)', 'Other serums if you have them', 'Moisturizer + eye cream', 'Not on retinol nights!'] },
            'hydrating-mask': { name: 'Hydrating Face Mask', time: '20 min', category: 'skincare', steps: ['Do this before your evening routine', 'Cleanse face first', 'Apply hydrating mask', 'Leave on 10-20 min', 'Relax! Read, watch something, vibe', 'Remove/rinse', 'Continue with evening routine + Vitamin C'] },
            'hair-wash': { name: 'Hair Wash Day', time: '30-40 min', category: 'hair', steps: ['Rinse body', 'Shampoo hair (focus scalp not ends)', 'Condition (mid-lengths to ends, avoid roots)', 'Let sit while washing body', 'Rinse thoroughly', 'Pat hair with towel (don\'t rub)', 'Moisturize body', 'Proceed to styling'] },
            'kitchen-clean': { name: 'Kitchen Deep Clean', time: '30-45 min', category: 'cleaning', steps: ['Wipe all counters and backsplash', 'Clean stovetop thoroughly', 'Microwave inside and out', 'Scrub sink, shine faucet', 'Sweep and mop floors', 'Move and shake rugs', 'Take out trash'] },
            'vacuum-floors': { name: 'Vacuum & Floors', time: '30 min', category: 'cleaning', steps: ['Vacuum all carpets', 'Shake rugs outside (not the shag rug)', 'Swiffer/sweep hard floors', 'Spot clean any stains', 'Return rugs to place'] },
            'bathroom-quick': { name: 'Bathroom Quick-Clean', time: '15 min', category: 'cleaning', steps: ['Wipe down toilet seat and rim', 'Wipe sink and faucet', 'Clean mirror', 'Sweep floor', 'Check supplies (TP, soap)', 'Hang fresh hand towel'] },
            'pillowcases': { name: 'Pillowcases Laundry', time: '5 min', category: 'laundry', steps: ['Strip pillowcases from bed', 'Add to normal laundry load', 'Wash with your regular clothes', 'Put fresh pillowcases on when dry', 'Every week keeps skin happy!'] }
        };

        const DEFAULT_TEMPLATE = {
            monday: [
                { text: 'Make bed', category: 'habit', routine: 'make-bed' },
                { text: 'Dishes protocol', category: 'habit', routine: 'dishes' },
                { text: 'Bathroom wipe', category: 'habit', routine: 'bathroom-wipe' },
                { text: '10-min evening tidy', category: 'habit', routine: 'evening-tidy' },
                { text: 'Retinol night', category: 'skincare', routine: 'retinol' }
            ],
            tuesday: [
                { text: 'Make bed', category: 'habit', routine: 'make-bed' },
                { text: 'Dishes protocol', category: 'habit', routine: 'dishes' },
                { text: 'Bathroom wipe', category: 'habit', routine: 'bathroom-wipe' },
                { text: '10-min evening tidy', category: 'habit', routine: 'evening-tidy' }
            ],
            wednesday: [
                { text: 'Make bed', category: 'habit', routine: 'make-bed' },
                { text: 'Dishes protocol', category: 'habit', routine: 'dishes' },
                { text: 'Bathroom wipe', category: 'habit', routine: 'bathroom-wipe' },
                { text: '10-min evening tidy', category: 'habit', routine: 'evening-tidy' },
                { text: 'Vitamin C night', category: 'skincare', routine: 'vitamin-c' }
            ],
            thursday: [
                { text: 'Make bed', category: 'habit', routine: 'make-bed' },
                { text: 'Dishes protocol', category: 'habit', routine: 'dishes' },
                { text: 'Bathroom wipe', category: 'habit', routine: 'bathroom-wipe' },
                { text: '10-min evening tidy', category: 'habit', routine: 'evening-tidy' },
                { text: 'Hair wash day', category: 'hair', routine: 'hair-wash' }
            ],
            friday: [
                { text: 'Make bed', category: 'habit', routine: 'make-bed' },
                { text: 'Dishes protocol', category: 'habit', routine: 'dishes' },
                { text: 'Bathroom wipe', category: 'habit', routine: 'bathroom-wipe' },
                { text: '10-min evening tidy', category: 'habit', routine: 'evening-tidy' },
                { text: 'Hydrating face mask', category: 'skincare', routine: 'hydrating-mask' },
                { text: 'Vitamin C night', category: 'skincare', routine: 'vitamin-c' },
                { text: 'Quick vacuum', category: 'cleaning' }
            ],
            saturday: [
                { text: 'Make bed', category: 'habit', routine: 'make-bed' },
                { text: 'Dishes protocol', category: 'habit', routine: 'dishes' },
                { text: 'Bathroom wipe', category: 'habit', routine: 'bathroom-wipe' },
                { text: '10-min evening tidy', category: 'habit', routine: 'evening-tidy' }
            ],
            sunday: [
                { text: 'Make bed', category: 'habit', routine: 'make-bed' },
                { text: 'Kitchen deep clean', category: 'cleaning', time: '10:00', routine: 'kitchen-clean' },
                { text: 'Vacuum & floors', category: 'cleaning', routine: 'vacuum-floors' },
                { text: 'Bathroom quick-clean', category: 'cleaning', routine: 'bathroom-quick' },
                { text: 'Vitamin C night', category: 'skincare', routine: 'vitamin-c' },
                { text: 'Pillowcases laundry', category: 'laundry', routine: 'pillowcases' }
            ]
        };

        let currentView = 'today';
        let currentWeekView = 'current';
        let currentModalDay = null;
        let currentEditTask = null;
        let currentMoveTask = null;
        let expandedTasks = new Set();

        function saveData(key, value) {
            try { localStorage.setItem(key, JSON.stringify(value)); } 
            catch (error) { console.error('Save error:', error); }
        }

        function loadData(key) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : null;
            } catch (error) {
                console.error('Load error:', error);
                return null;
            }
        }

        function getWeekStart(date = new Date()) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }
        
        function parseLocalDate(dateKey) {
            const [year, month, day] = dateKey.split('-').map(Number);
            return new Date(year, month - 1, day);
        }


        function formatDate(date) { return date.toISOString().split('T')[0]; }
        function getWeekKey(weekStart) { return `week-${formatDate(weekStart)}`; }
        function getDayName(dayIndex) { return ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'][dayIndex]; }
        function formatDisplayDate(date) { const options = { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' }; return date.toLocaleDateString('en-US', options); }
        function formatShortDate(date) { const options = { month: 'short', day: 'numeric' }; return date.toLocaleDateString('en-US', options); }

                function generateWeekData(weekStart) {
            const weekKey = getWeekKey(weekStart);
            const existing = loadData(weekKey);
            if (existing) return existing;

            const weekData = {};
            const recurringTasks = loadData('recurring-tasks') || [];
            
            for (let i = 0; i < 7; i++) {
                const dayDate = new Date(weekStart);
                dayDate.setDate(weekStart.getDate() + i);
                const dayName = getDayName(i);
                const dateKey = formatDate(dayDate);
                
                // Start with template tasks
                const dayTasks = DEFAULT_TEMPLATE[dayName].map(task => ({
                    ...task,
                    id: Date.now() + Math.random(),
                    completed: false,
                    notes: ''
                }));
                
                // Add recurring tasks that apply to this day
                recurringTasks.forEach(recTask => {
                    const taskStartDate = new Date(recTask.startDate);
                    const currentDate = new Date(dateKey);
                    
                    // Only add if this week is on or after the task's start date
                    if (currentDate >= taskStartDate) {
                        let shouldAdd = false;
                        
                        if (recTask.frequency === 'daily') {
                            shouldAdd = true;
                        } else if (recTask.frequency === 'weekly') {
                            shouldAdd = recTask.days.includes(dayName);
                        } else if (recTask.frequency === 'biweekly') {
                            const weeksDiff = Math.floor((currentDate - taskStartDate) / (7 * 24 * 60 * 60 * 1000));
                            shouldAdd = (weeksDiff % 2 === 0) && recTask.days.includes(dayName);
                        } else if (recTask.frequency === 'monthly') {
                            const dayOfMonth = currentDate.getDate();
                            shouldAdd = recTask.days.includes(`day-${dayOfMonth}`);
                        }
                        
                        if (shouldAdd) {
                            dayTasks.push({
                                text: recTask.text,
                                category: recTask.category,
                                time: recTask.time,
                                routine: recTask.routine,
                                id: Date.now() + Math.random(),
                                completed: false,
                                notes: '',
                                recurringId: recTask.id
                            });
                        }
                    }
                });
                
                weekData[dateKey] = {
                    dayName,
                    tasks: dayTasks,
                    dayNotes: ''
                };
            }

            saveData(weekKey, weekData);
            return weekData;
        }


        function toggleTask(weekKey, dateKey, taskId, event) {
            if (event) event.stopPropagation();
            const weekData = loadData(weekKey);
            const task = weekData[dateKey].tasks.find(t => t.id === taskId);
            task.completed = !task.completed;
            saveData(weekKey, weekData);
            renderCurrentView();
        }

        function toggleTaskDetails(weekKey, dateKey, taskId) {
            // Don't toggle if we just finished dragging
            if (isDragging) {
                return;
            }
            
            const taskKey = `${weekKey}-${dateKey}-${taskId}`;
            if (expandedTasks.has(taskKey)) {
                expandedTasks.delete(taskKey);
            } else {
                expandedTasks.add(taskKey);
            }
            renderCurrentView();
        }


        function saveTaskNotes(weekKey, dateKey, taskId, notes) {
            const weekData = loadData(weekKey);
            const task = weekData[dateKey].tasks.find(t => t.id === taskId);
            task.notes = notes;
            saveData(weekKey, weekData);
        }

        function saveDayNotes(weekKey, dateKey, notes) {
            const weekData = loadData(weekKey);
            weekData[dateKey].dayNotes = notes;
            saveData(weekKey, weekData);
        }

        function openEditTaskModal(weekKey, dateKey, taskId, event) {
            event.stopPropagation();
            const weekData = loadData(weekKey);
            const task = weekData[dateKey].tasks.find(t => t.id === taskId);
            
            currentEditTask = { weekKey, dateKey, taskId };
            document.getElementById('edit-task-name').value = task.text;
            document.getElementById('edit-task-category').value = task.category;
            document.getElementById('edit-task-time').value = task.time || '';
            document.getElementById('edit-task-modal').classList.add('active');
        }

        function saveTaskEdit(event) {
            event.preventDefault();
            if (!currentEditTask) return;

            const { weekKey, dateKey, taskId } = currentEditTask;
            const weekData = loadData(weekKey);
            const task = weekData[dateKey].tasks.find(t => t.id === taskId);
            
            task.text = document.getElementById('edit-task-name').value;
            task.category = document.getElementById('edit-task-category').value;
            task.time = document.getElementById('edit-task-time').value || undefined;
            
            saveData(weekKey, weekData);
            closeModal('edit-task-modal');
            renderCurrentView();
        }

        function openMoveTaskModal(weekKey, dateKey, taskId, event) {
            event.stopPropagation();
            currentMoveTask = { weekKey, dateKey, taskId };
            
            const weekStart = currentWeekView === 'current' ? getWeekStart() : getWeekStart(new Date(Date.now() + 7 * 24 * 60 * 60 * 1000));
            const select = document.getElementById('move-task-day');
            select.innerHTML = '<option value="">Select a day...</option>';
            
            for (let i = 0; i < 7; i++) {
                const dayDate = new Date(weekStart);
                dayDate.setDate(weekStart.getDate() + i);
                const key = formatDate(dayDate);
                if (key !== dateKey) {
                    const dayName = getDayName(i);
                    select.innerHTML += `<option value="${key}">${dayName.charAt(0).toUpperCase() + dayName.slice(1)} - ${formatShortDate(dayDate)}</option>`;
                }
            }
            
            document.getElementById('move-task-modal').classList.add('active');
        }

        function confirmMoveTask() {
            if (!currentMoveTask) return;
            const targetDay = document.getElementById('move-task-day').value;
            if (!targetDay) return;

            const { weekKey, dateKey, taskId } = currentMoveTask;
            const weekData = loadData(weekKey);
            
            const taskIndex = weekData[dateKey].tasks.findIndex(t => t.id === taskId);
            const task = weekData[dateKey].tasks[taskIndex];
            weekData[dateKey].tasks.splice(taskIndex, 1);
            weekData[targetDay].tasks.push(task);
            
            saveData(weekKey, weekData);
            closeModal('move-task-modal');
            renderCurrentView();
        }

            function deleteTask(weekKey, dateKey, taskId, event) {
            event.stopPropagation();
            
            const weekData = loadData(weekKey);
            const task = weekData[dateKey].tasks.find(t => t.id === taskId);
            
            // Check if this is a recurring task
            if (task.recurringId) {
                // Store in global variable for modal to access
                window.currentDeleteTask = { weekKey, dateKey, taskId, recurringId: task.recurringId };
                document.getElementById('delete-recurring-modal').classList.add('active');
            } else {
                if (!confirm('Delete this task?')) return;
                const taskIndex = weekData[dateKey].tasks.findIndex(t => t.id === taskId);
                weekData[dateKey].tasks.splice(taskIndex, 1);
                saveData(weekKey, weekData);
                renderCurrentView();
            }
        }

        function deleteRecurringInstance() {
            if (!window.currentDeleteTask) return;
            
            const { weekKey, dateKey, taskId } = window.currentDeleteTask;
            const weekData = loadData(weekKey);
            const taskIndex = weekData[dateKey].tasks.findIndex(t => t.id === taskId);
            weekData[dateKey].tasks.splice(taskIndex, 1);
            saveData(weekKey, weekData);
            
            closeModal('delete-recurring-modal');
            renderCurrentView();
            alert('‚úÖ Deleted this instance!');
        }

        function deleteRecurringAll() {
            if (!window.currentDeleteTask) return;
            
            const { weekKey, dateKey, taskId, recurringId } = window.currentDeleteTask;
            
            // Delete from this week
            const weekData = loadData(weekKey);
            const taskIndex = weekData[dateKey].tasks.findIndex(t => t.id === taskId);
            weekData[dateKey].tasks.splice(taskIndex, 1);
            saveData(weekKey, weekData);
            
            // Delete from recurring template
            const recurringTasks = loadData('recurring-tasks') || [];
            const filtered = recurringTasks.filter(rt => rt.id !== recurringId);
            saveData('recurring-tasks', filtered);
            
            closeModal('delete-recurring-modal');
            renderCurrentView();
            alert('‚úÖ Removed from all future weeks!');
        }
        function showRecurringTasksModal() {
            const recurringTasks = loadData('recurring-tasks') || [];
            
            if (recurringTasks.length === 0) {
                document.getElementById('recurring-tasks-list').innerHTML = '<p style="color: var(--text-lighter);">No recurring tasks yet!</p>';
            } else {
                let html = '';
                recurringTasks.forEach(task => {
                    const daysDisplay = task.frequency === 'daily' ? 'Every day' : 
                                       task.frequency === 'monthly' ? `Monthly (${task.days[0]})` :
                                       task.days.join(', ');
                    
                    html += `
                        <div style="background: var(--surface-hover); border-radius: 12px; padding: 15px; margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div>
                                    <div style="font-weight: 600; margin-bottom: 5px;">${task.text}</div>
                                    <div style="font-size: 0.85rem; color: var(--text-lighter);">
                                        <span class="task-tag tag-${task.category}">${task.category}</span>
                                        ${task.time ? `<span style="margin-left: 8px;">‚è±Ô∏è ${task.time}</span>` : ''}
                                    </div>
                                    <div style="font-size: 0.85rem; color: var(--text-light); margin-top: 5px;">
                                        üìÖ ${task.frequency} - ${daysDisplay}
                                    </div>
                                </div>
                                <button class="task-action-btn-small btn-delete" onclick="deleteRecurringFromList(${task.id})">üóëÔ∏è</button>
                            </div>
                        </div>
                    `;
                });
                document.getElementById('recurring-tasks-list').innerHTML = html;
            }
            
            document.getElementById('recurring-tasks-modal').classList.add('active');
        }

        function deleteRecurringFromList(recurringId) {
            if (!confirm('Delete this recurring task? It will be removed from all future weeks.')) return;
            
            const recurringTasks = loadData('recurring-tasks') || [];
            const filtered = recurringTasks.filter(rt => rt.id !== recurringId);
            saveData('recurring-tasks', filtered);
            
            showRecurringTasksModal(); // Refresh the list
            alert('‚úÖ Recurring task deleted!');
        }

        function addCustomTask(event) {
            event.preventDefault();
            const name = document.getElementById('task-name').value;
            const category = document.getElementById('task-category').value;
            const time = document.getElementById('task-time').value;
            if (!currentModalDay) return;

            const weekKey = getWeekKey(getWeekStart());
            const weekData = loadData(weekKey);

            weekData[currentModalDay].tasks.push({
                id: Date.now(),
                text: name,
                category,
                time: time || undefined,
                completed: false,
                custom: true,
                notes: ''
            });

            saveData(weekKey, weekData);
            closeModal('add-task-modal');
            renderCurrentView();
        }

        function renderTaskItem(task, weekKey, dateKey) {
            const routine = task.routine ? ROUTINES_LIBRARY[task.routine] : null;
            const taskKey = `${weekKey}-${dateKey}-${task.id}`;
            const isExpanded = expandedTasks.has(taskKey);
            
            let detailsHtml = '';
            if (isExpanded) {
                detailsHtml = `
                    <div class="task-details active">
                        ${routine ? `
                            <div class="task-details-section">
                                <div class="task-details-title">‚è±Ô∏è Time: ${routine.time}</div>
                            </div>
                            <div class="task-details-section">
                                <div class="task-details-title">üìã Steps:</div>
                                <ul class="task-details-list">
                                    ${routine.steps.map(step => `<li>${step}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        <div class="task-details-section">
                            <div class="task-details-title">üìù My Notes:</div>
                            <textarea class="task-notes-input" 
                                      placeholder="Add your personal notes here..."
                                      onchange="saveTaskNotes('${weekKey}', '${dateKey}', ${task.id}, this.value)"
                                      onclick="event.stopPropagation()">${task.notes || ''}</textarea>
                        </div>
                     <div class="task-actions-row">
                            <button class="task-action-btn-small btn-edit" onclick="openEditTaskModal('${weekKey}', '${dateKey}', ${task.id}, event)">‚úèÔ∏è Edit</button>
                            <button class="task-action-btn-small btn-move" onclick="openMoveTaskModal('${weekKey}', '${dateKey}', ${task.id}, event)">üìÖ Move</button>
                            <button class="task-action-btn-small btn-delete" onclick="deleteTask('${weekKey}', '${dateKey}', ${task.id}, event)">üóëÔ∏è Delete</button>
                            <button class="task-action-btn-small" style="background: var(--amethyst); color: white;" onclick="openAddToRoutineModal('${weekKey}', '${dateKey}', ${task.id}, event)">üîÑ Add to Routine</button>
                        </div>
                    </div>
                `;
            }

            return `
                <div class="task-item-wrapper">
                    <div class="task-item ${task.completed ? 'completed' : ''} ${isExpanded ? 'expanded' : ''}" 
                         draggable="true"
                        data-week-key="${weekKey}"
                        data-date-key="${dateKey}"
                        data-task-id="${task.id}"
                         ondragstart="handleDragStart(event, '${weekKey}', '${dateKey}', ${task.id})"
                         ondragover="handleDragOver(event)"
                         ondrop="handleDrop(event, '${weekKey}', '${dateKey}', ${task.id})"
                         ondragend="handleDragEnd(event)"
                         onclick="toggleTaskDetails('${weekKey}', '${dateKey}', ${task.id})">
                        <div class="checkbox ${task.completed ? 'checked' : ''}" 
                             onclick="toggleTask('${weekKey}', '${dateKey}', ${task.id}, event)"></div>
                        <div class="task-content">
                            <div class="task-header-row">
                                <div class="task-text">${task.text}</div>
                                <span class="task-expand-icon">‚ñº</span>
                            </div>
                            <div class="task-meta">
                                <span class="task-tag tag-${task.category}">${task.category}</span>
                                ${task.time ? `<span class="task-time">‚è±Ô∏è ${task.time}</span>` : (routine ? `<span class="task-time">‚è±Ô∏è ${routine.time}</span>` : '')}
                            </div>
                        </div>
                    </div>
                    ${detailsHtml}
                </div>
            `;
        }

        function renderTodayView() {
            const today = new Date();
            const todayKey = formatDate(today);
            const weekStart = getWeekStart(today);
            const weekKey = getWeekKey(weekStart);
            const weekData = generateWeekData(weekStart);
            const dayData = weekData[todayKey];

            if (!dayData) {
                document.getElementById('today-date').textContent = formatDisplayDate(today);
                document.getElementById('today-tasks').innerHTML = '<div class="day-section"><p>No tasks for today!</p></div>';
                return;
            }

            document.getElementById('today-date').textContent = formatDisplayDate(today);
            
            const completed = dayData.tasks.filter(t => t.completed).length;
            const total = dayData.tasks.length;
            const percentage = total > 0 ? (completed / total) * 100 : 0;

            document.getElementById('today-progress').style.width = percentage + '%';
            document.getElementById('progress-text').textContent = `${completed} of ${total} tasks complete`;

            const tasksHtml = dayData.tasks.map(task => renderTaskItem(task, weekKey, todayKey)).join('');

            document.getElementById('today-tasks').innerHTML = `
                <div class="day-section">
                    <div class="daily-notes">
                        <div class="daily-notes-title">üìî Notes for Today</div>
                        <textarea class="daily-notes-textarea" 
                                  placeholder="Add notes for today..."
                                  onchange="saveDayNotes('${weekKey}', '${todayKey}', this.value)">${dayData.dayNotes || ''}</textarea>
                    </div>
                    ${tasksHtml}
                    <button class="add-task-btn" onclick="openAddTaskModal('${todayKey}')">+ Add Task</button>
                </div>
            `;
        }

        function renderWeekView() {
            const weekStart = currentWeekView === 'current' ? getWeekStart() : getWeekStart(new Date(Date.now() + 7 * 24 * 60 * 60 * 1000));
            const weekKey = getWeekKey(weekStart);
            const weekData = generateWeekData(weekStart);

            let html = '';
            for (let i = 0; i < 7; i++) {
                const dayDate = new Date(weekStart);
                dayDate.setDate(weekStart.getDate() + i);
                const dateKey = formatDate(dayDate);
                const dayData = weekData[dateKey];

                const completed = dayData.tasks.filter(t => t.completed).length;
                const total = dayData.tasks.length;
                const isComplete = completed === total && total > 0;

                const tasksHtml = dayData.tasks.map(task => renderTaskItem(task, weekKey, dateKey)).join('');

                html += `
                    <div class="day-section">
                        <div class="day-header">
                            <div class="day-title-group">
                                <span class="day-title">${dayData.dayName.charAt(0).toUpperCase() + dayData.dayName.slice(1)}</span>
                                <span class="day-date">${formatShortDate(dayDate)}</span>
                            </div>
                            <div class="day-stats">
                                <span class="completion-badge ${isComplete ? 'complete' : ''}">${completed}/${total}</span>
                            </div>
                        </div>
                        <div class="daily-notes">
                            <div class="daily-notes-title">üìî Notes</div>
                            <textarea class="daily-notes-textarea" 
                                      placeholder="Add notes..."
                                      onchange="saveDayNotes('${weekKey}', '${dateKey}', this.value)">${dayData.dayNotes || ''}</textarea>
                        </div>
                        <div class="task-list">
                            ${tasksHtml}
                            <button class="add-task-btn" onclick="openAddTaskModal('${dateKey}')">+ Add Task</button>
                        </div>
                    </div>
                `;
            }

            document.getElementById('week-content').innerHTML = html;
        }

                function renderRoutinesView() {
            let html = `
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="openCreateRoutineModal()" style="background: linear-gradient(135deg, var(--emerald), var(--jade));">
                        ‚ûï Create New Routine
                    </button>
                </div>
            `;
            
            for (const [key, routine] of Object.entries(ROUTINES_LIBRARY)) {
                html += `
                    <div style="background: var(--surface); border: 2px solid var(--border); border-radius: 16px; padding: 20px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <h3 style="font-family: 'Playfair Display', serif; font-size: 1.2rem; font-weight: 600;">${routine.name}</h3>
                            <span style="font-size: 0.85rem; color: var(--text-lighter);">‚è±Ô∏è ${routine.time}</span>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <span class="task-tag tag-${routine.category}">${routine.category}</span>
                        </div>
                        <ul class="task-details-list" style="margin-bottom: 15px;">
                            ${routine.steps.map(step => `<li>${step}</li>`).join('')}
                        </ul>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="task-action-btn-small btn-edit" onclick="openEditRoutineModal('${key}')">‚úèÔ∏è Edit</button>
                            <button class="task-action-btn-small" style="background: var(--emerald); color: white;" onclick="openAddRoutineToScheduleModal('${key}')">üìÖ Add to Schedule</button>
                            <button class="task-action-btn-small btn-delete" onclick="deleteRoutine('${key}')">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                `;
            }
            document.getElementById('routines-content').innerHTML = html;
        }

                
        function calculateStreak() {
            let streak = 0;
            const today = new Date();
            
            for (let i = 0; i < 365; i++) {
                const checkDate = new Date(today);
                checkDate.setDate(today.getDate() - i);
                const weekStart = getWeekStart(checkDate);
                const weekKey = getWeekKey(weekStart);
                const weekData = loadData(weekKey);
                
                if (!weekData) break;
                
                const dateKey = formatDate(checkDate);
                const dayData = weekData[dateKey];
                
                if (!dayData || !dayData.tasks.length) break;
                
                const completed = dayData.tasks.filter(t => t.completed).length;
                const total = dayData.tasks.length;
                const percentage = (completed / total) * 100;
                
                if (percentage >= 80) {
                    streak++;
                } else {
                    break;
                }
            }
            
            return streak;
        }

        function renderMetricsView() {
            // Current Streak
            const streak = calculateStreak();
            document.getElementById('streak-count').textContent = streak;

            // This Week Stats
            const weekStart = getWeekStart();
            const weekKey = getWeekKey(weekStart);
            const weekData = loadData(weekKey);
            
            let weekCompleted = 0;
            let weekTotal = 0;
            
            if (weekData) {
                for (let i = 0; i < 7; i++) {
                    const dayDate = new Date(weekStart);
                    dayDate.setDate(weekStart.getDate() + i);
                    const dateKey = formatDate(dayDate);
                    const dayData = weekData[dateKey];
                    
                    if (dayData) {
                        weekCompleted += dayData.tasks.filter(t => t.completed).length;
                        weekTotal += dayData.tasks.length;
                    }
                }
            }
            
            const weekPercentage = weekTotal > 0 ? Math.round((weekCompleted / weekTotal) * 100) : 0;
            
            document.getElementById('week-stats').innerHTML = `
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="font-weight: 600;">Completion Rate</span>
                        <span style="color: var(--emerald); font-weight: 700;">${weekPercentage}%</span>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" style="width: ${weekPercentage}%"></div>
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 10px; background: var(--surface-hover); border-radius: 12px;">
                    <div>
                        <div style="font-size: 2rem; font-weight: 700; color: var(--primary);">${weekCompleted}</div>
                        <div style="font-size: 0.9rem; color: var(--text-lighter);">Tasks completed</div>
                    </div>
                    <div>
                        <div style="font-size: 2rem; font-weight: 700; color: var(--text-light);">${weekTotal}</div>
                        <div style="font-size: 0.9rem; color: var(--text-lighter);">Total tasks</div>
                    </div>
                </div>
            `;

            // All Time Stats
            let allTimeCompleted = 0;
            let totalDays = 0;
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('week-')) {
                    const data = loadData(key);
                    if (data) {
                        for (const dateKey in data) {
                            const dayData = data[dateKey];
                            if (dayData && dayData.tasks) {
                                allTimeCompleted += dayData.tasks.filter(t => t.completed).length;
                                totalDays++;
                            }
                        }
                    }
                }
            }

            document.getElementById('alltime-stats').innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div style="text-align: center; padding: 20px; background: var(--amethyst-lighter); border-radius: 12px;">
                        <div style="font-size: 2.5rem; font-weight: 700; color: var(--amethyst);">${allTimeCompleted}</div>
                        <div style="font-size: 0.9rem; color: var(--text-light); margin-top: 5px;">Total Tasks<br>Completed</div>
                    </div>
                    <div style="text-align: center; padding: 20px; background: var(--gold-light); border-radius: 12px;">
                        <div style="font-size: 2.5rem; font-weight: 700; color: var(--gold);">${totalDays}</div>
                        <div style="font-size: 0.9rem; color: var(--text-light); margin-top: 5px;">Days<br>Tracked</div>
                    </div>
                </div>
            `;
        }
        let currentEditRoutineKey = null;
        let currentAddRoutineKey = null;

        function openEditRoutineModal(routineKey) {
            currentEditRoutineKey = routineKey;
            const routine = ROUTINES_LIBRARY[routineKey];
            
            document.getElementById('edit-routine-name').value = routine.name;
            document.getElementById('edit-routine-time').value = routine.time;
            document.getElementById('edit-routine-category').value = routine.category;
            document.getElementById('edit-routine-steps').value = routine.steps.join('\n');
            
            document.getElementById('edit-routine-modal').classList.add('active');
        }

        function saveRoutineEdit(event) {
            event.preventDefault();
            if (!currentEditRoutineKey) return;
            
            ROUTINES_LIBRARY[currentEditRoutineKey] = {
                name: document.getElementById('edit-routine-name').value,
                time: document.getElementById('edit-routine-time').value,
                category: document.getElementById('edit-routine-category').value,
                steps: document.getElementById('edit-routine-steps').value.split('\n').filter(s => s.trim())
            };
            
            saveData('routines-library', ROUTINES_LIBRARY);
            closeModal('edit-routine-modal');
            renderRoutinesView();
            alert('‚úÖ Routine updated!');
        }

        function openCreateRoutineModal() {
            document.getElementById('new-routine-name').value = '';
            document.getElementById('new-routine-time').value = '';
            document.getElementById('new-routine-category').value = 'habit';
            document.getElementById('new-routine-steps').value = '';
            document.getElementById('create-routine-modal').classList.add('active');
        }

        function saveNewRoutine(event) {
            event.preventDefault();
            
            const name = document.getElementById('new-routine-name').value;
            const key = name.toLowerCase().replace(/[^a-z0-9]/g, '-');
            
            ROUTINES_LIBRARY[key] = {
                name: name,
                time: document.getElementById('new-routine-time').value,
                category: document.getElementById('new-routine-category').value,
                steps: document.getElementById('new-routine-steps').value.split('\n').filter(s => s.trim())
            };
            
            saveData('routines-library', ROUTINES_LIBRARY);
            closeModal('create-routine-modal');
            renderRoutinesView();
            alert('‚úÖ New routine created!');
        }

        function deleteRoutine(routineKey) {
            if (!confirm(`Delete "${ROUTINES_LIBRARY[routineKey].name}"? This cannot be undone.`)) return;
            
            delete ROUTINES_LIBRARY[routineKey];
            saveData('routines-library', ROUTINES_LIBRARY);
            renderRoutinesView();
            alert('‚úÖ Routine deleted!');
        }

        function openAddRoutineToScheduleModal(routineKey) {
            currentAddRoutineKey = routineKey;
            document.getElementById('add-routine-schedule-modal').classList.add('active');
        }

        function confirmAddRoutineToSchedule() {
            if (!currentAddRoutineKey) return;
            
            const routine = ROUTINES_LIBRARY[currentAddRoutineKey];
            const when = document.getElementById('routine-schedule-day').value;
            
            const today = new Date();
            let targetDate;
            
            if (when === 'today') {
                targetDate = today;
            } else {
                targetDate = new Date(today);
                targetDate.setDate(today.getDate() + 1);
            }
            
            const weekStart = getWeekStart(targetDate);
            const weekKey = getWeekKey(weekStart);
            const weekData = generateWeekData(weekStart);
            const dateKey = formatDate(targetDate);
            
            weekData[dateKey].tasks.push({
                id: Date.now(),
                text: routine.name,
                category: routine.category,
                routine: currentAddRoutineKey,
                completed: false,
                notes: '',
                custom: true
            });
            
            saveData(weekKey, weekData);
            closeModal('add-routine-schedule-modal');
            alert(`‚úÖ Added "${routine.name}" to ${when}!`);
            
            if (when === 'today') {
                renderTodayView();
            }
        }

        function loadRoutinesLibrary() {
            const saved = loadData('routines-library');
            if (saved) {
                Object.assign(ROUTINES_LIBRARY, saved);
            }
        }
                let currentRoutineTask = null;

        function openAddToRoutineModal(weekKey, dateKey, taskId, event) {
            event.stopPropagation();
            
            const weekData = loadData(weekKey);
            const task = weekData[dateKey].tasks.find(t => t.id === taskId);
            currentRoutineTask = { task, weekKey, dateKey, taskId };
            
            // Reset form
            document.getElementById('routine-frequency').value = 'weekly';
            document.querySelectorAll('#days-selector input[type="checkbox"]').forEach(cb => cb.checked = false);
            toggleDaysSelector();
            
            document.getElementById('add-to-routine-modal').classList.add('active');
        }

        function toggleDaysSelector() {
            const frequency = document.getElementById('routine-frequency').value;
            const daysSelector = document.getElementById('days-selector');
            
            if (frequency === 'daily') {
                daysSelector.style.display = 'none';
            } else if (frequency === 'monthly') {
                daysSelector.style.display = 'none';
            } else {
                daysSelector.style.display = 'block';
            }
        }

        // Add event listener to frequency dropdown
        document.addEventListener('DOMContentLoaded', function() {
            const freqSelect = document.getElementById('routine-frequency');
            if (freqSelect) {
                freqSelect.addEventListener('change', toggleDaysSelector);
            }
        });

        function saveTaskToRoutine(event) {
            event.preventDefault();
            if (!currentRoutineTask) return;
            
            const frequency = document.getElementById('routine-frequency').value;
            const task = currentRoutineTask.task;
            
            // Get selected days
            let days = [];
            if (frequency === 'daily') {
                days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            } else if (frequency === 'monthly') {
                const today = new Date();
                days = [`day-${today.getDate()}`];
            } else {
                document.querySelectorAll('#days-selector input[type="checkbox"]:checked').forEach(cb => {
                    days.push(cb.value);
                });
                
                if (days.length === 0) {
                    alert('Please select at least one day!');
                    return;
                }
            }
            
            // CHECK FOR DUPLICATES - NEW!
            const recurringTasks = loadData('recurring-tasks') || [];
            const duplicate = recurringTasks.find(rt => 
                rt.text === task.text && 
                rt.frequency === frequency &&
                JSON.stringify(rt.days.sort()) === JSON.stringify(days.sort())
            );
            
            if (duplicate) {
                alert('‚ö†Ô∏è This exact recurring task already exists!');
                return;
            }
            
            // Save to recurring tasks template
            recurringTasks.push({
                id: Date.now(),
                text: task.text,
                category: task.category,
                time: task.time,
                routine: task.routine,
                frequency: frequency,
                days: days,
                startDate: formatDate(new Date())
            });
            
            saveData('recurring-tasks', recurringTasks);
            
            closeModal('add-to-routine-modal');
            alert(`‚úÖ Added "${task.text}" to your recurring tasks!`);
        }

        let currentMonthView = new Date();

        function renderMonthView() {
            const year = currentMonthView.getFullYear();
            const month = currentMonthView.getMonth();
            
            // Update title
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('month-title').textContent = `${monthNames[month]} ${year}`;
            
            // Get first and last day of month
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            // Get day of week for first day (0 = Sunday)
            const firstDayOfWeek = firstDay.getDay();
            
            // Build calendar
            let html = '<div class="calendar-grid">';
            
            // Day headers
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                html += `<div class="calendar-day-header">${day}</div>`;
            });
            
            // Previous month days
            const prevMonthLastDay = new Date(year, month, 0).getDate();
            for (let i = firstDayOfWeek - 1; i >= 0; i--) {
                const day = prevMonthLastDay - i;
                html += `<div class="calendar-day other-month"><div class="calendar-day-number">${day}</div></div>`;
            }
            
            // Current month days
            const today = new Date();
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(year, month, day);
                const dateKey = formatDate(date);
                const isToday = dateKey === formatDate(today);
                
                // Get week data for this day
                const weekStart = getWeekStart(date);
                const weekKey = getWeekKey(weekStart);
                const weekData = loadData(weekKey);
                
                let tasksInfo = '';
                let completionBadge = '';
                
                if (weekData && weekData[dateKey]) {
                    const dayData = weekData[dateKey];
                    const completed = dayData.tasks.filter(t => t.completed).length;
                    const total = dayData.tasks.length;
                    const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
                    
                    tasksInfo = `<div class="calendar-day-tasks">${completed}/${total} tasks</div>`;
                    
                    let completionClass = 'low';
                    if (percentage >= 80) completionClass = 'high';
                    else if (percentage >= 50) completionClass = 'medium';
                    
                    if (total > 0) {
                        completionBadge = `<div class="calendar-completion ${completionClass}">${percentage}%</div>`;
                    }
                }
                
                html += `
                    <div class="calendar-day ${isToday ? 'today' : ''}" onclick="openDayDetail('${dateKey}')">
                        <div class="calendar-day-number">${day}</div>
                        ${tasksInfo}
                        ${completionBadge}
                    </div>
                `;
            }
            
            // Next month days
            const remainingCells = 42 - (firstDayOfWeek + lastDay.getDate());
            for (let day = 1; day <= remainingCells; day++) {
                html += `<div class="calendar-day other-month"><div class="calendar-day-number">${day}</div></div>`;
            }
            
            html += '</div>';
            document.getElementById('month-calendar').innerHTML = html;
        }

        function previousMonth() {
            currentMonthView.setMonth(currentMonthView.getMonth() - 1);
            renderMonthView();
        }

        function nextMonth() {
            currentMonthView.setMonth(currentMonthView.getMonth() + 1);
            renderMonthView();
        }

                let currentDayDetailKey = null;
        let currentDayDetailWeekKey = null;

     function openDayDetail(dateKey) {
            const date = parseLocalDate(dateKey);
            const weekStart = getWeekStart(date);
            const weekKey = getWeekKey(weekStart);
            const weekData = loadData(weekKey);
            
            currentDayDetailKey = dateKey;
            currentDayDetailWeekKey = weekKey;
            
            // Set title
            document.getElementById('day-detail-title').textContent = formatDisplayDate(date);
            
            if (!weekData || !weekData[dateKey]) {
                // No data for this day
                document.getElementById('day-detail-notes').value = '';
                document.getElementById('day-detail-tasks').innerHTML = '<p style="color: var(--text-lighter);">No tasks for this day yet.</p>';
                document.getElementById('day-detail-completion').textContent = '0/0';
            } else {
                const dayData = weekData[dateKey];
                
                // Set notes
                document.getElementById('day-detail-notes').value = dayData.dayNotes || '';
                
                // Render tasks
                const completed = dayData.tasks.filter(t => t.completed).length;
                const total = dayData.tasks.length;
                document.getElementById('day-detail-completion').textContent = `${completed}/${total}`;
                
                if (completed === total && total > 0) {
                    document.getElementById('day-detail-completion').classList.add('complete');
                } else {
                    document.getElementById('day-detail-completion').classList.remove('complete');
                }
                
                let tasksHtml = '';
                dayData.tasks.forEach(task => {
                    tasksHtml += `
                        <div style="display: flex; align-items: center; gap: 12px; padding: 10px; background: var(--surface-hover); border-radius: 8px; margin-bottom: 8px;">
                            <div class="checkbox ${task.completed ? 'checked' : ''}" onclick="toggleTaskInModal('${weekKey}', '${dateKey}', ${task.id})"></div>
                            <div style="flex: 1;">
                                <div style="font-size: 0.95rem; color: var(--text); ${task.completed ? 'text-decoration: line-through; opacity: 0.6;' : ''}">${task.text}</div>
                                <div style="margin-top: 4px;">
                                    <span class="task-tag tag-${task.category}">${task.category}</span>
                                    ${task.time ? `<span class="task-time" style="margin-left: 8px;">‚è±Ô∏è ${task.time}</span>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                document.getElementById('day-detail-tasks').innerHTML = tasksHtml;
            }
            
            // Auto-save notes on change
            const notesTextarea = document.getElementById('day-detail-notes');
            notesTextarea.onchange = function() {
                saveDayNotes(currentDayDetailWeekKey, currentDayDetailKey, this.value);
            };
            
            document.getElementById('day-detail-modal').classList.add('active');
        }

        function toggleTaskInModal(weekKey, dateKey, taskId) {
            const weekData = loadData(weekKey);
            const task = weekData[dateKey].tasks.find(t => t.id === taskId);
            task.completed = !task.completed;
            saveData(weekKey, weekData);
            
            // Re-render modal content
            openDayDetail(dateKey);
            
            // Refresh month view to update completion %
            renderMonthView();
        }

        function goToDay() {
            if (!currentDayDetailKey) return;
            
            const date = parseLocalDate(currentDayDetailKey);
            const today = new Date();

            
            // Check if it's today
            if (formatDate(date) === formatDate(today)) {
                closeModal('day-detail-modal');
                switchView('today');
            } else {
                // Go to week view and show that week
                const weekStart = getWeekStart(date);
                const todayWeekStart = getWeekStart(today);
                
                if (formatDate(weekStart) === formatDate(todayWeekStart)) {
                    currentWeekView = 'current';
                } else if (date > today) {
                    currentWeekView = 'next';
                } else {
                    // It's a past date - just close modal for now
                    alert('This is a past date. View in Last Week tab or we can build a date picker!');
                    return;
                }
                
                closeModal('day-detail-modal');
                document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
                document.querySelectorAll('.nav-item')[1].classList.add('active'); // Week tab
                switchView('week');
            }
        }
        let draggedTask = null;

        function handleDragStart(event, weekKey, dateKey, taskId) {
            event.stopPropagation(); // Prevent expanding task
            draggedTask = { weekKey, dateKey, taskId };
            event.currentTarget.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            
            const target = event.currentTarget;
            if (target.classList.contains('task-item') && !target.classList.contains('dragging')) {
                target.classList.add('drag-over');
            }
        }

        function handleDrop(event, targetWeekKey, targetDateKey, targetTaskId) {
            event.preventDefault();
            event.stopPropagation();
            
            if (!draggedTask) return;
            
            // Remove drag-over class
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            
            // Same day reorder
            if (draggedTask.weekKey === targetWeekKey && draggedTask.dateKey === targetDateKey) {
                reorderTasksInDay(draggedTask.weekKey, draggedTask.dateKey, draggedTask.taskId, targetTaskId);
            } 
            // Move between days
            else {
                moveTaskBetweenDays(draggedTask.weekKey, draggedTask.dateKey, draggedTask.taskId, targetWeekKey, targetDateKey);
            }
        }

        function handleDragEnd(event) {
            event.currentTarget.classList.remove('dragging');
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            draggedTask = null;
        }

        function reorderTasksInDay(weekKey, dateKey, draggedTaskId, targetTaskId) {
            const weekData = loadData(weekKey);
            const tasks = weekData[dateKey].tasks;
            
            const draggedIndex = tasks.findIndex(t => t.id === draggedTaskId);
            const targetIndex = tasks.findIndex(t => t.id === targetTaskId);
            
            if (draggedIndex === -1 || targetIndex === -1) return;
            
            // Remove dragged task
            const [draggedTaskObj] = tasks.splice(draggedIndex, 1);
            
            // Insert at new position
            tasks.splice(targetIndex, 0, draggedTaskObj);
            
            saveData(weekKey, weekData);
            renderCurrentView();
        }

        function moveTaskBetweenDays(sourceWeekKey, sourceDateKey, taskId, targetWeekKey, targetDateKey) {
            // Load source week
            const sourceWeekData = loadData(sourceWeekKey);
            const taskIndex = sourceWeekData[sourceDateKey].tasks.findIndex(t => t.id === taskId);
            
            if (taskIndex === -1) return;
            
            // Get task and remove from source
            const task = sourceWeekData[sourceDateKey].tasks[taskIndex];
            sourceWeekData[sourceDateKey].tasks.splice(taskIndex, 1);
            saveData(sourceWeekKey, sourceWeekData);
            
            // Add to target
            let targetWeekData;
            if (sourceWeekKey === targetWeekKey) {
                targetWeekData = sourceWeekData;
            } else {
                targetWeekData = loadData(targetWeekKey);
            }
            
            targetWeekData[targetDateKey].tasks.push(task);
            saveData(targetWeekKey, targetWeekData);
            
            renderCurrentView();
            alert(`‚úÖ Moved "${task.text}" to ${targetDateKey}`);
        }
        // Touch support for mobile
        let touchStartY = 0;
        let touchCurrentY = 0;
        let touchedElement = null;
        let isDragging = false;
        let dragThreshold = 10; // pixels to move before starting drag

        function handleTouchStart(event) {
            // Don't start drag if clicking checkbox or buttons
            if (event.target.closest('.checkbox') || 
                event.target.closest('button') || 
                event.target.closest('textarea') ||
                event.target.closest('input')) {
                return;
            }
            
            touchedElement = event.currentTarget;
            touchStartY = event.touches[0].clientY;
            touchCurrentY = touchStartY;
            isDragging = false;
            
            // Add a slight delay to distinguish tap from drag
            setTimeout(() => {
                if (touchedElement && Math.abs(touchCurrentY - touchStartY) > dragThreshold) {
                    isDragging = true;
                    touchedElement.classList.add('dragging');
                    
                    // Get task data
                    draggedTask = {
                        weekKey: touchedElement.dataset.weekKey,
                        dateKey: touchedElement.dataset.dateKey,
                        taskId: parseInt(touchedElement.dataset.taskId)
                    };
                }
            }, 100);
        }

        function handleTouchMove(event) {
            if (!touchedElement) return;
            
            touchCurrentY = event.touches[0].clientY;
            
            // Start dragging if moved enough
            if (!isDragging && Math.abs(touchCurrentY - touchStartY) > dragThreshold) {
                isDragging = true;
                touchedElement.classList.add('dragging');
                
                draggedTask = {
                    weekKey: touchedElement.dataset.weekKey,
                    dateKey: touchedElement.dataset.dateKey,
                    taskId: parseInt(touchedElement.dataset.taskId)
                };
            }
            
            if (isDragging) {
                event.preventDefault(); // Prevent scrolling while dragging
                
                // Find element under finger
                const touch = event.touches[0];
                const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
                const taskBelow = elementBelow?.closest('.task-item');
                
                // Remove all drag-over classes
                document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
                
                // Add drag-over to element under finger
                if (taskBelow && taskBelow !== touchedElement) {
                    taskBelow.classList.add('drag-over');
                }
            }
        }

        function handleTouchEnd(event) {
            if (!touchedElement) return;
            
            // If we were dragging, handle the drop
            if (isDragging && draggedTask) {
                const touch = event.changedTouches[0];
                const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
                const taskBelow = elementBelow?.closest('.task-item');
                
                if (taskBelow && taskBelow !== touchedElement) {
                    const targetWeekKey = taskBelow.dataset.weekKey;
                    const targetDateKey = taskBelow.dataset.dateKey;
                    const targetTaskId = parseInt(taskBelow.dataset.taskId);
                    
                    // Same day reorder
                    if (draggedTask.weekKey === targetWeekKey && draggedTask.dateKey === targetDateKey) {
                        reorderTasksInDay(draggedTask.weekKey, draggedTask.dateKey, draggedTask.taskId, targetTaskId);
                    } 
                    // Move between days
                    else {
                        moveTaskBetweenDays(draggedTask.weekKey, draggedTask.dateKey, draggedTask.taskId, targetWeekKey, targetDateKey);
                    }
                }
                
                // Prevent click event from firing
                event.preventDefault();
            } else if (!isDragging) {
                // It was a tap, not a drag - let click handler work
                // Don't prevent default here
            }
            
            // Cleanup
            touchedElement?.classList.remove('dragging');
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            touchedElement = null;
            draggedTask = null;
            isDragging = false;
        }


    function switchView(view) {
            currentView = view;
            document.querySelectorAll('.view-content').forEach(v => v.classList.add('hidden'));
            document.getElementById(`${view}-view`).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            if (view === 'routines') renderRoutinesView();
            else if (view === 'metrics') renderMetricsView();
            else if (view === 'month') renderMonthView();
            else renderCurrentView();
        }



        function showWeek(week) {
            currentWeekView = week;
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');
            renderWeekView();
        }

        function renderCurrentView() {
            if (currentView === 'today') renderTodayView();
            else if (currentView === 'week') renderWeekView();
        }

        function openAddTaskModal(dateKey) {
            currentModalDay = dateKey;
            document.getElementById('task-name').value = '';
            document.getElementById('task-time').value = '';
            document.getElementById('add-task-modal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function generateNewWeek() {
            const nextWeek = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000);
            const weekStart = getWeekStart(nextWeek);
            generateWeekData(weekStart);
            alert('‚ú® Next week generated from your template!');
        }

        function exportData() {
            try {
                const allData = {};
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    allData[key] = localStorage.getItem(key);
                }
                const dataStr = JSON.stringify(allData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `life-reset-backup-${formatDate(new Date())}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                alert('‚úÖ Backup downloaded!');
            } catch (error) {
                console.error('Export error:', error);
                alert('‚ùå Error creating backup.');
            }
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!confirm('‚ö†Ô∏è This will replace all current data. Continue?')) return;
                    localStorage.clear();
                    for (const key in data) localStorage.setItem(key, data[key]);
                    alert('‚úÖ Backup restored!');
                    location.reload();
                } catch (error) {
                    console.error('Import error:', error);
                    alert('‚ùå Invalid backup file.');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function resetApp() {
            if (confirm('‚ö†Ô∏è Delete all data?')) {
                localStorage.clear();
                location.reload();
            }
        }

    function init() {
            loadRoutinesLibrary();
            renderTodayView();
        }

        init();
        setInterval(() => {
            const now = new Date();
            if (now.getHours() === 0 && now.getMinutes() === 0) init();
        }, 60000);
    </script>
</body>
</html>