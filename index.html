<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Life Reset">
    <title>‚ú® Life Reset v3</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        :root {
            /* Backgrounds */
            --bg-gradient: linear-gradient(135deg, #fdfcfb 0%, #f9f8f6 50%, #fefefe 100%);
            
            /* Powder Blue - Primary */
            --primary: #5dade2;
            --primary-light: #d6eaf8;
            --primary-lighter: #ebf5fb;
            --primary-dark: #1a5490;
            
            /* Deep Emerald Green */
            --emerald: #064e3b;
            --emerald-light: #d1fae5;
            --emerald-lighter: #ecfdf5;
            --emerald-dark: #022c22;
            
            /* Deep Royal Purple */
            --amethyst: #581c87;
            --amethyst-light: #e9d5ff;
            --amethyst-lighter: #f3e8ff;
            --amethyst-dark: #3b0764;
            
            /* Deep Wine Red */
            --ruby: #7f1d1d;
            --ruby-light: #fee2e2;
            --ruby-lighter: #fef2f2;
            --ruby-dark: #450a0a;
            
            /* Sapphire Blue */
            --sapphire: #1e3a8a;
            --sapphire-light: #dbeafe;
            --sapphire-lighter: #eff6ff;
            
            /* Gold & Topaz */
            --topaz: #92400e;
            --topaz-light: #fef3c7;
            --gold: #ca8a04;
            --gold-light: #fef9c3;
            
            /* Rose Gold */
            --rose-gold: #9f1239;
            --rose-gold-light: #ffe4e6;
            
            /* Jade */
            --jade: #14532d;
            --jade-light: #dcfce7;
            
            /* Text Colors */
            --text: #1a252f;
            --text-light: #2c3e50;
            --text-lighter: #5d6d7e;
            
            /* Semantic */
            --success: #064e3b;
            --warning: #ca8a04;
            --danger: #7f1d1d;
            
            /* Surface */
            --surface: #ffffff;
            --surface-hover: #f8f9fa;
            --border: #cbd5e0;
            
            /* Shadows */
            --shadow-sm: 0 2px 8px rgba(93, 173, 226, 0.12);
            --shadow-md: 0 4px 16px rgba(93, 173, 226, 0.16);
            --shadow-lg: 0 8px 32px rgba(93, 173, 226, 0.20);
        }
        
        body { font-family: 'DM Sans', sans-serif; background: var(--bg-gradient); color: var(--text); line-height: 1.6; overflow-x: hidden; min-height: 100vh; padding-bottom: 80px; }
        
        /* Header */
        .app-header { background: rgba(255, 255, 255, 0.95); border-bottom: 1px solid var(--border); padding: 20px; position: sticky; top: 0; z-index: 100; backdrop-filter: blur(10px); }
        .header-content { max-width: 800px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .app-title { font-family: 'Playfair Display', serif; font-size: 1.8rem; font-weight: 700; background: linear-gradient(135deg, var(--primary), var(--amethyst)); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; }
        .icon-btn { background: var(--surface); border: 1px solid var(--border); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease; font-size: 1.2rem; }
        .icon-btn:hover { background: var(--primary-light); border-color: var(--primary); transform: scale(1.05); }
        
        /* Container */
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        
        /* Today Card */
        .today-card { background: linear-gradient(135deg, var(--primary-lighter), var(--amethyst-lighter)); border-radius: 24px; padding: 30px; margin-bottom: 30px; box-shadow: var(--shadow-lg); animation: fadeInUp 0.6s ease; }
        .today-date { font-family: 'Playfair Display', serif; font-size: 2rem; font-weight: 700; color: var(--text); margin-bottom: 5px; }
        .today-subtitle { color: var(--text-light); font-size: 1rem; margin-bottom: 20px; }
        
        /* Progress Bar */
        .progress-bar-container { background: rgba(255, 255, 255, 0.7); border-radius: 12px; height: 12px; overflow: hidden; margin-bottom: 12px; }
        .progress-bar { background: linear-gradient(90deg, var(--primary), var(--emerald)); height: 100%; border-radius: 12px; transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); position: relative; }
        .progress-bar::after { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent); animation: shimmer 2s infinite; }
        @keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
        .progress-text { font-size: 0.9rem; color: var(--text-light); text-align: center; }
        
        /* View Selector */
        .view-selector { display: flex; gap: 8px; margin-bottom: 25px; background: var(--surface); padding: 6px; border-radius: 16px; box-shadow: var(--shadow-sm); }
        .view-btn { flex: 1; background: none; border: none; padding: 10px 16px; font-family: 'DM Sans', sans-serif; font-size: 0.9rem; font-weight: 500; color: var(--text-lighter); cursor: pointer; border-radius: 12px; transition: all 0.3s ease; }
        .view-btn.active { background: linear-gradient(135deg, var(--primary-light), var(--amethyst-lighter)); color: var(--primary-dark); }
        
        /* Day Section */
        .day-section { background: var(--surface); border-radius: 20px; padding: 20px; margin-bottom: 20px; box-shadow: var(--shadow-sm); animation: fadeInUp 0.4s ease; animation-fill-mode: backwards; }
        .day-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .day-title-group { display: flex; align-items: center; gap: 10px; }
        .day-title { font-family: 'Playfair Display', serif; font-size: 1.4rem; font-weight: 600; color: var(--text); }
        .day-date { font-size: 0.85rem; color: var(--text-lighter); }
        .day-stats { display: flex; align-items: center; gap: 10px; font-size: 0.85rem; }
        .completion-badge { background: var(--primary-light); color: var(--primary-dark); padding: 4px 12px; border-radius: 12px; font-weight: 500; }
        .completion-badge.complete { background: var(--emerald-light); color: var(--emerald-dark); }
        
        /* Daily Notes */
        .daily-notes { background: var(--surface-hover); border: 2px dashed var(--border); border-radius: 12px; padding: 15px; margin-bottom: 15px; }
        .daily-notes-title { font-weight: 600; color: var(--text); margin-bottom: 8px; font-size: 0.9rem; }
        .daily-notes-textarea { width: 100%; min-height: 60px; border: 1px solid var(--border); border-radius: 8px; padding: 10px; font-family: 'DM Sans', sans-serif; font-size: 0.9rem; resize: vertical; transition: all 0.3s ease; }
        .daily-notes-textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-lighter); }
        
        /* Task List */
        .task-list { display: flex; flex-direction: column; gap: 10px; }
        .task-item-wrapper { border-radius: 12px; overflow: hidden; }
        .task-item { display: flex; align-items: flex-start; gap: 12px; padding: 12px; background: var(--surface-hover); border: 1px solid var(--border); transition: all 0.3s ease; cursor: pointer; }
        .task-item:hover { background: var(--surface); box-shadow: var(--shadow-sm); }
        .task-item.completed { opacity: 0.6; }
        .task-item.completed .task-text { text-decoration: line-through; color: var(--text-lighter); }
        .task-item.expanded { border-bottom: none; border-radius: 12px 12px 0 0; }
                .task-item { 
            display: flex; 
            align-items: flex-start; 
            gap: 12px; 
            padding: 12px; 
            background: var(--surface-hover); 
            border: 1px solid var(--border); 
            transition: all 0.3s ease; 
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        
        /* Checkbox */
        .checkbox { width: 24px; height: 24px; border: 2px solid var(--primary); border-radius: 50%; flex-shrink: 0; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; margin-top: 2px; }
        .checkbox:hover { background: var(--primary-light); transform: scale(1.1); }
        .checkbox.checked { background: var(--primary); border-color: var(--primary); }
        .checkbox.checked::after { content: '‚úì'; color: white; font-size: 14px; font-weight: bold; }
        
        /* Task Content */
        .task-content { flex: 1; }
        .task-header-row { display: flex; justify-content: space-between; align-items: flex-start; }
        .task-text { font-size: 1rem; color: var(--text); margin-bottom: 6px; }
        .task-expand-icon { font-size: 0.8rem; color: var(--text-lighter); transition: transform 0.3s ease; }
        .task-item.expanded .task-expand-icon { transform: rotate(180deg); }
        
        /* Task Meta */
        .task-meta { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
        .task-tag { font-size: 0.75rem; padding: 3px 10px; border-radius: 8px; font-weight: 500; }
        .tag-habit { background: var(--sapphire-light); color: var(--sapphire); }
        .tag-cleaning { background: var(--rose-gold-light); color: var(--rose-gold); }
        .tag-skincare { background: var(--amethyst-light); color: var(--amethyst); }
        .tag-hair { background: var(--topaz-light); color: var(--topaz); }
        .tag-laundry { background: var(--jade-light); color: var(--jade); }
        .tag-special { background: var(--gold-light); color: var(--gold); }
        .tag-deepclean { background: var(--emerald-light); color: var(--emerald); }
        .tag-capture { background: var(--topaz-light); color: var(--topaz); }
        .task-time { font-size: 0.75rem; color: var(--text-lighter); }
        
        /* Task Details Dropdown */
        .task-details { background: white; border: 1px solid var(--border); border-top: none; padding: 20px; border-radius: 0 0 12px 12px; display: none; animation: slideDown 0.3s ease; }
        .task-details.active { display: block; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .task-details-section { margin-bottom: 15px; }
        .task-details-section:last-child { margin-bottom: 0; }
        .task-details-title { font-weight: 600; font-size: 0.9rem; color: var(--text); margin-bottom: 8px; }
        .task-details-content { color: var(--text-light); font-size: 0.9rem; line-height: 1.6; }
        .task-details-list { list-style: none; padding-left: 0; }
        .task-details-list li { padding: 4px 0; padding-left: 20px; position: relative; }
        .task-details-list li::before { content: '‚Ä¢'; position: absolute; left: 5px; color: var(--primary); }
        
        /* Task Notes Input */
        .task-notes-input { width: 100%; min-height: 80px; border: 2px solid var(--border); border-radius: 8px; padding: 10px; font-family: 'DM Sans', sans-serif; font-size: 0.9rem; resize: vertical; transition: all 0.3s ease; }
        .task-notes-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-lighter); }
        
        /* Task Action Buttons */
        .task-actions-row { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        .task-action-btn-small { padding: 8px 16px; border: none; border-radius: 8px; font-size: 0.85rem; font-weight: 500; cursor: pointer; transition: all 0.3s ease; color: white; }
        .btn-edit { background: var(--primary); }
        .btn-edit:hover { background: var(--primary-dark); }
        .btn-move { background: var(--amethyst); }
        .btn-move:hover { background: var(--amethyst-dark); }
        .btn-delete { background: var(--ruby); }
        .btn-delete:hover { background: var(--ruby-dark); }
        .task-action-btn-small:hover { transform: translateY(-2px); box-shadow: var(--shadow-sm); }
        
        /* Add Task Button */
        .add-task-btn { width: 100%; padding: 12px; background: var(--surface-hover); border: 2px dashed var(--border); border-radius: 12px; color: var(--text-lighter); font-size: 0.9rem; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .add-task-btn:hover { background: var(--primary-light); border-color: var(--primary); color: var(--primary-dark); }
        
        /* Bottom Navigation */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(255, 255, 255, 0.95); border-top: 1px solid var(--border); padding: 10px; display: flex; justify-content: space-around; box-shadow: 0 -4px 16px rgba(93, 173, 226, 0.08); z-index: 100; backdrop-filter: blur(10px); }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; padding: 8px; background: none; border: none; cursor: pointer; transition: all 0.3s ease; border-radius: 12px; }
        .nav-item:hover { background: var(--surface-hover); }
        .nav-item.active { background: var(--primary-light); }
        .nav-icon { font-size: 1.5rem; transition: color 0.3s ease; }
        .nav-item .nav-icon { color: var(--text-lighter); }
        .nav-item.active .nav-icon { color: var(--primary-dark); }
        .nav-label { font-size: 0.7rem; color: var(--text-lighter); }
        .nav-item.active .nav-label { color: var(--primary-dark); font-weight: 500; }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(5px); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background: var(--surface); border-radius: 24px; padding: 30px; max-width: 500px; width: 100%; max-height: 80vh; overflow-y: auto; box-shadow: var(--shadow-lg); animation: modalSlideUp 0.4s ease; }
        @keyframes modalSlideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-family: 'Playfair Display', serif; font-size: 1.6rem; font-weight: 600; }
        .modal-close { background: none; border: none; font-size: 2rem; color: var(--text-lighter); cursor: pointer; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.3s ease; }
        .modal-close:hover { background: var(--surface-hover); color: var(--text); }
        
        /* Forms */
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 0.9rem; font-weight: 500; color: var(--text); margin-bottom: 8px; }
        .form-input, .form-textarea, .form-select { width: 100%; padding: 12px 16px; border: 2px solid var(--border); border-radius: 12px; font-family: 'DM Sans', sans-serif; font-size: 1rem; color: var(--text); background: var(--surface); transition: all 0.3s ease; }
        .form-input:focus, .form-textarea:focus, .form-select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-lighter); }
        .form-textarea { min-height: 100px; resize: vertical; }
        
        /* Buttons */
        .btn { padding: 12px 24px; border: none; border-radius: 12px; font-family: 'DM Sans', sans-serif; font-size: 1rem; font-weight: 500; cursor: pointer; transition: all 0.3s ease; }
        .btn-primary { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; width: 100%; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        
        /* Settings */
        .settings-section { margin-bottom: 30px; }
        .settings-title { font-family: 'Playfair Display', serif; font-size: 1.3rem; font-weight: 600; margin-bottom: 15px; }
        .info-box { background: var(--primary-light); border-radius: 12px; padding: 15px; margin-bottom: 20px; color: var(--text); font-size: 0.9rem; line-height: 1.5; }
        
        /* Animations */
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .hidden { display: none !important; }
                /* Monthly Calendar */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .calendar-day-header {
            text-align: center;
            font-weight: 600;
            color: var(--text-light);
            padding: 10px;
            font-size: 0.85rem;
        }
        
        .calendar-day {
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 12px;
            min-height: 100px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .calendar-day:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-sm);
        }
        
        .calendar-day.today {
            border-color: var(--primary);
            background: var(--primary-lighter);
        }
        
        .calendar-day.other-month {
            opacity: 0.4;
        }
        
        .calendar-day-number {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 8px;
            color: var(--text);
        }
        
        .calendar-day-tasks {
            font-size: 0.75rem;
            color: var(--text-light);
        }
        
        .calendar-completion {
            margin-top: 8px;
            font-size: 0.7rem;
            padding: 3px 8px;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
        }
        
        .calendar-completion.high {
            background: var(--emerald-light);
            color: var(--emerald-dark);
        }
        
        .calendar-completion.medium {
            background: var(--primary-light);
            color: var(--primary-dark);
        }
        
        .calendar-completion.low {
            background: var(--ruby-light);
            color: var(--ruby-dark);
        }
                /* Drag & Drop */
        .task-item[draggable="true"] {
            cursor: move;
        }
        
        .task-item.dragging {
            opacity: 0.5;
            border: 2px dashed var(--primary);
        }
        
        .task-item.drag-over {
            border-top: 3px solid var(--primary);
        }
        /* Capture List */
        .filter-btn {
            padding: 8px 16px;
            border: 1px solid var(--border);
            background: var(--surface);
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .filter-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .capture-item {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }
        
        .capture-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .capture-item.unassigned {
            border-left: 4px solid #f59e0b;
        }
        
        .capture-item.assigned {
            border-left: 4px solid var(--primary);
        }
        
        .capture-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .capture-status.unassigned {
            background: #fef3c7;
            color: #92400e;
        }
        
        .capture-status.assigned {
            background: var(--primary-lighter);
            color: var(--primary-dark);
        }


        /* Responsive */
        @media (max-width: 768px) {
            .container { padding: 15px; }
            .today-card { padding: 20px; }
            .today-date { font-size: 1.6rem; }
            .day-title { font-size: 1.2rem; }
        }
    </style>
</head>
<body>
    <div class="app-header">
        <div class="header-content">
            <h1 class="app-title">‚ú® Life Reset</h1>
            <div class="header-actions">
                <button class="icon-btn" onclick="generateNewWeek()" title="Generate New Week">üîÑ</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div id="today-view" class="view-content">
            <div class="today-card">
                <div class="today-date" id="today-date">Loading...</div>
                <div class="today-subtitle" id="today-subtitle">Your tasks for today</div>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="today-progress" style="width: 0%"></div>
                </div>
                <div class="progress-text" id="progress-text">0 of 0 tasks complete</div>
            </div>
            <div id="today-tasks"></div>
        </div>

        <div id="week-view" class="view-content hidden">
            <div class="view-selector">
                <button class="view-btn active" onclick="showWeek('current')">This Week</button>
                <button class="view-btn" onclick="showWeek('next')">Next Week</button>
            </div>
            <div id="week-content"></div>
        </div>

        <div id="routines-view" class="view-content hidden">
            <h2 style="font-family: 'Playfair Display', serif; font-size: 1.8rem; margin-bottom: 20px;">üìñ Routines Library</h2>
            <div id="routines-content"></div>
        </div>

        <div id="settings-view" class="view-content hidden">
            <div class="settings-section">
                <h2 class="settings-title">About Your App</h2>
                <div class="info-box">
                    <strong>How it works:</strong><br>
                    ‚Ä¢ Your weekly routine auto-generates new weeks<br>
                    ‚Ä¢ Check off tasks as you complete them<br>
                    ‚Ä¢ Click tasks to see details & add notes<br>
                    ‚Ä¢ Your progress saves automatically
                </div>
            </div>

            <div class="settings-section">
                <h2 class="settings-title">Backup & Restore</h2>
                <div class="info-box" style="background: var(--amethyst-light);">
                    <strong>üíæ Protect your data!</strong><br>
                    Export: Download a backup file<br>
                    Import: Restore from a backup file
                </div>
                <button class="btn btn-primary" onclick="exportData()" style="margin-bottom: 10px;">üíæ Export Backup</button>
                <button class="btn btn-primary" onclick="document.getElementById('import-file').click()" style="margin-bottom: 10px; background: linear-gradient(135deg, var(--emerald), var(--jade));">üìÇ Import Backup</button>
                <input type="file" id="import-file" accept=".json" onchange="importData(event)" style="display: none;">
            </div>

            <div class="settings-section">
                <h2 class="settings-title">Quick Actions</h2>
                <button class="btn btn-primary" onclick="generateNewWeek()" style="margin-bottom: 10px;">üîÑ Generate New Week</button>
                <button class="btn btn-primary" onclick="resetApp()" style="background: linear-gradient(135deg, var(--ruby), var(--ruby-dark));">‚ö†Ô∏è Reset All Data</button>
            </div>
                        <div class="settings-section">
                <h2 class="settings-title">Recurring Tasks</h2>
                <div class="info-box">
                    <strong>üîÑ Manage your recurring tasks</strong><br>
                    These tasks auto-add to future weeks
                </div>
                <button class="btn btn-primary" onclick="showRecurringTasksModal()" style="margin-bottom: 10px; background: linear-gradient(135deg, var(--amethyst), var(--amethyst-dark));">View & Manage Recurring Tasks</button>
            </div>
        </div>
    </div>
            <div id="month-view" class="view-content hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <button class="icon-btn" onclick="previousMonth()">‚óÄ</button>
                <h2 id="month-title" style="font-family: 'Playfair Display', serif; font-size: 1.8rem;">February 2026</h2>
                <button class="icon-btn" onclick="nextMonth()">‚ñ∂</button>
            </div>
            <div id="month-calendar"></div>
        </div>

        
        <div id="metrics-view" class="view-content hidden">
            <h2 style="font-family: 'Playfair Display', serif; font-size: 1.8rem; margin-bottom: 30px;">üìä Your Metrics</h2>
            
            <div class="day-section" style="background: linear-gradient(135deg, var(--emerald-lighter), var(--primary-lighter)); padding: 25px;">
                <h3 style="font-family: 'Playfair Display', serif; font-size: 1.4rem; margin-bottom: 15px;">üî• Current Streak</h3>
                <div style="font-size: 3rem; font-weight: 700; color: var(--emerald); text-align: center;" id="streak-count">0</div>
                <div style="text-align: center; color: var(--text-light); margin-top: 10px;">days in a row</div>
            </div>

            <div class="day-section">
                <h3 style="font-family: 'Playfair Display', serif; font-size: 1.3rem; margin-bottom: 15px;">üìà This Week</h3>
                <div id="week-stats"></div>
            </div>

            <div class="day-section">
                <h3 style="font-family: 'Playfair Display', serif; font-size: 1.3rem; margin-bottom: 15px;">üèÜ All Time</h3>
                <div id="alltime-stats"></div>
            </div>
        </div>
    <div class="bottom-nav">
        <button class="nav-item active" onclick="switchView('today')">
            <div class="nav-icon">üìÖ</div>
            <div class="nav-label">Today</div>
        </button>
        <button class="nav-item" onclick="switchView('week')">
            <div class="nav-icon">üìÜ</div>
            <div class="nav-label">Week</div>
        </button>
        <button class="nav-item" onclick="switchView('month')">
            <div class="nav-icon">üóìÔ∏è</div>
            <div class="nav-label">Month</div>
        </button>
        <button class="nav-item" onclick="switchView('metrics')">
            <div class="nav-icon">üìä</div>
            <div class="nav-label">Metrics</div>
        </button>
        <button class="nav-item" onclick="switchView('routines')">
            <div class="nav-icon">üìñ</div>
            <div class="nav-label">Routines</div>
        </button>
        <button class="nav-item" onclick="switchView('settings')">
            <div class="nav-icon">‚öôÔ∏è</div>
            <div class="nav-label">Settings</div>
        </button>
        <button class="nav-item" onclick="switchView('capture')">
            <div class="nav-icon">üìù</div>
            <div class="nav-label">Capture</div>
        </button>
    </div>
    

    <div id="add-task-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Task</h2>
                <button class="modal-close" onclick="closeModal('add-task-modal')">√ó</button>
            </div>
            <form onsubmit="addCustomTask(event)">
                <div class="form-group">
                    <label class="form-label">Task Name</label>
                    <input type="text" class="form-input" id="task-name" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-select" id="task-category">
                        <option value="habit">Daily Habit</option>
                        <option value="cleaning">Cleaning</option>
                        <option value="skincare">Skincare</option>
                        <option value="hair">Hair Care</option>
                        <option value="laundry">Laundry</option>
                        <option value="special">Special</option>
                        <option value="deepclean">Deep Clean</option>
                    </select>
                </div>
            <div class="form-group">
                    <label class="form-label">Time Estimate (optional)</label>
                    <input type="text" class="form-input" id="task-time" placeholder="e.g., 5 min, 1 hour 30 min">
                </div>

                <button type="submit" class="btn btn-primary">Add Task</button>
            </form>
        </div>
    </div>

    <div id="edit-task-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Edit Task</h2>
                <button class="modal-close" onclick="closeModal('edit-task-modal')">√ó</button>
            </div>
            <form onsubmit="saveTaskEdit(event)">
                <div class="form-group">
                    <label class="form-label">Task Name</label>
                    <input type="text" class="form-input" id="edit-task-name" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-select" id="edit-task-category">
                        <option value="habit">Daily Habit</option>
                        <option value="cleaning">Cleaning</option>
                        <option value="skincare">Skincare</option>
                        <option value="hair">Hair Care</option>
                        <option value="laundry">Laundry</option>
                        <option value="special">Special</option>
                        <option value="deepclean">Deep Clean</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Time Estimate (optional)</label>
                    <input type="text" class="form-input" id="edit-task-time" placeholder="e.g., 5 min, 1 hour 30 min">
                </div>
                <button type="submit" class="btn btn-primary">Save Changes</button>
            </form>
        </div>
    </div>

    <div id="move-task-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Move Task</h2>
                <button class="modal-close" onclick="closeModal('move-task-modal')">√ó</button>
            </div>
            <div class="form-group">
                <label class="form-label">Move to which day?</label>
                <select class="form-select" id="move-task-day">
                    <option value="">Select a day...</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="confirmMoveTask()">Move Task</button>
        </div>
    </div>
    <div id="edit-routine-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Edit Routine</h2>
                <button class="modal-close" onclick="closeModal('edit-routine-modal')">√ó</button>
            </div>
            <form onsubmit="saveRoutineEdit(event)">
                <div class="form-group">
                    <label class="form-label">Routine Name</label>
                    <input type="text" class="form-input" id="edit-routine-name" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Time Estimate</label>
                    <input type="text" class="form-input" id="edit-routine-time" placeholder="e.g., 5 min" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-select" id="edit-routine-category">
                        <option value="habit">Daily Habit</option>
                        <option value="cleaning">Cleaning</option>
                        <option value="skincare">Skincare</option>
                        <option value="hair">Hair Care</option>
                        <option value="laundry">Laundry</option>
                        <option value="special">Special</option>
                        <option value="deepclean">Deep Clean</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Steps (one per line)</label>
                    <textarea class="form-textarea" id="edit-routine-steps" rows="6" required></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Save Changes</button>
            </form>
        </div>
    </div>

    <div id="create-routine-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Create New Routine</h2>
                <button class="modal-close" onclick="closeModal('create-routine-modal')">√ó</button>
            </div>
            <form onsubmit="saveNewRoutine(event)">
                <div class="form-group">
                    <label class="form-label">Routine Name</label>
                    <input type="text" class="form-input" id="new-routine-name" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Time Estimate</label>
                    <input type="text" class="form-input" id="new-routine-time" placeholder="e.g., 5 min" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-select" id="new-routine-category">
                        <option value="habit">Daily Habit</option>
                        <option value="cleaning">Cleaning</option>
                        <option value="skincare">Skincare</option>
                        <option value="hair">Hair Care</option>
                        <option value="laundry">Laundry</option>
                        <option value="special">Special</option>
                        <option value="deepclean">Deep Clean</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Steps (one per line)</label>
                    <textarea class="form-textarea" id="new-routine-steps" rows="6" placeholder="Step 1&#10;Step 2&#10;Step 3" required></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Create Routine</button>
            </form>
        </div>
    </div>

    <div id="add-routine-schedule-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add to Schedule</h2>
                <button class="modal-close" onclick="closeModal('add-routine-schedule-modal')">√ó</button>
            </div>
            <div class="form-group">
                <label class="form-label">Add to which day?</label>
                <select class="form-select" id="routine-schedule-day">
                    <option value="today">Today</option>
                    <option value="tomorrow">Tomorrow</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="confirmAddRoutineToSchedule()">Add to Schedule</button>
        </div>
    </div>
    <div id="add-to-routine-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add to Weekly Routine</h2>
                <button class="modal-close" onclick="closeModal('add-to-routine-modal')">√ó</button>
            </div>
            <form onsubmit="saveTaskToRoutine(event)">
                <div class="form-group">
                    <label class="form-label">Repeat Frequency</label>
                    <select class="form-select" id="routine-frequency">
                        <option value="daily">Daily (every day)</option>
                        <option value="weekly">Weekly (specific days)</option>
                        <option value="biweekly">Bi-weekly (every 2 weeks)</option>
                        <option value="monthly">Monthly (specific date)</option>
                    </select>
                </div>
                <div class="form-group" id="days-selector">
                    <label class="form-label">Repeat on these days:</label>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="day-monday" value="monday">
                            <span>Monday</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="day-tuesday" value="tuesday">
                            <span>Tuesday</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="day-wednesday" value="wednesday">
                            <span>Wednesday</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="day-thursday" value="thursday">
                            <span>Thursday</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="day-friday" value="friday">
                            <span>Friday</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="day-saturday" value="saturday">
                            <span>Saturday</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="day-sunday" value="sunday">
                            <span>Sunday</span>
                        </label>
                    </div>
                </div>
                <div class="info-box" style="background: var(--amethyst-light);">
                    <strong>üìÖ Note:</strong> This will add the task to your weekly template starting from next week. It won't affect previous weeks.
                </div>
                <button type="submit" class="btn btn-primary">Add to Routine</button>
            </form>
        </div>
    </div>
    <div id="delete-recurring-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Delete Recurring Task</h2>
                <button class="modal-close" onclick="closeModal('delete-recurring-modal')">√ó</button>
            </div>
            <p style="margin-bottom: 20px; color: var(--text-light);">This is a recurring task. What would you like to do?</p>
            <button class="btn btn-primary" onclick="deleteRecurringInstance()" style="margin-bottom: 10px; background: linear-gradient(135deg, var(--primary), var(--primary-dark));">Delete Only This Instance</button>
            <button class="btn btn-primary" onclick="deleteRecurringAll()" style="background: linear-gradient(135deg, var(--ruby), var(--ruby-dark));">Delete All Future Instances</button>
        </div>
    </div>
    
    <div id="recurring-tasks-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Recurring Tasks</h2>
                <button class="modal-close" onclick="closeModal('recurring-tasks-modal')">√ó</button>
            </div>
            <div id="recurring-tasks-list"></div>
        </div>
    </div>
    
     <div id="capture-view" class="view-content hidden">
            <h2 style="font-family: 'Playfair Display', serif; font-size: 1.8rem; margin-bottom: 20px;">üìù Capture List</h2>
            
            <button class="btn btn-primary" onclick="openAddCaptureItemModal()" style="width: 100%; margin-bottom: 20px; background: linear-gradient(135deg, var(--primary), var(--primary-dark));">+ Add Item</button>
            
            <div style="margin-bottom: 20px;">
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="filter-btn active" onclick="filterCaptureList('all')">All</button>
                    <button class="filter-btn" onclick="filterCaptureList('unassigned')">Unassigned</button>
                    <button class="filter-btn" onclick="filterCaptureList('assigned')">Assigned</button>
                    <button class="filter-btn" onclick="filterCaptureList('completed')">Completed</button>
                </div>

            </div>
            
            <div id="capture-list-content">
                <p style="color: var(--text-lighter); text-align: center; padding: 40px 20px;">
                    No capture items yet! Click "+ Add Item" to get started.
                </p>
            </div>
        </div>
<div id="test-view" class="view-content hidden">
        <h2 style="font-family: 'Playfair Display', serif; font-size: 1.8rem; margin-bottom: 20px;">üß™ Test Suite</h2>
        
        <div style="background: var(--amethyst-lighter); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
            <h3 style="margin-bottom: 10px;">Automated Testing</h3>
            <p style="color: var(--text-light); margin-bottom: 15px;">This will run all tests automatically and show you the results. Tests run on a copy of your data.</p>
            <button class="btn btn-primary" onclick="runAllTests()" style="width: 100%; background: linear-gradient(135deg, var(--emerald), var(--jade));">‚ñ∂ Run All Tests</button>
        </div>
        
        <div id="test-results" style="display: none;">
            <div style="background: var(--surface); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px;">Test Results</h3>
                <div id="test-summary" style="font-size: 1.2rem; font-weight: 600; margin-bottom: 15px;"></div>
                <div id="test-details" style="font-family: monospace; font-size: 0.9rem; line-height: 1.8;"></div>
            </div>
            <button class="btn btn-primary" onclick="clearTestData()" style="background: linear-gradient(135deg, var(--ruby), var(--ruby-dark));">üóëÔ∏è Clear Test Data</button>
        </div>
    </div>
      <div id="add-capture-item-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Add Capture Item</h2>
                    <button class="modal-close" onclick="closeModal('add-capture-item-modal')">√ó</button>
                </div>
                
                <input type="text" id="capture-item-text" placeholder="What did you discover?" style="width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem;">
                
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Category</label>
                <select id="capture-item-category" style="width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem;">
                    <option value="deep-clean">Deep Clean</option>
                    <option value="maintenance">Maintenance</option>
                    <option value="projects">Projects</option>
                    <option value="shopping">Shopping</option>
                    <option value="organizing">Organizing</option>
                    <option value="other">Other</option>
                </select>
                
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Priority (optional)</label>
                <select id="capture-item-priority" style="width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem;">
                    <option value="">None</option>
                    <option value="low">Low</option>
                    <option value="medium">Medium</option>
                    <option value="high">High</option>
                </select>
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Time Estimate (optional)</label>
                <input type="text" id="capture-item-time" placeholder="e.g., 30 min, 1 hour" style="width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem;">
                

                <textarea id="capture-item-notes" placeholder="Notes (optional)" style="width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem; min-height: 80px;"></textarea>
                
                <button class="btn btn-primary" onclick="saveCaptureItem()" style="width: 100%; background: linear-gradient(135deg, var(--primary), var(--primary-dark));">Add to Capture List</button>
            </div>
        </div>
        
            <div id="edit-capture-item-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Edit Item</h2>
                <button class="modal-close" onclick="closeModal('edit-capture-item-modal')">√ó</button>
            </div>
            
            <input type="text" id="edit-capture-item-text" placeholder="What did you discover?" style="width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem;">
            
            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Category</label>
            <select id="edit-capture-item-category" style="width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem;">
                <option value="deep-clean">Deep Clean</option>
                <option value="maintenance">Maintenance</option>
                <option value="projects">Projects</option>
                <option value="shopping">Shopping</option>
                <option value="organizing">Organizing</option>
                <option value="other">Other</option>
            </select>
            
            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Time Estimate (optional)</label>
            <input type="text" id="edit-capture-item-time" placeholder="e.g., 30 min, 1 hour" style="width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem;">
            
            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Priority (optional)</label>
            <select id="edit-capture-item-priority" style="width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem;">
                <option value="">None</option>
                <option value="low">Low</option>
                <option value="medium">Medium</option>
                <option value="high">High</option>
            </select>
            
            <textarea id="edit-capture-item-notes" placeholder="Notes (optional)" style="width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem; min-height: 80px;"></textarea>
            
            <button class="btn btn-primary" onclick="saveEditedCaptureItem()" style="width: 100%; background: linear-gradient(135deg, var(--primary), var(--primary-dark));">Save Changes</button>
        </div>
    </div>

        
    <div id="assign-capture-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Assign to Day</h2>
                <button class="modal-close" onclick="closeModal('assign-capture-modal')">√ó</button>
            </div>
            
            <div class="form-group">
                <label class="form-label">Or Pick Specific Date</label>
                <input type="date" class="form-input" id="assign-date" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">Time (optional)</label>
                <input type="text" class="form-input" id="assign-time" placeholder="e.g., 10:00 AM, Morning, Evening">
            </div>
            
            <div id="recurring-options" style="display: none; margin-top: 15px; padding: 15px; background: var(--surface-hover); border-radius: 12px;">
                <div class="form-group">
                    <label class="form-label">Repeat Frequency</label>
                    <select class="form-select" id="assign-frequency">
                        <option value="daily">Daily (every day)</option>
                        <option value="weekly">Weekly (specific days)</option>
                        <option value="biweekly">Bi-weekly (every 2 weeks)</option>
                        <option value="monthly">Monthly (specific date)</option>
                    </select>
                </div>
                
                <div class="form-group" id="assign-days-selector">
                    <label class="form-label">Repeat on these days:</label>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="assign-day-monday" value="monday">
                            <span>Monday</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="assign-day-tuesday" value="tuesday">
                            <span>Tuesday</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="assign-day-wednesday" value="wednesday">
                            <span>Wednesday</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="assign-day-thursday" value="thursday">
                            <span>Thursday</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="assign-day-friday" value="friday">
                            <span>Friday</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="assign-day-saturday" value="saturday">
                            <span>Saturday</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="assign-day-sunday" value="sunday">
                            <span>Sunday</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="info-box" style="background: var(--primary-light); margin-top: 20px; margin-bottom: 20px;">
                <strong>üìÖ Note:</strong> This will add the task to your schedule and mark it as assigned in your capture list.
            </div>
            
            <button class="btn btn-primary" onclick="confirmAssignCaptureItem()">Assign to Day</button>
        </div>
    </div>

            
    <div id="day-detail-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="day-detail-title">Loading...</h2>
                <button class="modal-close" onclick="closeModal('day-detail-modal')">√ó</button>
            </div>
            
            <div class="daily-notes" style="margin-bottom: 20px;">
                <div class="daily-notes-title">üìî Notes for this day</div>
                <textarea class="daily-notes-textarea" id="day-detail-notes" placeholder="Add notes..."></textarea>
            </div>
            
            <div style="margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h3 style="font-size: 1.1rem; font-weight: 600;">Tasks</h3>
                    <span id="day-detail-completion" class="completion-badge">0/0</span>
                </div>
                <div id="day-detail-tasks"></div>
            </div>
            
            <button class="btn btn-primary" onclick="goToDay()" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark));">
                Go to This Day ‚Üí
            </button>
        </div>
    </div>




    <script>
        const ROUTINES_LIBRARY = {
            'make-bed': { name: 'Make Your Bed', time: '2 min', category: 'habit', steps: ['Pull covers up smooth', 'Fluff pillows', 'Takes 90 seconds', 'Sets the tone for your day'] },
            'dishes': { name: 'Dishes Protocol', time: '5 min', category: 'habit', steps: ['After every meal/snack', 'Immediately to sink OR dishwasher', 'No exceptions, no "later"', 'Wipe down counter/table', 'Future you will thank you!'] },
            'bathroom-wipe': { name: 'Bathroom Sink Wipe', time: '30 sec', category: 'habit', steps: ['Rinse electric toothbrush thoroughly', 'Wipe toothbrush handle with hand towel', 'Use same damp towel to swipe the sink', 'Takes 30 seconds max', 'Prevents gross buildup'] },
            'evening-tidy': { name: '10-Minute Evening Tidy', time: '10 min', category: 'habit', steps: ['Walk through apartment with "doesn\'t belong here" eyes', 'Return items to their homes', 'Clear kitchen counters', 'Quick dish check (catch any strays)', 'Lay out tomorrow\'s outfit', 'Check that bathroom is tidy', 'Sets you up for peaceful morning'] },
            'retinol': { name: 'Retinol Night Routine', time: '20 min', category: 'skincare', steps: ['Remove ALL makeup thoroughly (oil cleanser/micellar water)', 'Cleanse with regular face wash', 'Pat dry gently', 'WAIT 5-10 minutes (skin must be completely dry!)', 'Apply retinol (pea-sized amount)', 'Avoid eye area', 'WAIT another 10-15 minutes', 'Moisturizer + eye cream', 'NO vitamin C this night', 'NO other actives'] },
            'vitamin-c': { name: 'Vitamin C Night', time: '15 min', category: 'skincare', steps: ['Remove makeup thoroughly', 'Cleanse', 'Toner', 'Vitamin C serum (wait a few minutes)', 'Other serums if you have them', 'Moisturizer + eye cream', 'Not on retinol nights!'] },
            'hydrating-mask': { name: 'Hydrating Face Mask', time: '20 min', category: 'skincare', steps: ['Do this before your evening routine', 'Cleanse face first', 'Apply hydrating mask', 'Leave on 10-20 min', 'Relax! Read, watch something, vibe', 'Remove/rinse', 'Continue with evening routine + Vitamin C'] },
            'hair-wash': { name: 'Hair Wash Day', time: '30-40 min', category: 'hair', steps: ['Rinse body', 'Shampoo hair (focus scalp not ends)', 'Condition (mid-lengths to ends, avoid roots)', 'Let sit while washing body', 'Rinse thoroughly', 'Pat hair with towel (don\'t rub)', 'Moisturize body', 'Proceed to styling'] },
            'kitchen-clean': { name: 'Kitchen Deep Clean', time: '30-45 min', category: 'cleaning', steps: ['Wipe all counters and backsplash', 'Clean stovetop thoroughly', 'Microwave inside and out', 'Scrub sink, shine faucet', 'Sweep and mop floors', 'Move and shake rugs', 'Take out trash'] },
            'vacuum-floors': { name: 'Vacuum & Floors', time: '30 min', category: 'cleaning', steps: ['Vacuum all carpets', 'Shake rugs outside (not the shag rug)', 'Swiffer/sweep hard floors', 'Spot clean any stains', 'Return rugs to place'] },
            'bathroom-quick': { name: 'Bathroom Quick-Clean', time: '15 min', category: 'cleaning', steps: ['Wipe down toilet seat and rim', 'Wipe sink and faucet', 'Clean mirror', 'Sweep floor', 'Check supplies (TP, soap)', 'Hang fresh hand towel'] },
            'pillowcases': { name: 'Pillowcases Laundry', time: '5 min', category: 'laundry', steps: ['Strip pillowcases from bed', 'Add to normal laundry load', 'Wash with your regular clothes', 'Put fresh pillowcases on when dry', 'Every week keeps skin happy!'] }
        };

        const DEFAULT_TEMPLATE = {
            monday: [
                { text: 'Make bed', category: 'habit', routine: 'make-bed' },
                { text: 'Dishes protocol', category: 'habit', routine: 'dishes' },
                { text: 'Bathroom wipe', category: 'habit', routine: 'bathroom-wipe' },
                { text: '10-min evening tidy', category: 'habit', routine: 'evening-tidy' },
                { text: 'Retinol night', category: 'skincare', routine: 'retinol' }
            ],
            tuesday: [
                { text: 'Make bed', category: 'habit', routine: 'make-bed' },
                { text: 'Dishes protocol', category: 'habit', routine: 'dishes' },
                { text: 'Bathroom wipe', category: 'habit', routine: 'bathroom-wipe' },
                { text: '10-min evening tidy', category: 'habit', routine: 'evening-tidy' }
            ],
            wednesday: [
                { text: 'Make bed', category: 'habit', routine: 'make-bed' },
                { text: 'Dishes protocol', category: 'habit', routine: 'dishes' },
                { text: 'Bathroom wipe', category: 'habit', routine: 'bathroom-wipe' },
                { text: '10-min evening tidy', category: 'habit', routine: 'evening-tidy' },
                { text: 'Vitamin C night', category: 'skincare', routine: 'vitamin-c' }
            ],
            thursday: [
                { text: 'Make bed', category: 'habit', routine: 'make-bed' },
                { text: 'Dishes protocol', category: 'habit', routine: 'dishes' },
                { text: 'Bathroom wipe', category: 'habit', routine: 'bathroom-wipe' },
                { text: '10-min evening tidy', category: 'habit', routine: 'evening-tidy' },
                { text: 'Hair wash day', category: 'hair', routine: 'hair-wash' }
            ],
            friday: [
                { text: 'Make bed', category: 'habit', routine: 'make-bed' },
                { text: 'Dishes protocol', category: 'habit', routine: 'dishes' },
                { text: 'Bathroom wipe', category: 'habit', routine: 'bathroom-wipe' },
                { text: '10-min evening tidy', category: 'habit', routine: 'evening-tidy' },
                { text: 'Hydrating face mask', category: 'skincare', routine: 'hydrating-mask' },
                { text: 'Vitamin C night', category: 'skincare', routine: 'vitamin-c' },
                { text: 'Quick vacuum', category: 'cleaning' }
            ],
            saturday: [
                { text: 'Make bed', category: 'habit', routine: 'make-bed' },
                { text: 'Dishes protocol', category: 'habit', routine: 'dishes' },
                { text: 'Bathroom wipe', category: 'habit', routine: 'bathroom-wipe' },
                { text: '10-min evening tidy', category: 'habit', routine: 'evening-tidy' }
            ],
            sunday: [
                { text: 'Make bed', category: 'habit', routine: 'make-bed' },
                { text: 'Kitchen deep clean', category: 'cleaning', time: '10:00', routine: 'kitchen-clean' },
                { text: 'Vacuum & floors', category: 'cleaning', routine: 'vacuum-floors' },
                { text: 'Bathroom quick-clean', category: 'cleaning', routine: 'bathroom-quick' },
                { text: 'Vitamin C night', category: 'skincare', routine: 'vitamin-c' },
                { text: 'Pillowcases laundry', category: 'laundry', routine: 'pillowcases' }
            ]
        };

        let currentView = 'today';
        let currentWeekView = 'current';
        let currentModalDay = null;
        let currentEditTask = null;
        let currentMoveTask = null;
        let expandedTasks = new Set();

        function saveData(key, value) {
            try { localStorage.setItem(key, JSON.stringify(value)); } 
            catch (error) { console.error('Save error:', error); }
        }

        function loadData(key) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : null;
            } catch (error) {
                console.error('Load error:', error);
                return null;
            }
        }

        function getWeekStart(date = new Date()) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }
        
        function parseLocalDate(dateKey) {
            const [year, month, day] = dateKey.split('-').map(Number);
            return new Date(year, month - 1, day);
        }


        function formatDate(date) { return date.toISOString().split('T')[0]; }
        function getWeekKey(weekStart) { return `week-${formatDate(weekStart)}`; }
        function getDayName(dayIndex) { return ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'][dayIndex]; }
        function formatDisplayDate(date) { const options = { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' }; return date.toLocaleDateString('en-US', options); }
        function formatShortDate(date) { const options = { month: 'short', day: 'numeric' }; return date.toLocaleDateString('en-US', options); }

                function generateWeekData(weekStart) {
            const weekKey = getWeekKey(weekStart);
            const existing = loadData(weekKey);
            if (existing) return existing;

            const weekData = {};
            const recurringTasks = loadData('recurring-tasks') || [];
            
            for (let i = 0; i < 7; i++) {
                const dayDate = new Date(weekStart);
                dayDate.setDate(weekStart.getDate() + i);
                const dayName = getDayName(i);
                const dateKey = formatDate(dayDate);
                
                // Start with template tasks
                const dayTasks = DEFAULT_TEMPLATE[dayName].map(task => ({
                    ...task,
                    id: Date.now() + Math.random(),
                    completed: false,
                    notes: ''
                }));
                
                // Add recurring tasks that apply to this day
                recurringTasks.forEach(recTask => {
                    const taskStartDate = new Date(recTask.startDate);
                    const currentDate = new Date(dateKey);
                    
                    // Only add if this week is on or after the task's start date
                    if (currentDate >= taskStartDate) {
                        let shouldAdd = false;
                        
                        if (recTask.frequency === 'daily') {
                            shouldAdd = true;
                        } else if (recTask.frequency === 'weekly') {
                            shouldAdd = recTask.days.includes(dayName);
                        } else if (recTask.frequency === 'biweekly') {
                            const weeksDiff = Math.floor((currentDate - taskStartDate) / (7 * 24 * 60 * 60 * 1000));
                            shouldAdd = (weeksDiff % 2 === 0) && recTask.days.includes(dayName);
                        } else if (recTask.frequency === 'monthly') {
                            const dayOfMonth = currentDate.getDate();
                            shouldAdd = recTask.days.includes(`day-${dayOfMonth}`);
                        }
                        
                        if (shouldAdd) {
                            dayTasks.push({
                                text: recTask.text,
                                category: recTask.category,
                                time: recTask.time,
                                routine: recTask.routine,
                                id: Date.now() + Math.random(),
                                completed: false,
                                notes: '',
                                recurringId: recTask.id
                            });
                        }
                    }
                });
                
                weekData[dateKey] = {
                    dayName,
                    tasks: dayTasks,
                    dayNotes: ''
                };
            }

            saveData(weekKey, weekData);
            return weekData;
        }


                function toggleTask(weekKey, dateKey, taskId, event) {
            if (event) event.stopPropagation();
            const weekData = loadData(weekKey);
            const task = weekData[dateKey].tasks.find(t => t.id === taskId);
            task.completed = !task.completed;
            saveData(weekKey, weekData);
            
            // If this task is from capture list, update capture item status
            if (task.fromCapture && task.completed) {
                const captureList = JSON.parse(localStorage.getItem('capture-list') || '[]');
                const captureItem = captureList.find(item => 
                    item.text === task.text && item.status === 'assigned'
                );
                
                if (captureItem) {
                    captureItem.status = 'completed';
                    captureItem.completedAt = new Date().toISOString();
                    localStorage.setItem('capture-list', JSON.stringify(captureList));
                }
            }
            
            renderCurrentView();
        }


        function toggleTaskDetails(weekKey, dateKey, taskId) {
            // Don't toggle if we just finished dragging
            if (isDragging) {
                return;
            }
            
            const taskKey = `${weekKey}-${dateKey}-${taskId}`;
            if (expandedTasks.has(taskKey)) {
                expandedTasks.delete(taskKey);
            } else {
                expandedTasks.add(taskKey);
            }
            renderCurrentView();
        }


        function saveTaskNotes(weekKey, dateKey, taskId, notes) {
            const weekData = loadData(weekKey);
            const task = weekData[dateKey].tasks.find(t => t.id === taskId);
            task.notes = notes;
            saveData(weekKey, weekData);
        }

        function saveDayNotes(weekKey, dateKey, notes) {
            const weekData = loadData(weekKey);
            weekData[dateKey].dayNotes = notes;
            saveData(weekKey, weekData);
        }

        function openEditTaskModal(weekKey, dateKey, taskId, event) {
            event.stopPropagation();
            const weekData = loadData(weekKey);
            const task = weekData[dateKey].tasks.find(t => t.id === taskId);
            
            currentEditTask = { weekKey, dateKey, taskId };
            document.getElementById('edit-task-name').value = task.text;
            document.getElementById('edit-task-category').value = task.category;
            document.getElementById('edit-task-time').value = task.time || '';
            document.getElementById('edit-task-modal').classList.add('active');
        }

        function saveTaskEdit(event) {
            event.preventDefault();
            if (!currentEditTask) return;

            const { weekKey, dateKey, taskId } = currentEditTask;
            const weekData = loadData(weekKey);
            const task = weekData[dateKey].tasks.find(t => t.id === taskId);
            
            task.text = document.getElementById('edit-task-name').value;
            task.category = document.getElementById('edit-task-category').value;
            task.time = document.getElementById('edit-task-time').value || undefined;
            
            saveData(weekKey, weekData);
            closeModal('edit-task-modal');
            renderCurrentView();
        }

        function openMoveTaskModal(weekKey, dateKey, taskId, event) {
            event.stopPropagation();
            currentMoveTask = { weekKey, dateKey, taskId };
            
            const weekStart = currentWeekView === 'current' ? getWeekStart() : getWeekStart(new Date(Date.now() + 7 * 24 * 60 * 60 * 1000));
            const select = document.getElementById('move-task-day');
            select.innerHTML = '<option value="">Select a day...</option>';
            
            for (let i = 0; i < 7; i++) {
                const dayDate = new Date(weekStart);
                dayDate.setDate(weekStart.getDate() + i);
                const key = formatDate(dayDate);
                if (key !== dateKey) {
                    const dayName = getDayName(i);
                    select.innerHTML += `<option value="${key}">${dayName.charAt(0).toUpperCase() + dayName.slice(1)} - ${formatShortDate(dayDate)}</option>`;
                }
            }
            
            document.getElementById('move-task-modal').classList.add('active');
        }

        function confirmMoveTask() {
            if (!currentMoveTask) return;
            const targetDay = document.getElementById('move-task-day').value;
            if (!targetDay) return;

            const { weekKey, dateKey, taskId } = currentMoveTask;
            const weekData = loadData(weekKey);
            
            const taskIndex = weekData[dateKey].tasks.findIndex(t => t.id === taskId);
            const task = weekData[dateKey].tasks[taskIndex];
            weekData[dateKey].tasks.splice(taskIndex, 1);
            weekData[targetDay].tasks.push(task);
            
            saveData(weekKey, weekData);
            closeModal('move-task-modal');
            renderCurrentView();
        }

            function deleteTask(weekKey, dateKey, taskId, event) {
            event.stopPropagation();
            
            const weekData = loadData(weekKey);
            const task = weekData[dateKey].tasks.find(t => t.id === taskId);
            
            // Check if this is a recurring task
            if (task.recurringId) {
                // Store in global variable for modal to access
                window.currentDeleteTask = { weekKey, dateKey, taskId, recurringId: task.recurringId };
                document.getElementById('delete-recurring-modal').classList.add('active');
            } else {
                if (!confirm('Delete this task?')) return;
                const taskIndex = weekData[dateKey].tasks.findIndex(t => t.id === taskId);
                weekData[dateKey].tasks.splice(taskIndex, 1);
                saveData(weekKey, weekData);
                renderCurrentView();
            }
        }

        function deleteRecurringInstance() {
            if (!window.currentDeleteTask) return;
            
            const { weekKey, dateKey, taskId } = window.currentDeleteTask;
            const weekData = loadData(weekKey);
            const taskIndex = weekData[dateKey].tasks.findIndex(t => t.id === taskId);
            weekData[dateKey].tasks.splice(taskIndex, 1);
            saveData(weekKey, weekData);
            
            closeModal('delete-recurring-modal');
            renderCurrentView();
            alert('‚úÖ Deleted this instance!');
        }

        function deleteRecurringAll() {
            if (!window.currentDeleteTask) return;
            
            const { weekKey, dateKey, taskId, recurringId } = window.currentDeleteTask;
            
            // Delete from this week
            const weekData = loadData(weekKey);
            const taskIndex = weekData[dateKey].tasks.findIndex(t => t.id === taskId);
            weekData[dateKey].tasks.splice(taskIndex, 1);
            saveData(weekKey, weekData);
            
            // Delete from recurring template
            const recurringTasks = loadData('recurring-tasks') || [];
            const filtered = recurringTasks.filter(rt => rt.id !== recurringId);
            saveData('recurring-tasks', filtered);
            
            closeModal('delete-recurring-modal');
            renderCurrentView();
            alert('‚úÖ Removed from all future weeks!');
        }
        function showRecurringTasksModal() {
            const recurringTasks = loadData('recurring-tasks') || [];
            
            if (recurringTasks.length === 0) {
                document.getElementById('recurring-tasks-list').innerHTML = '<p style="color: var(--text-lighter);">No recurring tasks yet!</p>';
            } else {
                let html = '';
                recurringTasks.forEach(task => {
                    const daysDisplay = task.frequency === 'daily' ? 'Every day' : 
                                       task.frequency === 'monthly' ? `Monthly (${task.days[0]})` :
                                       task.days.join(', ');
                    
                    html += `
                        <div style="background: var(--surface-hover); border-radius: 12px; padding: 15px; margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div>
                                    <div style="font-weight: 600; margin-bottom: 5px;">${task.text}</div>
                                    <div style="font-size: 0.85rem; color: var(--text-lighter);">
                                        <span class="task-tag tag-${task.category}">${task.category}</span>
                                        ${task.time ? `<span style="margin-left: 8px;">‚è±Ô∏è ${task.time}</span>` : ''}
                                    </div>
                                    <div style="font-size: 0.85rem; color: var(--text-light); margin-top: 5px;">
                                        üìÖ ${task.frequency} - ${daysDisplay}
                                    </div>
                                </div>
                                <button class="task-action-btn-small btn-delete" onclick="deleteRecurringFromList(${task.id})">üóëÔ∏è</button>
                            </div>
                        </div>
                    `;
                });
                document.getElementById('recurring-tasks-list').innerHTML = html;
            }
            
            document.getElementById('recurring-tasks-modal').classList.add('active');
        }

        function deleteRecurringFromList(recurringId) {
            if (!confirm('Delete this recurring task? It will be removed from all future weeks.')) return;
            
            const recurringTasks = loadData('recurring-tasks') || [];
            const filtered = recurringTasks.filter(rt => rt.id !== recurringId);
            saveData('recurring-tasks', filtered);
            
            showRecurringTasksModal(); // Refresh the list
            alert('‚úÖ Recurring task deleted!');
        }
        // ============================================
        // CAPTURE LIST FUNCTIONS
        // ============================================

        let currentCaptureFilter = 'all';

        function openAddCaptureItemModal() {
            document.getElementById('add-capture-item-modal').classList.add('active');
        }

                function saveCaptureItem() {
            const text = document.getElementById('capture-item-text').value.trim();
            const category = document.getElementById('capture-item-category').value;
            const priority = document.getElementById('capture-item-priority').value;
            const notes = document.getElementById('capture-item-notes').value.trim();
            const timeEstimate = document.getElementById('capture-item-time').value.trim();
            
            if (!text) {
                alert('Please enter what you discovered!');
                return;
            }
            
            // Load existing capture list
            let captureList = JSON.parse(localStorage.getItem('capture-list') || '[]');
            
            // Create new item - use the original category, not 'capture'
            const newItem = {
                id: Date.now(),
                text: text,
                category: category, // Use the actual category they selected
                priority: priority,
                notes: notes,
                time: timeEstimate || undefined,
                status: 'unassigned',
                assignedTo: null,
                createdAt: new Date().toISOString(),
                completedAt: null,
                fromCapture: true // Mark that it came from capture list
            };
            
            captureList.push(newItem);
            localStorage.setItem('capture-list', JSON.stringify(captureList));
            
            // Clear form
            document.getElementById('capture-item-text').value = '';
            document.getElementById('capture-item-category').value = 'deep-clean';
            document.getElementById('capture-item-priority').value = '';
            document.getElementById('capture-item-notes').value = '';
            document.getElementById('capture-item-time').value = '';
            
            closeModal('add-capture-item-modal');
            renderCaptureList();
        }


          function renderCaptureList() {
            const captureList = JSON.parse(localStorage.getItem('capture-list') || '[]');
            const container = document.getElementById('capture-list-content');
            
            // Filter items
            let filteredItems = captureList;
            if (currentCaptureFilter === 'unassigned') {
                filteredItems = captureList.filter(item => item.status === 'unassigned');
            } else if (currentCaptureFilter === 'assigned') {
                filteredItems = captureList.filter(item => item.status === 'assigned');
            } else if (currentCaptureFilter === 'completed') {
                filteredItems = captureList.filter(item => item.status === 'completed');
            }
            
            if (filteredItems.length === 0) {
                let emptyMessage = 'No capture items yet! Click "+ Add Item" to get started.';
                if (currentCaptureFilter === 'completed') {
                    emptyMessage = 'No completed items yet!';
                } else if (currentCaptureFilter === 'unassigned') {
                    emptyMessage = 'All items are assigned! üéâ';
                } else if (currentCaptureFilter === 'assigned') {
                    emptyMessage = 'No assigned items yet!';
                }
                container.innerHTML = `<p style="color: var(--text-lighter); text-align: center; padding: 40px 20px;">${emptyMessage}</p>`;
                return;
            }
            
            let html = '';
            filteredItems.forEach(item => {
                const statusClass = item.status === 'unassigned' ? 'unassigned' : 
                                   item.status === 'completed' ? 'completed' : 'assigned';
                
                let assignmentInfo = '';
                if (item.assignedTo) {
                    if (item.assignedTo.recurring) {
                        const freqDisplay = item.assignedTo.frequency === 'daily' ? 'Daily' :
                                          item.assignedTo.frequency === 'monthly' ? 'Monthly' :
                                          `${item.assignedTo.days.join(', ')}`;
                        assignmentInfo = `<div style="font-size: 0.85rem; color: var(--primary); margin-top: 5px;">üîÑ Recurring: ${freqDisplay} (starts ${item.assignedTo.startDate})</div>`;
                    } else {
                        assignmentInfo = `<div style="font-size: 0.85rem; color: var(--primary); margin-top: 5px;">üìÖ Scheduled for ${item.assignedTo.dateKey}${item.assignedTo.time ? ` at ${item.assignedTo.time}` : ''}</div>`;
                    }
                }
                
                let completedInfo = '';
                if (item.status === 'completed' && item.completedAt) {
                    completedInfo = `<div style="font-size: 0.85rem; color: var(--emerald); margin-top: 5px;">‚úÖ Completed: ${new Date(item.completedAt).toLocaleDateString()}</div>`;
                }
                
                // Action buttons based on status
                let actionButtons = '';
                if (item.status === 'unassigned') {
                    actionButtons = `
                        <button class="task-action-btn-small btn-edit" onclick="editCaptureItem(${item.id})">‚úèÔ∏è Edit Item</button>
                        <button class="task-action-btn-small" style="background: var(--primary); color: white;" onclick="assignCaptureItem(${item.id})">üìÖ Assign to Day</button>
                        <button class="task-action-btn-small btn-delete" onclick="deleteCaptureItem(${item.id})">üóëÔ∏è Delete</button>
                    `;
                } else if (item.status === 'assigned') {
                    actionButtons = `
                        <button class="task-action-btn-small btn-edit" onclick="editCaptureItem(${item.id})">‚úèÔ∏è Edit Item</button>
                        <button class="task-action-btn-small btn-edit" onclick="editCaptureAssignment(${item.id})">üìÖ Edit Assignment</button>
                        <button class="task-action-btn-small" style="background: var(--amethyst); color: white;" onclick="unassignCaptureItem(${item.id})">‚Ü©Ô∏è Unassign</button>
                        <button class="task-action-btn-small" style="background: var(--emerald); color: white;" onclick="completeCaptureItem(${item.id})">‚úì Mark Complete</button>
                        <button class="task-action-btn-small btn-delete" onclick="deleteCaptureItem(${item.id}, false)">üóëÔ∏è Delete</button>
                    `;
                } else if (item.status === 'completed') {
                    actionButtons = `
                        <button class="task-action-btn-small" style="background: var(--primary); color: white;" onclick="uncompleteCaptureItem(${item.id})">‚Ü©Ô∏è Mark Incomplete</button>
                        <button class="task-action-btn-small btn-delete" onclick="deleteCaptureItem(${item.id}, false)">üóëÔ∏è Delete Permanently</button>
                    `;
                }
                
                html += `
                    <div class="capture-item ${statusClass}">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div style="flex: 1;">
                                <div style="font-size: 1rem; font-weight: 500; margin-bottom: 5px; ${item.status === 'completed' ? 'text-decoration: line-through; opacity: 0.7;' : ''}">${item.text}</div>
                                                               <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                                    <span class="task-tag tag-${item.category}">${item.category}</span>
                                    ${item.time ? `<span class="task-time">‚è±Ô∏è ${item.time}</span>` : ''}
                                    ${item.priority ? `<span style="font-size: 0.85rem; color: var(--text-lighter);">Priority: ${item.priority}</span>` : ''}
                                    <span class="capture-status ${statusClass}">${item.status.charAt(0).toUpperCase() + item.status.slice(1)}</span>
                                </div>
                                ${assignmentInfo}
                                ${completedInfo}
                            </div>
                        </div>
                        ${item.notes ? `<div style="font-size: 0.9rem; color: var(--text-lighter); margin-bottom: 10px; font-style: italic;">${item.notes}</div>` : ''}
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            ${actionButtons}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }


        function unassignCaptureItem(itemId) {
            if (!confirm('Unassign this item? It will be removed from your schedule.')) return;
            
            const captureList = JSON.parse(localStorage.getItem('capture-list') || '[]');
            const item = captureList.find(i => i.id === itemId);
            
            if (!item || !item.assignedTo) return;
            
            // Remove from schedule (one-time assignment only)
            const weekKey = item.assignedTo.weekKey;
            const dateKey = item.assignedTo.dateKey;
            const weekData = loadData(weekKey);
            
            if (weekData && weekData[dateKey]) {
                weekData[dateKey].tasks = weekData[dateKey].tasks.filter(t => 
                    t.captureItemId !== item.id
                );
                saveData(weekKey, weekData);
            }
            
            // Update capture item
            item.status = 'unassigned';
            item.assignedTo = null;
            localStorage.setItem('capture-list', JSON.stringify(captureList));
            
            renderCaptureList();
            renderCurrentView();
            alert('‚úÖ Item unassigned!');
        }

        function completeCaptureItem(itemId) {
            const captureList = JSON.parse(localStorage.getItem('capture-list') || '[]');
            const item = captureList.find(i => i.id === itemId);
            
            if (!item) return;
            
            // Mark as completed
            item.status = 'completed';
            item.completedAt = new Date().toISOString();
            
            // Mark task as complete in schedule (if not recurring)
            if (item.assignedTo && !item.assignedTo.recurring) {
                const weekKey = item.assignedTo.weekKey;
                const dateKey = item.assignedTo.dateKey;
                const weekData = loadData(weekKey);
                
                if (weekData && weekData[dateKey]) {
                    const task = weekData[dateKey].tasks.find(t => 
                        t.fromCapture && t.text === item.text
                    );
                    if (task) {
                        task.completed = true;
                        saveData(weekKey, weekData);
                    }
                }
            }
            
            localStorage.setItem('capture-list', JSON.stringify(captureList));
            
            renderCaptureList();
            renderCurrentView();
            alert('‚úÖ Item marked complete!');
        }
        let currentEditCaptureItemId = null;

        function editCaptureItem(itemId) {
            const captureList = JSON.parse(localStorage.getItem('capture-list') || '[]');
            const item = captureList.find(i => i.id === itemId);
            
            if (!item) return;
            
            currentEditCaptureItemId = itemId;
            
            // Pre-fill form
            document.getElementById('edit-capture-item-text').value = item.text;
            document.getElementById('edit-capture-item-category').value = item.category;
            document.getElementById('edit-capture-item-time').value = item.time || '';
            document.getElementById('edit-capture-item-priority').value = item.priority || '';
            document.getElementById('edit-capture-item-notes').value = item.notes || '';
            
            document.getElementById('edit-capture-item-modal').classList.add('active');
        }
function editCaptureAssignment(itemId) {
            const captureList = JSON.parse(localStorage.getItem('capture-list') || '[]');
            const item = captureList.find(i => i.id === itemId);
            
            if (!item || !item.assignedTo) return;
            
            currentAssignItemId = itemId;
            
            // Pre-fill form with current assignment
            document.getElementById('assign-date').value = item.assignedTo.dateKey;
            document.getElementById('assign-time').value = item.assignedTo.time || '';
            
            document.getElementById('assign-capture-modal').classList.add('active');
        }
        
        function confirmAssignCaptureItem() {
            if (!currentAssignItemId) return;
            
            const dateInput = document.getElementById('assign-date').value;
            const timeInput = document.getElementById('assign-time').value.trim();
            
            if (!dateInput) {
                alert('Please select a date!');
                return;
            }
            
            // CRITICAL: Always load fresh data from localStorage
            let captureList = JSON.parse(localStorage.getItem('capture-list') || '[]');
            const item = captureList.find(i => i.id === currentAssignItemId);
            
            if (!item) {
                alert('Error: Item not found');
                return;
            }
            
            // Check if we're editing an existing assignment
            const isEditing = item.status === 'assigned' && item.assignedTo && item.assignedTo.dateKey;
            
            if (isEditing) {
                // Remove task from old location FIRST
                const oldWeekData = loadData(item.assignedTo.weekKey);
                if (oldWeekData && oldWeekData[item.assignedTo.dateKey]) {
                    oldWeekData[item.assignedTo.dateKey].tasks = 
                        oldWeekData[item.assignedTo.dateKey].tasks.filter(t => 
                            t.captureItemId !== item.id
                        );
                    saveData(item.assignedTo.weekKey, oldWeekData);
                }
            }
            
            // Now assign to new location
            const selectedDate = parseLocalDate(dateInput);
            const weekStart = getWeekStart(selectedDate);
            const weekKey = getWeekKey(weekStart);
            
            // Load or generate week data
            let weekData = loadData(weekKey);
            if (!weekData) {
                weekData = generateWeekData(weekStart);
            }
            
            const dateKey = formatDate(selectedDate);
            
            // Make sure the day exists in weekData
            if (!weekData[dateKey]) {
                alert(`Error: Could not find ${dateKey} in week data`);
                return;
            }
            
            // Add task to new location
            const newTask = {
                id: Date.now(),
                text: item.text,
                category: item.category,
                time: timeInput || item.time || undefined,
                completed: false,
                notes: item.notes || '',
                fromCapture: true,
                captureItemId: item.id
            };
            
            weekData[dateKey].tasks.push(newTask);
            saveData(weekKey, weekData);
            
            // Update capture item status
            item.status = 'assigned';
            item.assignedTo = {
                dateKey: dateKey,
                weekKey: weekKey,
                time: timeInput || null,
                taskId: newTask.id
            };
            
            localStorage.setItem('capture-list', JSON.stringify(captureList));
            
            closeModal('assign-capture-modal');
            renderCaptureList();
            
            const actionText = isEditing ? 'moved to' : 'added to';
            alert(`‚úÖ "${item.text}" ${actionText} ${dateKey}!`);
            
            // Refresh the current view
            renderCurrentView();
        }

        function saveEditedCaptureItem() {
            if (!currentEditCaptureItemId) return;
            
            const captureList = JSON.parse(localStorage.getItem('capture-list') || '[]');
            const item = captureList.find(i => i.id === currentEditCaptureItemId);
            
            if (!item) return;
            
            // Get new values
            const newText = document.getElementById('edit-capture-item-text').value.trim();
            const newCategory = document.getElementById('edit-capture-item-category').value;
            const newTime = document.getElementById('edit-capture-item-time').value.trim() || undefined;
            const newPriority = document.getElementById('edit-capture-item-priority').value;
            const newNotes = document.getElementById('edit-capture-item-notes').value.trim();
            
            // If item is assigned, update it in the schedule too
            if (item.assignedTo && item.assignedTo.weekKey && item.assignedTo.dateKey) {
                const weekData = loadData(item.assignedTo.weekKey);
                if (weekData && weekData[item.assignedTo.dateKey]) {
                    const task = weekData[item.assignedTo.dateKey].tasks.find(t => 
                        t.captureItemId === item.id
                    );
                    if (task) {
                        task.text = newText;
                        task.category = newCategory;
                        task.time = newTime;
                        task.notes = newNotes;
                        saveData(item.assignedTo.weekKey, weekData);
                    }
                }
            }
            
            // Update capture item
            item.text = newText;
            item.category = newCategory;
            item.time = newTime;
            item.priority = newPriority;
            item.notes = newNotes;
            
            localStorage.setItem('capture-list', JSON.stringify(captureList));
            
            closeModal('edit-capture-item-modal');
            renderCaptureList();
            renderCurrentView();
            alert('‚úÖ Item updated everywhere!');
        }


        function uncompleteCaptureItem(itemId) {
            const captureList = JSON.parse(localStorage.getItem('capture-list') || '[]');
            const item = captureList.find(i => i.id === itemId);
            
            if (!item) return;
            
            // Mark as assigned (if it has assignment) or unassigned
            if (item.assignedTo) {
                item.status = 'assigned';
                
                // Uncheck the task in schedule
                if (!item.assignedTo.recurring) {
                    const weekKey = item.assignedTo.weekKey;
                    const dateKey = item.assignedTo.dateKey;
                    const weekData = loadData(weekKey);
                    
                    if (weekData && weekData[dateKey]) {
                        const task = weekData[dateKey].tasks.find(t => 
                            t.fromCapture && t.text === item.text
                        );
                        if (task) {
                            task.completed = false;
                            saveData(weekKey, weekData);
                        }
                    }
                }
            } else {
                item.status = 'unassigned';
            }
            
            item.completedAt = null;
            
            localStorage.setItem('capture-list', JSON.stringify(captureList));
            
            renderCaptureList();
            renderCurrentView();
            alert('‚úÖ Item marked incomplete!');
        }


        function filterCaptureList(filter) {
            currentCaptureFilter = filter;
            
            // Update button states
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            renderCaptureList();
        }

                        let currentAssignItemId = null;

        function assignCaptureItem(itemId) {
            currentAssignItemId = itemId;
            
            // Set default date to today
            const today = new Date();
            document.getElementById('assign-date').value = formatDate(today);
            document.getElementById('assign-date').min = formatDate(today); // Can't assign to past
            document.getElementById('assign-time').value = '';
            document.getElementById('make-recurring').checked = false;
            document.getElementById('recurring-options').style.display = 'none';
            
            // Reset days checkboxes
            document.querySelectorAll('#assign-days-selector input[type="checkbox"]').forEach(cb => cb.checked = false);
            
            document.getElementById('assign-capture-modal').classList.add('active');
        }

        function setAssignDate(option) {
            const today = new Date();
            let targetDate;
            
            if (option === 'today') {
                targetDate = today;
            } else if (option === 'tomorrow') {
                targetDate = new Date(today);
                targetDate.setDate(today.getDate() + 1);
            } else if (option === 'this-weekend') {
                targetDate = new Date(today);
                const daysUntilSaturday = (6 - today.getDay() + 7) % 7;
                targetDate.setDate(today.getDate() + daysUntilSaturday);
            } else if (option === 'next-week') {
                targetDate = new Date(today);
                targetDate.setDate(today.getDate() + 7);
            }
            
            document.getElementById('assign-date').value = formatDate(targetDate);
        }

        function toggleRecurringOptions() {
            const isChecked = document.getElementById('make-recurring').checked;
            document.getElementById('recurring-options').style.display = isChecked ? 'block' : 'none';
            
            if (isChecked) {
                toggleAssignDaysSelector();
            }
        }

        function toggleAssignDaysSelector() {
            const frequency = document.getElementById('assign-frequency').value;
            const daysSelector = document.getElementById('assign-days-selector');
            
            if (frequency === 'daily' || frequency === 'monthly') {
                daysSelector.style.display = 'none';
            } else {
                daysSelector.style.display = 'block';
            }
        }


          function deleteCaptureItem(itemId) {
            const captureList = JSON.parse(localStorage.getItem('capture-list') || '[]');
            const item = captureList.find(i => i.id === itemId);
            
            if (!item) return;
            
            const confirmMsg = item.status === 'completed' ? 
                'Delete this completed item from capture list?' : 
                item.status === 'assigned' ?
                'Delete this item from capture list? (It will also be removed from your schedule if not completed and the date hasn\'t passed)' :
                'Delete this item from capture list?';
            
            if (!confirm(confirmMsg)) return;
            
            // DELETE LOGIC based on scenarios
            if (item.status === 'assigned' && item.assignedTo) {
                const assignedDate = parseLocalDate(item.assignedTo.dateKey);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                assignedDate.setHours(0, 0, 0, 0);
                
                const weekData = loadData(item.assignedTo.weekKey);
                
                if (weekData && weekData[item.assignedTo.dateKey]) {
                    const task = weekData[item.assignedTo.dateKey].tasks.find(t => 
                        t.captureItemId === item.id
                    );
                    
                    // Scenario 2: Future date, not complete ‚Üí DELETE from schedule
                    // Scenario 3: Future date, completed ‚Üí KEEP in schedule
                    // Scenario 4: Past date, not complete ‚Üí KEEP in schedule (historical record)
                    // Scenario 5: Past date, completed ‚Üí KEEP in schedule (for metrics)
                    
                    const shouldDeleteFromSchedule = 
                        assignedDate >= today && // Future or today
                        task && !task.completed; // Not completed
                    
                    if (shouldDeleteFromSchedule) {
                        // Remove from schedule
                        weekData[item.assignedTo.dateKey].tasks = 
                            weekData[item.assignedTo.dateKey].tasks.filter(t => 
                                t.captureItemId !== item.id
                            );
                        saveData(item.assignedTo.weekKey, weekData);
                    }
                }
            }
            
            // Always remove from capture list
            const filtered = captureList.filter(i => i.id !== itemId);
            localStorage.setItem('capture-list', JSON.stringify(filtered));
            
            renderCaptureList();
            renderCurrentView();
            alert('‚úÖ Item deleted!');
        }


        function addCustomTask(event) {
            event.preventDefault();
            const name = document.getElementById('task-name').value;
            const category = document.getElementById('task-category').value;
            const time = document.getElementById('task-time').value;
            if (!currentModalDay) return;

            const weekKey = getWeekKey(getWeekStart());
            const weekData = loadData(weekKey);

            weekData[currentModalDay].tasks.push({
                id: Date.now(),
                text: name,
                category,
                time: time || undefined,
                completed: false,
                custom: true,
                notes: ''
            });

            saveData(weekKey, weekData);
            closeModal('add-task-modal');
            renderCurrentView();
        }

        function renderTaskItem(task, weekKey, dateKey) {
            const routine = task.routine ? ROUTINES_LIBRARY[task.routine] : null;
            const taskKey = `${weekKey}-${dateKey}-${task.id}`;
            const isExpanded = expandedTasks.has(taskKey);
            
            let detailsHtml = '';
            if (isExpanded) {
                detailsHtml = `
                    <div class="task-details active">
                        ${routine ? `
                            <div class="task-details-section">
                                <div class="task-details-title">‚è±Ô∏è Time: ${routine.time}</div>
                            </div>
                            <div class="task-details-section">
                                <div class="task-details-title">üìã Steps:</div>
                                <ul class="task-details-list">
                                    ${routine.steps.map(step => `<li>${step}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        <div class="task-details-section">
                            <div class="task-details-title">üìù My Notes:</div>
                            <textarea class="task-notes-input" 
                                      placeholder="Add your personal notes here..."
                                      onchange="saveTaskNotes('${weekKey}', '${dateKey}', ${task.id}, this.value)"
                                      onclick="event.stopPropagation()">${task.notes || ''}</textarea>
                        </div>
                     <div class="task-actions-row">
                            <button class="task-action-btn-small btn-edit" onclick="openEditTaskModal('${weekKey}', '${dateKey}', ${task.id}, event)">‚úèÔ∏è Edit</button>
                            <button class="task-action-btn-small btn-move" onclick="openMoveTaskModal('${weekKey}', '${dateKey}', ${task.id}, event)">üìÖ Move</button>
                            <button class="task-action-btn-small btn-delete" onclick="deleteTask('${weekKey}', '${dateKey}', ${task.id}, event)">üóëÔ∏è Delete</button>
                            <button class="task-action-btn-small" style="background: var(--amethyst); color: white;" onclick="openAddToRoutineModal('${weekKey}', '${dateKey}', ${task.id}, event)">üîÑ Add to Routine</button>
                        </div>
                    </div>
                `;
            }

            return `
                <div class="task-item-wrapper">
                    <div class="task-item ${task.completed ? 'completed' : ''} ${isExpanded ? 'expanded' : ''}" 
                         draggable="true"
                        data-week-key="${weekKey}"
                        data-date-key="${dateKey}"
                        data-task-id="${task.id}"
                        ontouchstart="handleTouchStart(event)"
                         ontouchmove="handleTouchMove(event)"
                         ontouchend="handleTouchEnd(event)"
                         ondragstart="handleDragStart(event, '${weekKey}', '${dateKey}', ${task.id})"
                         ondragover="handleDragOver(event)"
                         ondrop="handleDrop(event, '${weekKey}', '${dateKey}', ${task.id})"
                         ondragend="handleDragEnd(event)"
                         onclick="toggleTaskDetails('${weekKey}', '${dateKey}', ${task.id})">
                        <div class="checkbox ${task.completed ? 'checked' : ''}" 
                             onclick="toggleTask('${weekKey}', '${dateKey}', ${task.id}, event)"></div>
                        <div class="task-content">
                            <div class="task-header-row">
                                <div class="task-text">${task.text}</div>
                                <span class="task-expand-icon">‚ñº</span>
                            </div>
                            <div class="task-meta">
                                <span class="task-tag tag-${task.category}">${task.category}</span>
                                ${task.time ? `<span class="task-time">‚è±Ô∏è ${task.time}</span>` : (routine ? `<span class="task-time">‚è±Ô∏è ${routine.time}</span>` : '')}
                            </div>
                        </div>
                    </div>
                    ${detailsHtml}
                </div>
            `;
        }

        function renderTodayView() {
            const today = new Date();
            const todayKey = formatDate(today);
            const weekStart = getWeekStart(today);
            const weekKey = getWeekKey(weekStart);
            const weekData = generateWeekData(weekStart);
            const dayData = weekData[todayKey];

            if (!dayData) {
                document.getElementById('today-date').textContent = formatDisplayDate(today);
                document.getElementById('today-tasks').innerHTML = '<div class="day-section"><p>No tasks for today!</p></div>';
                return;
            }

            document.getElementById('today-date').textContent = formatDisplayDate(today);
            
            const completed = dayData.tasks.filter(t => t.completed).length;
            const total = dayData.tasks.length;
            const percentage = total > 0 ? (completed / total) * 100 : 0;

            document.getElementById('today-progress').style.width = percentage + '%';
            document.getElementById('progress-text').textContent = `${completed} of ${total} tasks complete`;

            const tasksHtml = dayData.tasks.map(task => renderTaskItem(task, weekKey, todayKey)).join('');

            document.getElementById('today-tasks').innerHTML = `
                <div class="day-section">
                    <div class="daily-notes">
                        <div class="daily-notes-title">üìî Notes for Today</div>
                        <textarea class="daily-notes-textarea" 
                                  placeholder="Add notes for today..."
                                  onchange="saveDayNotes('${weekKey}', '${todayKey}', this.value)">${dayData.dayNotes || ''}</textarea>
                    </div>
                    ${tasksHtml}
                    <button class="add-task-btn" onclick="openAddTaskModal('${todayKey}')">+ Add Task</button>
                </div>
            `;
        }

        function renderWeekView() {
            const weekStart = currentWeekView === 'current' ? getWeekStart() : getWeekStart(new Date(Date.now() + 7 * 24 * 60 * 60 * 1000));
            const weekKey = getWeekKey(weekStart);
            const weekData = generateWeekData(weekStart);

            let html = '';
            for (let i = 0; i < 7; i++) {
                const dayDate = new Date(weekStart);
                dayDate.setDate(weekStart.getDate() + i);
                const dateKey = formatDate(dayDate);
                const dayData = weekData[dateKey];

                const completed = dayData.tasks.filter(t => t.completed).length;
                const total = dayData.tasks.length;
                const isComplete = completed === total && total > 0;

                const tasksHtml = dayData.tasks.map(task => renderTaskItem(task, weekKey, dateKey)).join('');

                html += `
                    <div class="day-section">
                        <div class="day-header">
                            <div class="day-title-group">
                                <span class="day-title">${dayData.dayName.charAt(0).toUpperCase() + dayData.dayName.slice(1)}</span>
                                <span class="day-date">${formatShortDate(dayDate)}</span>
                            </div>
                            <div class="day-stats">
                                <span class="completion-badge ${isComplete ? 'complete' : ''}">${completed}/${total}</span>
                            </div>
                        </div>
                        <div class="daily-notes">
                            <div class="daily-notes-title">üìî Notes</div>
                            <textarea class="daily-notes-textarea" 
                                      placeholder="Add notes..."
                                      onchange="saveDayNotes('${weekKey}', '${dateKey}', this.value)">${dayData.dayNotes || ''}</textarea>
                        </div>
                        <div class="task-list">
                            ${tasksHtml}
                            <button class="add-task-btn" onclick="openAddTaskModal('${dateKey}')">+ Add Task</button>
                        </div>
                    </div>
                `;
            }

            document.getElementById('week-content').innerHTML = html;
        }

                function renderRoutinesView() {
            let html = `
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="openCreateRoutineModal()" style="background: linear-gradient(135deg, var(--emerald), var(--jade));">
                        ‚ûï Create New Routine
                    </button>
                </div>
            `;
            
            for (const [key, routine] of Object.entries(ROUTINES_LIBRARY)) {
                html += `
                    <div style="background: var(--surface); border: 2px solid var(--border); border-radius: 16px; padding: 20px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <h3 style="font-family: 'Playfair Display', serif; font-size: 1.2rem; font-weight: 600;">${routine.name}</h3>
                            <span style="font-size: 0.85rem; color: var(--text-lighter);">‚è±Ô∏è ${routine.time}</span>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <span class="task-tag tag-${routine.category}">${routine.category}</span>
                        </div>
                        <ul class="task-details-list" style="margin-bottom: 15px;">
                            ${routine.steps.map(step => `<li>${step}</li>`).join('')}
                        </ul>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="task-action-btn-small btn-edit" onclick="openEditRoutineModal('${key}')">‚úèÔ∏è Edit</button>
                            <button class="task-action-btn-small" style="background: var(--emerald); color: white;" onclick="openAddRoutineToScheduleModal('${key}')">üìÖ Add to Schedule</button>
                            <button class="task-action-btn-small btn-delete" onclick="deleteRoutine('${key}')">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                `;
            }
            document.getElementById('routines-content').innerHTML = html;
        }

                
        function calculateStreak() {
            let streak = 0;
            const today = new Date();
            
            for (let i = 0; i < 365; i++) {
                const checkDate = new Date(today);
                checkDate.setDate(today.getDate() - i);
                const weekStart = getWeekStart(checkDate);
                const weekKey = getWeekKey(weekStart);
                const weekData = loadData(weekKey);
                
                if (!weekData) break;
                
                const dateKey = formatDate(checkDate);
                const dayData = weekData[dateKey];
                
                if (!dayData || !dayData.tasks.length) break;
                
                const completed = dayData.tasks.filter(t => t.completed).length;
                const total = dayData.tasks.length;
                const percentage = (completed / total) * 100;
                
                if (percentage >= 80) {
                    streak++;
                } else {
                    break;
                }
            }
            
            return streak;
        }

        function renderMetricsView() {
            // Current Streak
            const streak = calculateStreak();
            document.getElementById('streak-count').textContent = streak;

            // This Week Stats
            const weekStart = getWeekStart();
            const weekKey = getWeekKey(weekStart);
            const weekData = loadData(weekKey);
            
            let weekCompleted = 0;
            let weekTotal = 0;
            
            if (weekData) {
                for (let i = 0; i < 7; i++) {
                    const dayDate = new Date(weekStart);
                    dayDate.setDate(weekStart.getDate() + i);
                    const dateKey = formatDate(dayDate);
                    const dayData = weekData[dateKey];
                    
                    if (dayData) {
                        weekCompleted += dayData.tasks.filter(t => t.completed).length;
                        weekTotal += dayData.tasks.length;
                    }
                }
            }
            
            const weekPercentage = weekTotal > 0 ? Math.round((weekCompleted / weekTotal) * 100) : 0;
            
            document.getElementById('week-stats').innerHTML = `
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="font-weight: 600;">Completion Rate</span>
                        <span style="color: var(--emerald); font-weight: 700;">${weekPercentage}%</span>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" style="width: ${weekPercentage}%"></div>
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 10px; background: var(--surface-hover); border-radius: 12px;">
                    <div>
                        <div style="font-size: 2rem; font-weight: 700; color: var(--primary);">${weekCompleted}</div>
                        <div style="font-size: 0.9rem; color: var(--text-lighter);">Tasks completed</div>
                    </div>
                    <div>
                        <div style="font-size: 2rem; font-weight: 700; color: var(--text-light);">${weekTotal}</div>
                        <div style="font-size: 0.9rem; color: var(--text-lighter);">Total tasks</div>
                    </div>
                </div>
            `;

            // All Time Stats
            let allTimeCompleted = 0;
            let totalDays = 0;
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('week-')) {
                    const data = loadData(key);
                    if (data) {
                        for (const dateKey in data) {
                            const dayData = data[dateKey];
                            if (dayData && dayData.tasks) {
                                allTimeCompleted += dayData.tasks.filter(t => t.completed).length;
                                totalDays++;
                            }
                        }
                    }
                }
            }

            document.getElementById('alltime-stats').innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div style="text-align: center; padding: 20px; background: var(--amethyst-lighter); border-radius: 12px;">
                        <div style="font-size: 2.5rem; font-weight: 700; color: var(--amethyst);">${allTimeCompleted}</div>
                        <div style="font-size: 0.9rem; color: var(--text-light); margin-top: 5px;">Total Tasks<br>Completed</div>
                    </div>
                    <div style="text-align: center; padding: 20px; background: var(--gold-light); border-radius: 12px;">
                        <div style="font-size: 2.5rem; font-weight: 700; color: var(--gold);">${totalDays}</div>
                        <div style="font-size: 0.9rem; color: var(--text-light); margin-top: 5px;">Days<br>Tracked</div>
                    </div>
                </div>
            `;
        }
        let currentEditRoutineKey = null;
        let currentAddRoutineKey = null;

        function openEditRoutineModal(routineKey) {
            currentEditRoutineKey = routineKey;
            const routine = ROUTINES_LIBRARY[routineKey];
            
            document.getElementById('edit-routine-name').value = routine.name;
            document.getElementById('edit-routine-time').value = routine.time;
            document.getElementById('edit-routine-category').value = routine.category;
            document.getElementById('edit-routine-steps').value = routine.steps.join('\n');
            
            document.getElementById('edit-routine-modal').classList.add('active');
        }

        function saveRoutineEdit(event) {
            event.preventDefault();
            if (!currentEditRoutineKey) return;
            
            ROUTINES_LIBRARY[currentEditRoutineKey] = {
                name: document.getElementById('edit-routine-name').value,
                time: document.getElementById('edit-routine-time').value,
                category: document.getElementById('edit-routine-category').value,
                steps: document.getElementById('edit-routine-steps').value.split('\n').filter(s => s.trim())
            };
            
            saveData('routines-library', ROUTINES_LIBRARY);
            closeModal('edit-routine-modal');
            renderRoutinesView();
            alert('‚úÖ Routine updated!');
        }

        function openCreateRoutineModal() {
            document.getElementById('new-routine-name').value = '';
            document.getElementById('new-routine-time').value = '';
            document.getElementById('new-routine-category').value = 'habit';
            document.getElementById('new-routine-steps').value = '';
            document.getElementById('create-routine-modal').classList.add('active');
        }

        function saveNewRoutine(event) {
            event.preventDefault();
            
            const name = document.getElementById('new-routine-name').value;
            const key = name.toLowerCase().replace(/[^a-z0-9]/g, '-');
            
            ROUTINES_LIBRARY[key] = {
                name: name,
                time: document.getElementById('new-routine-time').value,
                category: document.getElementById('new-routine-category').value,
                steps: document.getElementById('new-routine-steps').value.split('\n').filter(s => s.trim())
            };
            
            saveData('routines-library', ROUTINES_LIBRARY);
            closeModal('create-routine-modal');
            renderRoutinesView();
            alert('‚úÖ New routine created!');
        }

        function deleteRoutine(routineKey) {
            if (!confirm(`Delete "${ROUTINES_LIBRARY[routineKey].name}"? This cannot be undone.`)) return;
            
            delete ROUTINES_LIBRARY[routineKey];
            saveData('routines-library', ROUTINES_LIBRARY);
            renderRoutinesView();
            alert('‚úÖ Routine deleted!');
        }

        function openAddRoutineToScheduleModal(routineKey) {
            currentAddRoutineKey = routineKey;
            document.getElementById('add-routine-schedule-modal').classList.add('active');
        }

        function confirmAddRoutineToSchedule() {
            if (!currentAddRoutineKey) return;
            
            const routine = ROUTINES_LIBRARY[currentAddRoutineKey];
            const when = document.getElementById('routine-schedule-day').value;
            
            const today = new Date();
            let targetDate;
            
            if (when === 'today') {
                targetDate = today;
            } else {
                targetDate = new Date(today);
                targetDate.setDate(today.getDate() + 1);
            }
            
            const weekStart = getWeekStart(targetDate);
            const weekKey = getWeekKey(weekStart);
            const weekData = generateWeekData(weekStart);
            const dateKey = formatDate(targetDate);
            
            weekData[dateKey].tasks.push({
                id: Date.now(),
                text: routine.name,
                category: routine.category,
                routine: currentAddRoutineKey,
                completed: false,
                notes: '',
                custom: true
            });
            
            saveData(weekKey, weekData);
            closeModal('add-routine-schedule-modal');
            alert(`‚úÖ Added "${routine.name}" to ${when}!`);
            
            if (when === 'today') {
                renderTodayView();
            }
        }

        function loadRoutinesLibrary() {
            const saved = loadData('routines-library');
            if (saved) {
                Object.assign(ROUTINES_LIBRARY, saved);
            }
        }
                let currentRoutineTask = null;

        function openAddToRoutineModal(weekKey, dateKey, taskId, event) {
            event.stopPropagation();
            
            const weekData = loadData(weekKey);
            const task = weekData[dateKey].tasks.find(t => t.id === taskId);
            currentRoutineTask = { task, weekKey, dateKey, taskId };
            
            // Reset form
            document.getElementById('routine-frequency').value = 'weekly';
            document.querySelectorAll('#days-selector input[type="checkbox"]').forEach(cb => cb.checked = false);
            toggleDaysSelector();
            
            document.getElementById('add-to-routine-modal').classList.add('active');
        }

        function toggleDaysSelector() {
            const frequency = document.getElementById('routine-frequency').value;
            const daysSelector = document.getElementById('days-selector');
            
            if (frequency === 'daily') {
                daysSelector.style.display = 'none';
            } else if (frequency === 'monthly') {
                daysSelector.style.display = 'none';
            } else {
                daysSelector.style.display = 'block';
            }
        }

        // Add event listener to frequency dropdown
        document.addEventListener('DOMContentLoaded', function() {
    const freqSelect = document.getElementById('routine-frequency');
    if (freqSelect) {
        freqSelect.addEventListener('change', toggleDaysSelector);
    }
    
    const assignFreqSelect = document.getElementById('assign-frequency');
    if (assignFreqSelect) {
        assignFreqSelect.addEventListener('change', toggleAssignDaysSelector);
    }
});

        function saveTaskToRoutine(event) {
            event.preventDefault();
            if (!currentRoutineTask) return;
            
            const frequency = document.getElementById('routine-frequency').value;
            const task = currentRoutineTask.task;
            
            // Get selected days
            let days = [];
            if (frequency === 'daily') {
                days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            } else if (frequency === 'monthly') {
                const today = new Date();
                days = [`day-${today.getDate()}`];
            } else {
                document.querySelectorAll('#days-selector input[type="checkbox"]:checked').forEach(cb => {
                    days.push(cb.value);
                });
                
                if (days.length === 0) {
                    alert('Please select at least one day!');
                    return;
                }
            }
            
            // CHECK FOR DUPLICATES - NEW!
            const recurringTasks = loadData('recurring-tasks') || [];
            const duplicate = recurringTasks.find(rt => 
                rt.text === task.text && 
                rt.frequency === frequency &&
                JSON.stringify(rt.days.sort()) === JSON.stringify(days.sort())
            );
            
            if (duplicate) {
                alert('‚ö†Ô∏è This exact recurring task already exists!');
                return;
            }
            
            // Save to recurring tasks template
            recurringTasks.push({
                id: Date.now(),
                text: task.text,
                category: task.category,
                time: task.time,
                routine: task.routine,
                frequency: frequency,
                days: days,
                startDate: formatDate(new Date())
            });
            
            saveData('recurring-tasks', recurringTasks);
            
            closeModal('add-to-routine-modal');
            alert(`‚úÖ Added "${task.text}" to your recurring tasks!`);
        }

        let currentMonthView = new Date();

        function renderMonthView() {
            const year = currentMonthView.getFullYear();
            const month = currentMonthView.getMonth();
            
            // Update title
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('month-title').textContent = `${monthNames[month]} ${year}`;
            
            // Get first and last day of month
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            // Get day of week for first day (0 = Sunday)
            const firstDayOfWeek = firstDay.getDay();
            
            // Build calendar
            let html = '<div class="calendar-grid">';
            
            // Day headers
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                html += `<div class="calendar-day-header">${day}</div>`;
            });
            
            // Previous month days
            const prevMonthLastDay = new Date(year, month, 0).getDate();
            for (let i = firstDayOfWeek - 1; i >= 0; i--) {
                const day = prevMonthLastDay - i;
                html += `<div class="calendar-day other-month"><div class="calendar-day-number">${day}</div></div>`;
            }
            
            // Current month days
            const today = new Date();
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(year, month, day);
                const dateKey = formatDate(date);
                const isToday = dateKey === formatDate(today);
                
                // Get week data for this day
                const weekStart = getWeekStart(date);
                const weekKey = getWeekKey(weekStart);
                const weekData = loadData(weekKey);
                
                let tasksInfo = '';
                let completionBadge = '';
                
                if (weekData && weekData[dateKey]) {
                    const dayData = weekData[dateKey];
                    const completed = dayData.tasks.filter(t => t.completed).length;
                    const total = dayData.tasks.length;
                    const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
                    
                    tasksInfo = `<div class="calendar-day-tasks">${completed}/${total} tasks</div>`;
                    
                    let completionClass = 'low';
                    if (percentage >= 80) completionClass = 'high';
                    else if (percentage >= 50) completionClass = 'medium';
                    
                    if (total > 0) {
                        completionBadge = `<div class="calendar-completion ${completionClass}">${percentage}%</div>`;
                    }
                }
                
                html += `
                    <div class="calendar-day ${isToday ? 'today' : ''}" onclick="openDayDetail('${dateKey}')">
                        <div class="calendar-day-number">${day}</div>
                        ${tasksInfo}
                        ${completionBadge}
                    </div>
                `;
            }
            
            // Next month days
            const remainingCells = 42 - (firstDayOfWeek + lastDay.getDate());
            for (let day = 1; day <= remainingCells; day++) {
                html += `<div class="calendar-day other-month"><div class="calendar-day-number">${day}</div></div>`;
            }
            
            html += '</div>';
            document.getElementById('month-calendar').innerHTML = html;
        }

        function previousMonth() {
            currentMonthView.setMonth(currentMonthView.getMonth() - 1);
            renderMonthView();
        }

        function nextMonth() {
            currentMonthView.setMonth(currentMonthView.getMonth() + 1);
            renderMonthView();
        }

                let currentDayDetailKey = null;
        let currentDayDetailWeekKey = null;

         function openDayDetail(dateKey) {
            const date = parseLocalDate(dateKey);
            const weekStart = getWeekStart(date);
            const weekKey = getWeekKey(weekStart);
            const weekData = loadData(weekKey);
            
            currentDayDetailKey = dateKey;
            currentDayDetailWeekKey = weekKey;
            
            // Set title
            document.getElementById('day-detail-title').textContent = formatDisplayDate(date);
            
            if (!weekData || !weekData[dateKey]) {
                // No data for this day
                document.getElementById('day-detail-notes').value = '';
                document.getElementById('day-detail-tasks').innerHTML = '<p style="color: var(--text-lighter);">No tasks for this day yet.</p>';
                document.getElementById('day-detail-completion').textContent = '0/0';
            } else {
                const dayData = weekData[dateKey];
                
                // Set notes
                document.getElementById('day-detail-notes').value = dayData.dayNotes || '';
                
                // Render tasks
                const completed = dayData.tasks.filter(t => t.completed).length;
                const total = dayData.tasks.length;
                document.getElementById('day-detail-completion').textContent = `${completed}/${total}`;
                
                if (completed === total && total > 0) {
                    document.getElementById('day-detail-completion').classList.add('complete');
                } else {
                    document.getElementById('day-detail-completion').classList.remove('complete');
                }
                
                let tasksHtml = '';
                dayData.tasks.forEach(task => {
                    tasksHtml += `
                        <div style="display: flex; align-items: center; gap: 12px; padding: 10px; background: var(--surface-hover); border-radius: 8px; margin-bottom: 8px;">
                            <div class="checkbox ${task.completed ? 'checked' : ''}" onclick="toggleTaskInModal('${weekKey}', '${dateKey}', ${task.id})"></div>
                            <div style="flex: 1;">
                                <div style="font-size: 0.95rem; color: var(--text); ${task.completed ? 'text-decoration: line-through; opacity: 0.6;' : ''}">${task.text}</div>
                                <div style="margin-top: 4px;">
                                    <span class="task-tag tag-${task.category}">${task.category}</span>
                                    ${task.time ? `<span class="task-time" style="margin-left: 8px;">‚è±Ô∏è ${task.time}</span>` : ''}
                                </div>
                            </div>
                            <button class="task-action-btn-small btn-edit" onclick="openEditTaskModalFromMonth('${weekKey}', '${dateKey}', ${task.id}, event)" style="padding: 6px 12px;">‚úèÔ∏è</button>
                        </div>
                    `;
                });
                
                document.getElementById('day-detail-tasks').innerHTML = tasksHtml;
            }
            
            // Auto-save notes on change
            const notesTextarea = document.getElementById('day-detail-notes');
            notesTextarea.onchange = function() {
                saveDayNotes(currentDayDetailWeekKey, currentDayDetailKey, this.value);
            };
            
            document.getElementById('day-detail-modal').classList.add('active');
        }


          function toggleTaskInModal(weekKey, dateKey, taskId) {
            const weekData = loadData(weekKey);
            const task = weekData[dateKey].tasks.find(t => t.id === taskId);
            task.completed = !task.completed;
            saveData(weekKey, weekData);
            
            // If this task is from capture list, update capture item status
            if (task.fromCapture) {
                const captureList = JSON.parse(localStorage.getItem('capture-list') || '[]');
                const captureItem = captureList.find(item => 
                    item.text === task.text && (item.status === 'assigned' || item.status === 'completed')
                );
                
                if (captureItem) {
                    if (task.completed) {
                        captureItem.status = 'completed';
                        captureItem.completedAt = new Date().toISOString();
                    } else {
                        captureItem.status = 'assigned';
                        captureItem.completedAt = null;
                    }
                    localStorage.setItem('capture-list', JSON.stringify(captureList));
                }
            }
            
            // Re-render modal content
            openDayDetail(dateKey);
            
            // Refresh month view to update completion %
            renderMonthView();
        }
        function openEditTaskModalFromMonth(weekKey, dateKey, taskId, event) {
            event.stopPropagation();
            
            // Close day detail modal
            closeModal('day-detail-modal');
            
            // Open edit task modal
            openEditTaskModal(weekKey, dateKey, taskId, event);
        }



         function goToDay() {
            if (!currentDayDetailKey) return;
            
            const date = parseLocalDate(currentDayDetailKey);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            date.setHours(0, 0, 0, 0);
            
            closeModal('day-detail-modal');
            
            // Check if it's today
            if (date.getTime() === today.getTime()) {
                switchView('today');
                return;
            }
            
            // Check if it's within current or next week
            const todayWeekStart = getWeekStart(today);
            const nextWeekStart = new Date(todayWeekStart);
            nextWeekStart.setDate(todayWeekStart.getDate() + 7);
            const dateWeekStart = getWeekStart(date);
            
            if (dateWeekStart.getTime() === todayWeekStart.getTime()) {
                currentWeekView = 'current';
                document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
                document.querySelectorAll('.nav-item')[1].classList.add('active');
                switchView('week');
            } else if (dateWeekStart.getTime() === nextWeekStart.getTime()) {
                currentWeekView = 'next';
                document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
                document.querySelectorAll('.nav-item')[1].classList.add('active');
                switchView('week');
            } else {
                // It's further in the future or past
                alert(`This date (${currentDayDetailKey}) is not in the current or next week view. You can view it in the Month view or we can build a date picker to navigate to any week!`);
            }
        }


        function handleDragStart(event, weekKey, dateKey, taskId) {
            event.stopPropagation(); // Prevent expanding task
            draggedTask = { weekKey, dateKey, taskId };
            event.currentTarget.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            
            const target = event.currentTarget;
            if (target.classList.contains('task-item') && !target.classList.contains('dragging')) {
                target.classList.add('drag-over');
            }
        }

        function handleDrop(event, targetWeekKey, targetDateKey, targetTaskId) {
            event.preventDefault();
            event.stopPropagation();
            
            if (!draggedTask) return;
            
            // Remove drag-over class
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            
            // Same day reorder
            if (draggedTask.weekKey === targetWeekKey && draggedTask.dateKey === targetDateKey) {
                reorderTasksInDay(draggedTask.weekKey, draggedTask.dateKey, draggedTask.taskId, targetTaskId);
            } 
            // Move between days
            else {
                moveTaskBetweenDays(draggedTask.weekKey, draggedTask.dateKey, draggedTask.taskId, targetWeekKey, targetDateKey);
            }
        }

        function handleDragEnd(event) {
            event.currentTarget.classList.remove('dragging');
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            draggedTask = null;
        }

        function reorderTasksInDay(weekKey, dateKey, draggedTaskId, targetTaskId) {
            const weekData = loadData(weekKey);
            const tasks = weekData[dateKey].tasks;
            
            const draggedIndex = tasks.findIndex(t => t.id === draggedTaskId);
            const targetIndex = tasks.findIndex(t => t.id === targetTaskId);
            
            if (draggedIndex === -1 || targetIndex === -1) return;
            
            // Remove dragged task
            const [draggedTaskObj] = tasks.splice(draggedIndex, 1);
            
            // Insert at new position
            tasks.splice(targetIndex, 0, draggedTaskObj);
            
            saveData(weekKey, weekData);
            renderCurrentView();
        }

        function moveTaskBetweenDays(sourceWeekKey, sourceDateKey, taskId, targetWeekKey, targetDateKey) {
            // Load source week
            const sourceWeekData = loadData(sourceWeekKey);
            const taskIndex = sourceWeekData[sourceDateKey].tasks.findIndex(t => t.id === taskId);
            
            if (taskIndex === -1) return;
            
            // Get task and remove from source
            const task = sourceWeekData[sourceDateKey].tasks[taskIndex];
            sourceWeekData[sourceDateKey].tasks.splice(taskIndex, 1);
            saveData(sourceWeekKey, sourceWeekData);
            
            // Add to target
            let targetWeekData;
            if (sourceWeekKey === targetWeekKey) {
                targetWeekData = sourceWeekData;
            } else {
                targetWeekData = loadData(targetWeekKey);
            }
            
            targetWeekData[targetDateKey].tasks.push(task);
            saveData(targetWeekKey, targetWeekData);
            
            renderCurrentView();
            alert(`‚úÖ Moved "${task.text}" to ${targetDateKey}`);
        }
        // Touch support for mobile
        let touchStartY = 0;
        let touchCurrentY = 0;
        let touchedElement = null;
        let isDragging = false;
        let dragThreshold = 10; // pixels to move before starting drag

        function handleTouchStart(event) {
            // Don't start drag if clicking checkbox or buttons
            if (event.target.closest('.checkbox') || 
                event.target.closest('button') || 
                event.target.closest('textarea') ||
                event.target.closest('input')) {
                return;
            }
            
            touchedElement = event.currentTarget;
            touchStartY = event.touches[0].clientY;
            touchCurrentY = touchStartY;
            isDragging = false;
            
            // Add a slight delay to distinguish tap from drag
            setTimeout(() => {
                if (touchedElement && Math.abs(touchCurrentY - touchStartY) > dragThreshold) {
                    isDragging = true;
                    touchedElement.classList.add('dragging');
                    
                    // Get task data
                    draggedTask = {
                        weekKey: touchedElement.dataset.weekKey,
                        dateKey: touchedElement.dataset.dateKey,
                        taskId: parseInt(touchedElement.dataset.taskId)
                    };
                }
            }, 100);
        }

        function handleTouchMove(event) {
            if (!touchedElement) return;
            
            touchCurrentY = event.touches[0].clientY;
            
            // Start dragging if moved enough
            if (!isDragging && Math.abs(touchCurrentY - touchStartY) > dragThreshold) {
                isDragging = true;
                touchedElement.classList.add('dragging');
                
                draggedTask = {
                    weekKey: touchedElement.dataset.weekKey,
                    dateKey: touchedElement.dataset.dateKey,
                    taskId: parseInt(touchedElement.dataset.taskId)
                };
            }
            
            if (isDragging) {
                event.preventDefault(); // Prevent scrolling while dragging
                
                // Find element under finger
                const touch = event.touches[0];
                const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
                const taskBelow = elementBelow?.closest('.task-item');
                
                // Remove all drag-over classes
                document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
                
                // Add drag-over to element under finger
                if (taskBelow && taskBelow !== touchedElement) {
                    taskBelow.classList.add('drag-over');
                }
            }
        }

        function handleTouchEnd(event) {
            if (!touchedElement) return;
            
            // If we were dragging, handle the drop
            if (isDragging && draggedTask) {
                const touch = event.changedTouches[0];
                const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
                const taskBelow = elementBelow?.closest('.task-item');
                
                if (taskBelow && taskBelow !== touchedElement) {
                    const targetWeekKey = taskBelow.dataset.weekKey;
                    const targetDateKey = taskBelow.dataset.dateKey;
                    const targetTaskId = parseInt(taskBelow.dataset.taskId);
                    
                    // Same day reorder
                    if (draggedTask.weekKey === targetWeekKey && draggedTask.dateKey === targetDateKey) {
                        reorderTasksInDay(draggedTask.weekKey, draggedTask.dateKey, draggedTask.taskId, targetTaskId);
                    } 
                    // Move between days
                    else {
                        moveTaskBetweenDays(draggedTask.weekKey, draggedTask.dateKey, draggedTask.taskId, targetWeekKey, targetDateKey);
                    }
                }
                
                // Prevent click event from firing
                event.preventDefault();
            } else if (!isDragging) {
                // It was a tap, not a drag - let click handler work
                // Don't prevent default here
            }
            
            // Cleanup
            touchedElement?.classList.remove('dragging');
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            touchedElement = null;
            draggedTask = null;
            isDragging = false;
        }


   function switchView(view) {
    currentView = view;
    document.querySelectorAll('.view-content').forEach(v => v.classList.add('hidden'));
    document.getElementById(`${view}-view`).classList.remove('hidden');
    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
    event.currentTarget.classList.add('active');
    
    if (view === 'routines') renderRoutinesView();
    else if (view === 'metrics') renderMetricsView();
    else if (view === 'month') renderMonthView();
    else if (view === 'capture') renderCaptureList();
    else renderCurrentView();
}




        function showWeek(week) {
            currentWeekView = week;
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');
            renderWeekView();
        }

        function renderCurrentView() {
            if (currentView === 'today') renderTodayView();
            else if (currentView === 'week') renderWeekView();
        }

        function openAddTaskModal(dateKey) {
            currentModalDay = dateKey;
            document.getElementById('task-name').value = '';
            document.getElementById('task-time').value = '';
            document.getElementById('add-task-modal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function generateNewWeek() {
            const nextWeek = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000);
            const weekStart = getWeekStart(nextWeek);
            generateWeekData(weekStart);
            alert('‚ú® Next week generated from your template!');
        }

        function exportData() {
            try {
                const allData = {};
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    allData[key] = localStorage.getItem(key);
                }
                const dataStr = JSON.stringify(allData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `life-reset-backup-${formatDate(new Date())}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                alert('‚úÖ Backup downloaded!');
            } catch (error) {
                console.error('Export error:', error);
                alert('‚ùå Error creating backup.');
            }
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!confirm('‚ö†Ô∏è This will replace all current data. Continue?')) return;
                    localStorage.clear();
                    for (const key in data) localStorage.setItem(key, data[key]);
                    alert('‚úÖ Backup restored!');
                    location.reload();
                } catch (error) {
                    console.error('Import error:', error);
                    alert('‚ùå Invalid backup file.');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function resetApp() {
            if (confirm('‚ö†Ô∏è Delete all data?')) {
                localStorage.clear();
                location.reload();
            }
        }

        // ============================================
        // AUTOMATED TEST SUITE
        // ============================================

        let testResults = [];
        let testItemIds = [];

        function logTest(testName, passed, details = '') {
            testResults.push({ testName, passed, details });
            const icon = passed ? '‚úÖ' : '‚ùå';
            console.log(`${icon} ${testName}${details ? ': ' + details : ''}`);
        }

        function clearTestData() {
            // Remove all test items from capture list
            let captureList = JSON.parse(localStorage.getItem('capture-list') || '[]');
            captureList = captureList.filter(item => !testItemIds.includes(item.id));
            localStorage.setItem('capture-list', JSON.stringify(captureList));
            
            testItemIds = [];
            alert('‚úÖ Test data cleared!');
            renderCaptureList();
            renderCurrentView();
        }

        async function runAllTests() {
            testResults = [];
            testItemIds = [];
            
            document.getElementById('test-results').style.display = 'block';
            document.getElementById('test-summary').innerHTML = '‚è≥ Running tests...';
            document.getElementById('test-details').innerHTML = '';
            
            console.log('üß™ Starting Capture List Test Suite...');
            
            // Give UI time to update
            await sleep(100);
            
            // Run all tests
            await testCreateItemWithTime();
            await testTimeDisplayInAllTabs();
            await testEditItemSyncsEverywhere();
            await testEditAssignmentMovesTask();
            await testDeleteScenario1();
            await testDeleteScenario2();
            await testDeleteScenario3();
            await testCompletionSyncsAllViews();
            await testUncompleteSyncsAllViews();
            await testUnassignRemovesFromSchedule();
            await testNoRecurringOptions();
            await testEditFromMonthView();
            await testGoToThisDay();
            await testDragAndDropReordering();
            await testTaskNotes();
            await testDailyNotes();
            await testAddTaskButton();
            await testRoutinesView();
            await testMultipleSameNameItems();
            await testPriorityDisplay();
            await testSpecialCharacters();
            await testSimultaneousEdits();
            
            // Display results
            displayTestResults();
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function displayTestResults() {
            const passed = testResults.filter(r => r.passed).length;
            const total = testResults.length;
            const percentage = Math.round((passed / total) * 100);
            
            let summaryColor = percentage === 100 ? 'var(--emerald)' : 
                              percentage >= 80 ? 'var(--primary)' : 'var(--ruby)';
            
            document.getElementById('test-summary').innerHTML = `
                <div style="color: ${summaryColor};">
                    ${passed}/${total} tests passed (${percentage}%)
                </div>
            `;
            
            let detailsHtml = '';
            testResults.forEach(result => {
                const icon = result.passed ? '‚úÖ' : '‚ùå';
                const color = result.passed ? 'var(--emerald)' : 'var(--ruby)';
                detailsHtml += `<div style="color: ${color};">${icon} ${result.testName}${result.details ? '<br>&nbsp;&nbsp;&nbsp;&nbsp;' + result.details : ''}</div>`;
            });
            
            document.getElementById('test-details').innerHTML = detailsHtml;
            
            console.log(`\nüéâ Test suite complete: ${passed}/${total} passed`);
        }

        // ============================================
        // INDIVIDUAL TESTS
        // ============================================

        async function testCreateItemWithTime() {
            const testId = Date.now();
            
            // Create test item
            const captureList = JSON.parse(localStorage.getItem('capture-list') || '[]');
            const newItem = {
                id: testId,
                text: 'Test Item ' + testId,
                category: 'cleaning',
                priority: 'high',
                notes: 'Test notes',
                time: '20 min',
                status: 'unassigned',
                assignedTo: null,
                createdAt: new Date().toISOString(),
                completedAt: null,
                fromCapture: true
            };
            
            captureList.push(newItem);
            localStorage.setItem('capture-list', JSON.stringify(captureList));
            testItemIds.push(testId);
            
            // Check if it was created
            const savedList = JSON.parse(localStorage.getItem('capture-list') || '[]');
            const found = savedList.find(i => i.id === testId);
            
            logTest('Create item with time', !!found && found.time === '20 min');
        }

        async function testTimeDisplayInAllTabs() {
            const captureList = JSON.parse(localStorage.getItem('capture-list') || '[]');
            const testItem = captureList.find(i => testItemIds.includes(i.id));
            
            if (!testItem) {
                logTest('Time display in all tabs', false, 'Test item not found');
                return;
            }
            
            // Check time exists
            const hasTime = !!testItem.time;
            logTest('Time display in all tabs', hasTime);
        }

        async function testEditItemSyncsEverywhere() {
            const captureList = JSON.parse(localStorage.getItem('capture-list') || '[]');
            const testItem = captureList.find(i => testItemIds.includes(i.id) && i.status === 'unassigned');
            
            if (!testItem) {
                logTest('Edit item syncs everywhere', false, 'No unassigned test item');
                return;
            }
            
            // Assign it first
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const dateKey = formatDate(tomorrow);
            const weekStart = getWeekStart(tomorrow);
            const weekKey = getWeekKey(weekStart);
            let weekData = loadData(weekKey) || generateWeekData(weekStart);
            
            weekData[dateKey].tasks.push({
                id: Date.now(),
                text: testItem.text,
                category: testItem.category,
                time: testItem.time,
                completed: false,
                notes: testItem.notes,
                fromCapture: true,
                captureItemId: testItem.id
            });
            saveData(weekKey, weekData);
            
            testItem.status = 'assigned';
            testItem.assignedTo = { dateKey, weekKey, time: null };
            localStorage.setItem('capture-list', JSON.stringify(captureList));
            
            // Now edit it
            testItem.text = 'Updated Test Item';
            testItem.category = 'skincare';
            localStorage.setItem('capture-list', JSON.stringify(captureList));
            
            // Update in schedule
            weekData = loadData(weekKey);
            const task = weekData[dateKey].tasks.find(t => t.captureItemId === testItem.id);
            if (task) {
                task.text = testItem.text;
                task.category = testItem.category;
                saveData(weekKey, weekData);
            }
            
            // Check if synced
            weekData = loadData(weekKey);
            const updatedTask = weekData[dateKey].tasks.find(t => t.captureItemId === testItem.id);
            
            logTest('Edit item syncs everywhere', 
                updatedTask && updatedTask.text === 'Updated Test Item' && updatedTask.category === 'skincare');
        }

async function testEditAssignmentMovesTask() {
            // Create new test item
            const testId = Date.now() + 1000;
            let captureList = JSON.parse(localStorage.getItem('capture-list') || '[]');
            const newItem = {
                id: testId,
                text: 'Move Test ' + testId,
                category: 'projects',
                time: '10 min',
                status: 'unassigned',
                assignedTo: null,
                fromCapture: true,
                createdAt: new Date().toISOString(),
                completedAt: null
            };
            captureList.push(newItem);
            testItemIds.push(testId);
            localStorage.setItem('capture-list', JSON.stringify(captureList));
            
            // Assign to tomorrow using the REAL function
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const dateKey1 = formatDate(tomorrow);
            
            // Simulate assignment
            currentAssignItemId = testId;
            document.getElementById('assign-date').value = dateKey1;
            document.getElementById('assign-time').value = '';
            
            // Call the actual function
            confirmAssignCaptureItem();
            
            // Wait for updates
            await sleep(50);
            
            // Verify it's assigned to tomorrow
            captureList = JSON.parse(localStorage.getItem('capture-list') || '[]');
            const item = captureList.find(i => i.id === testId);
            
            if (!item || !item.assignedTo || item.assignedTo.dateKey !== dateKey1) {
                logTest('Edit assignment moves task', false, 'Initial assignment failed');
                return;
            }
            
            const weekStart1 = getWeekStart(tomorrow);
            const weekKey1 = getWeekKey(weekStart1);
            let weekData1 = loadData(weekKey1);
            const taskInTomorrow = weekData1[dateKey1].tasks.find(t => t.captureItemId === testId);
            
            if (!taskInTomorrow) {
                logTest('Edit assignment moves task', false, 'Task not found in tomorrow');
                return;
            }
            
            // Now EDIT the assignment to move it to day after tomorrow
            const dayAfter = new Date();
            dayAfter.setDate(dayAfter.getDate() + 2);
            const dateKey2 = formatDate(dayAfter);
            
            // Simulate editing (item already has assignedTo, so it will detect edit mode)
            currentAssignItemId = testId;
            document.getElementById('assign-date').value = dateKey2;
            document.getElementById('assign-time').value = '';
            
            // Call the actual function again (should detect edit mode and move task)
            confirmAssignCaptureItem();
            
            // Wait for updates
            await sleep(50);
            
            // Check if moved: should be gone from tomorrow, present in day after
            weekData1 = loadData(weekKey1);
            const weekStart2 = getWeekStart(dayAfter);
            const weekKey2 = getWeekKey(weekStart2);
            const weekData2 = loadData(weekKey2);
            
            const notInOld = !weekData1[dateKey1].tasks.find(t => t.captureItemId === testId);
            const inNew = weekData2 && weekData2[dateKey2] && !!weekData2[dateKey2].tasks.find(t => t.captureItemId === testId);
            
            // Check capture item updated
            captureList = JSON.parse(localStorage.getItem('capture-list') || '[]');
            const updatedItem = captureList.find(i => i.id === testId);
            const captureUpdated = updatedItem.assignedTo.dateKey === dateKey2;
            
            logTest('Edit assignment moves task', 
                notInOld && inNew && captureUpdated,
                notInOld && inNew && captureUpdated ? '' : `Old: ${!notInOld}, New: ${!inNew}, Capture: ${!captureUpdated}`);
        }

        async function testDeleteScenario1() {
            // Scenario 1: Delete unassigned item
            const testId = Date.now() + 2000;
            const captureList = JSON.parse(localStorage.getItem('capture-list') || '[]');
            const newItem = {
                id: testId,
                text: 'Delete Test 1',
                category: 'other',
                status: 'unassigned',
                assignedTo: null,
                fromCapture: true
            };
            captureList.push(newItem);
            testItemIds.push(testId);
            localStorage.setItem('capture-list', JSON.stringify(captureList));
            
            // Delete it
            const filtered = captureList.filter(i => i.id !== testId);
            localStorage.setItem('capture-list', JSON.stringify(filtered));
            
            // Check if deleted
            const afterDelete = JSON.parse(localStorage.getItem('capture-list') || '[]');
            const notFound = !afterDelete.find(i => i.id === testId);
            
            logTest('Delete Scenario 1: Unassigned', notFound);
        }

        async function testDeleteScenario2() {
            // Scenario 2: Delete assigned (future, not complete)
            const testId = Date.now() + 3000;
            const captureList = JSON.parse(localStorage.getItem('capture-list') || '[]');
            const newItem = {
                id: testId,
                text: 'Delete Test 2',
                category: 'other',
                status: 'assigned',
                fromCapture: true
            };
            
            // Assign to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const dateKey = formatDate(tomorrow);
            const weekStart = getWeekStart(tomorrow);
            const weekKey = getWeekKey(weekStart);
            let weekData = loadData(weekKey) || generateWeekData(weekStart);
            
            weekData[dateKey].tasks.push({
                id: Date.now(),
                text: newItem.text,
                completed: false,
                fromCapture: true,
                captureItemId: testId
            });
            saveData(weekKey, weekData);
            
            newItem.assignedTo = { dateKey, weekKey };
            captureList.push(newItem);
            testItemIds.push(testId);
            localStorage.setItem('capture-list', JSON.stringify(captureList));
            
            // Delete from capture list AND schedule
            const filtered = captureList.filter(i => i.id !== testId);
            localStorage.setItem('capture-list', JSON.stringify(filtered));
            
            weekData = loadData(weekKey);
            weekData[dateKey].tasks = weekData[dateKey].tasks.filter(t => t.captureItemId !== testId);
            saveData(weekKey, weekData);
            
            // Check both deleted
            const afterCaptureDelete = JSON.parse(localStorage.getItem('capture-list') || '[]');
            weekData = loadData(weekKey);
            const notInCapture = !afterCaptureDelete.find(i => i.id === testId);
            const notInSchedule = !weekData[dateKey].tasks.find(t => t.captureItemId === testId);
            
            logTest('Delete Scenario 2: Future + not complete', notInCapture && notInSchedule);
        }

        async function testDeleteScenario3() {
            // Scenario 3: Delete assigned (future, completed)
            const testId = Date.now() + 4000;
            const captureList = JSON.parse(localStorage.getItem('capture-list') || '[]');
            const newItem = {
                id: testId,
                text: 'Delete Test 3',
                category: 'other',
                status: 'completed',
                fromCapture: true
            };
            
            // Assign to tomorrow and mark complete
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const dateKey = formatDate(tomorrow);
            const weekStart = getWeekStart(tomorrow);
            const weekKey = getWeekKey(weekStart);
            let weekData = loadData(weekKey) || generateWeekData(weekStart);
            
            weekData[dateKey].tasks.push({
                id: Date.now(),
                text: newItem.text,
                completed: true, // Completed!
                fromCapture: true,
                captureItemId: testId
            });
            saveData(weekKey, weekData);
            
            newItem.assignedTo = { dateKey, weekKey };
            captureList.push(newItem);
            testItemIds.push(testId);
            localStorage.setItem('capture-list', JSON.stringify(captureList));
            
            // Delete from capture list only (keep in schedule)
            const filtered = captureList.filter(i => i.id !== testId);
            localStorage.setItem('capture-list', JSON.stringify(filtered));
            
            // Check: not in capture, still in schedule
            const afterDelete = JSON.parse(localStorage.getItem('capture-list') || '[]');
            weekData = loadData(weekKey);
            const notInCapture = !afterDelete.find(i => i.id === testId);
            const stillInSchedule = !!weekData[dateKey].tasks.find(t => t.captureItemId === testId);
            
            logTest('Delete Scenario 3: Future + completed', notInCapture && stillInSchedule);
        }

        async function testCompletionSyncsAllViews() {
            // Create and assign item
            const testId = Date.now() + 5000;
            const captureList = JSON.parse(localStorage.getItem('capture-list') || '[]');
            const newItem = {
                id: testId,
                text: 'Complete Test',
                category: 'other',
                status: 'assigned',
                fromCapture: true
            };
            
            const today = new Date();
            const dateKey = formatDate(today);
            const weekStart = getWeekStart(today);
            const weekKey = getWeekKey(weekStart);
            let weekData = loadData(weekKey) || generateWeekData(weekStart);
            
            const taskId = Date.now();
            weekData[dateKey].tasks.push({
                id: taskId,
                text: newItem.text,
                completed: false,
                fromCapture: true,
                captureItemId: testId
            });
            saveData(weekKey, weekData);
            
            newItem.assignedTo = { dateKey, weekKey };
            captureList.push(newItem);
            testItemIds.push(testId);
            localStorage.setItem('capture-list', JSON.stringify(captureList));
            
            // Complete it in schedule
            weekData = loadData(weekKey);
            const task = weekData[dateKey].tasks.find(t => t.captureItemId === testId);
            task.completed = true;
            saveData(weekKey, weekData);
            
            // Update capture item
            const item = captureList.find(i => i.id === testId);
            item.status = 'completed';
            item.completedAt = new Date().toISOString();
            localStorage.setItem('capture-list', JSON.stringify(captureList));
            
            // Check both completed
            const updatedList = JSON.parse(localStorage.getItem('capture-list') || '[]');
            weekData = loadData(weekKey);
            const captureCompleted = updatedList.find(i => i.id === testId)?.status === 'completed';
            const scheduleCompleted = weekData[dateKey].tasks.find(t => t.captureItemId === testId)?.completed === true;
            
            logTest('Completion syncs all views', captureCompleted && scheduleCompleted);
        }

        async function testUncompleteSyncsAllViews() {
            // Find a completed test item
            const captureList = JSON.parse(localStorage.getItem('capture-list') || '[]');
            const testItem = captureList.find(i => testItemIds.includes(i.id) && i.status === 'completed');
            
            if (!testItem || !testItem.assignedTo) {
                logTest('Uncomplete syncs all views', false, 'No completed test item with assignment');
                return;
            }
            
            // Uncomplete it
            testItem.status = 'assigned';
            testItem.completedAt = null;
            localStorage.setItem('capture-list', JSON.stringify(captureList));
            
            // Uncomplete in schedule
            const weekData = loadData(testItem.assignedTo.weekKey);
            const task = weekData[testItem.assignedTo.dateKey].tasks.find(t => t.captureItemId === testItem.id);
            if (task) {
                task.completed = false;
                saveData(testItem.assignedTo.weekKey, weekData);
            }
            
            // Check both uncompleted
            const updatedList = JSON.parse(localStorage.getItem('capture-list') || '[]');
            const updatedWeekData = loadData(testItem.assignedTo.weekKey);
            const captureUncompleted = updatedList.find(i => i.id === testItem.id)?.status === 'assigned';
            const scheduleUncompleted = updatedWeekData[testItem.assignedTo.dateKey].tasks.find(t => t.captureItemId === testItem.id)?.completed === false;
            
            logTest('Uncomplete syncs all views', captureUncompleted && scheduleUncompleted);
        }

        async function testUnassignRemovesFromSchedule() {
            // Create and assign new item
            const testId = Date.now() + 6000;
            const captureList = JSON.parse(localStorage.getItem('capture-list') || '[]');
            const newItem = {
                id: testId,
                text: 'Unassign Test',
                category: 'other',
                status: 'assigned',
                fromCapture: true
            };
            
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const dateKey = formatDate(tomorrow);
            const weekStart = getWeekStart(tomorrow);
            const weekKey = getWeekKey(weekStart);
            let weekData = loadData(weekKey) || generateWeekData(weekStart);
            
            weekData[dateKey].tasks.push({
                id: Date.now(),
                text: newItem.text,
                completed: false,
                fromCapture: true,
                captureItemId: testId
            });
            saveData(weekKey, weekData);
            
            newItem.assignedTo = { dateKey, weekKey };
            captureList.push(newItem);
            testItemIds.push(testId);
            localStorage.setItem('capture-list', JSON.stringify(captureList));
            
            // Unassign it
            newItem.status = 'unassigned';
            newItem.assignedTo = null;
            localStorage.setItem('capture-list', JSON.stringify(captureList));
            
            // Remove from schedule
            weekData = loadData(weekKey);
            weekData[dateKey].tasks = weekData[dateKey].tasks.filter(t => t.captureItemId !== testId);
            saveData(weekKey, weekData);
            
            // Check: unassigned in capture, gone from schedule
            const updatedList = JSON.parse(localStorage.getItem('capture-list') || '[]');
            const updatedWeekData = loadData(weekKey);
            const isUnassigned = updatedList.find(i => i.id === testId)?.status === 'unassigned';
            const notInSchedule = !updatedWeekData[dateKey].tasks.find(t => t.captureItemId === testId);
            
            logTest('Unassign removes from schedule', isUnassigned && notInSchedule);
        }

        async function testNoRecurringOptions() {
            // This is a visual check - we can't easily test UI visibility in code
            // But we can check that the functions don't exist
            const noRecurringFunction = typeof toggleRecurringOptions === 'undefined';
            logTest('No recurring options', true, 'Visual check - verify no "Make recurring" checkbox in UI');
        }
        async function testEditFromMonthView() {
            // Create and assign item
            const testId = Date.now() + 7000;
            const captureList = JSON.parse(localStorage.getItem('capture-list') || '[]');
            const newItem = {
                id: testId,
                text: 'Month Edit Test',
                category: 'cleaning',
                time: '15 min',
                status: 'assigned',
                fromCapture: true
            };
            
            const today = new Date();
            const dateKey = formatDate(today);
            const weekStart = getWeekStart(today);
            const weekKey = getWeekKey(weekStart);
            let weekData = loadData(weekKey) || generateWeekData(weekStart);
            
            weekData[dateKey].tasks.push({
                id: Date.now(),
                text: newItem.text,
                category: newItem.category,
                time: newItem.time,
                completed: false,
                fromCapture: true,
                captureItemId: testId
            });
            saveData(weekKey, weekData);
            
            newItem.assignedTo = { dateKey, weekKey };
            captureList.push(newItem);
            testItemIds.push(testId);
            localStorage.setItem('capture-list', JSON.stringify(captureList));
            
            // Simulate editing from month view (update task in schedule)
            weekData = loadData(weekKey);
            const task = weekData[dateKey].tasks.find(t => t.captureItemId === testId);
            if (task) {
                task.text = 'Edited from Month';
                task.category = 'skincare';
                saveData(weekKey, weekData);
            }
            
            // Check if edit persisted
            weekData = loadData(weekKey);
            const editedTask = weekData[dateKey].tasks.find(t => t.captureItemId === testId);
            
            logTest('Edit from Month view', 
                editedTask && editedTask.text === 'Edited from Month' && editedTask.category === 'skincare');
        }

        async function testGoToThisDay() {
            // Test navigation logic for different date ranges
            const today = new Date();
            
            // Test 1: Today
            const todayKey = formatDate(today);
            const todayWeekStart = getWeekStart(today);
            const todayTest = todayKey === formatDate(today);
            
            // Test 2: Tomorrow (current or next week)
            const tomorrow = new Date(today);
            tomorrow.setDate(today.getDate() + 1);
            const tomorrowWeekStart = getWeekStart(tomorrow);
            const tomorrowInRange = 
                tomorrowWeekStart.getTime() === todayWeekStart.getTime() ||
                tomorrowWeekStart.getTime() === new Date(todayWeekStart.getTime() + 7*24*60*60*1000).getTime();
            
            // Test 3: Far future (3 weeks)
            const farFuture = new Date(today);
            farFuture.setDate(today.getDate() + 21);
            const farWeekStart = getWeekStart(farFuture);
            const farOutOfRange = 
                farWeekStart.getTime() !== todayWeekStart.getTime() &&
                farWeekStart.getTime() !== new Date(todayWeekStart.getTime() + 7*24*60*60*1000).getTime();
            
            logTest('Go to This Day navigation', 
                todayTest && tomorrowInRange && farOutOfRange,
                todayTest && tomorrowInRange && farOutOfRange ? '' : 'Navigation logic may have issues');
        }

        async function testDragAndDropReordering() {
            // Create two tasks on same day
            const testId1 = Date.now() + 8000;
            const testId2 = Date.now() + 8001;
            
            const today = new Date();
            const dateKey = formatDate(today);
            const weekStart = getWeekStart(today);
            const weekKey = getWeekKey(weekStart);
            let weekData = loadData(weekKey) || generateWeekData(weekStart);
            
            // Add two test tasks
            const task1 = {
                id: Date.now(),
                text: 'Task First',
                category: 'other',
                completed: false,
                fromCapture: true,
                captureItemId: testId1
            };
            
            const task2 = {
                id: Date.now() + 1,
                text: 'Task Second',
                category: 'other',
                completed: false,
                fromCapture: true,
                captureItemId: testId2
            };
            
            weekData[dateKey].tasks.push(task1, task2);
            saveData(weekKey, weekData);
            
            // Simulate reorder (swap them)
            weekData = loadData(weekKey);
            const tasks = weekData[dateKey].tasks;
            const idx1 = tasks.findIndex(t => t.captureItemId === testId1);
            const idx2 = tasks.findIndex(t => t.captureItemId === testId2);
            
            if (idx1 !== -1 && idx2 !== -1) {
                [tasks[idx1], tasks[idx2]] = [tasks[idx2], tasks[idx1]];
                saveData(weekKey, weekData);
            }
            
            // Check if reordered
            weekData = loadData(weekKey);
            const newIdx1 = weekData[dateKey].tasks.findIndex(t => t.captureItemId === testId1);
            const newIdx2 = weekData[dateKey].tasks.findIndex(t => t.captureItemId === testId2);
            
            testItemIds.push(testId1, testId2);
            
            logTest('Drag & drop reordering', 
                newIdx1 > newIdx2,
                'Test verifies reorder logic works - manual UI test needed for touch/drag events');
        }

        async function testTaskNotes() {
            // Create task with notes
            const testId = Date.now() + 9000;
            const captureList = JSON.parse(localStorage.getItem('capture-list') || '[]');
            const newItem = {
                id: testId,
                text: 'Notes Test',
                category: 'other',
                notes: 'Original capture notes',
                status: 'assigned',
                fromCapture: true
            };
            
            const today = new Date();
            const dateKey = formatDate(today);
            const weekStart = getWeekStart(today);
            const weekKey = getWeekKey(weekStart);
            let weekData = loadData(weekKey) || generateWeekData(weekStart);
            
            weekData[dateKey].tasks.push({
                id: Date.now(),
                text: newItem.text,
                notes: newItem.notes,
                completed: false,
                fromCapture: true,
                captureItemId: testId
            });
            saveData(weekKey, weekData);
            
            newItem.assignedTo = { dateKey, weekKey };
            captureList.push(newItem);
            testItemIds.push(testId);
            localStorage.setItem('capture-list', JSON.stringify(captureList));
            
            // Add additional notes to task
            weekData = loadData(weekKey);
            const task = weekData[dateKey].tasks.find(t => t.captureItemId === testId);
            if (task) {
                task.notes = 'Original capture notes\nAdditional task notes';
                saveData(weekKey, weekData);
            }
            
            // Check notes persisted
            weekData = loadData(weekKey);
            const taskWithNotes = weekData[dateKey].tasks.find(t => t.captureItemId === testId);
            
            logTest('Task notes', 
                taskWithNotes && taskWithNotes.notes && taskWithNotes.notes.includes('Additional task notes'));
        }

        async function testDailyNotes() {
            const today = new Date();
            const dateKey = formatDate(today);
            const weekStart = getWeekStart(today);
            const weekKey = getWeekKey(weekStart);
            let weekData = loadData(weekKey) || generateWeekData(weekStart);
            
            // Add daily notes
            weekData[dateKey].dayNotes = 'Test daily notes for ' + dateKey;
            saveData(weekKey, weekData);
            
            // Check notes persisted
            weekData = loadData(weekKey);
            const notesExist = weekData[dateKey].dayNotes === 'Test daily notes for ' + dateKey;
            
            logTest('Daily notes', notesExist);
        }

        async function testAddTaskButton() {
            const today = new Date();
            const dateKey = formatDate(today);
            const weekStart = getWeekStart(today);
            const weekKey = getWeekKey(weekStart);
            let weekData = loadData(weekKey) || generateWeekData(weekStart);
            
            // Simulate adding a custom task (not from capture)
            const customTask = {
                id: Date.now(),
                text: 'Custom Task Test',
                category: 'cleaning',
                time: '10 min',
                completed: false,
                custom: true,
                notes: ''
            };
            
            weekData[dateKey].tasks.push(customTask);
            saveData(weekKey, weekData);
            
            // Check task was added
            weekData = loadData(weekKey);
            const taskFound = weekData[dateKey].tasks.find(t => t.text === 'Custom Task Test' && t.custom === true);
            
            logTest('Add Task button (non-capture)', !!taskFound);
        }

        async function testRoutinesView() {
            // Check if routines library still works
            const hasRoutines = typeof ROUTINES_LIBRARY !== 'undefined' && Object.keys(ROUTINES_LIBRARY).length > 0;
            
            // Check if renderRoutinesView function exists
            const functionExists = typeof renderRoutinesView === 'function';
            
            logTest('Routines view', 
                hasRoutines && functionExists,
                'Basic check - manual test recommended for full routine functionality');
        }

        async function testMultipleSameNameItems() {
            const testId1 = Date.now() + 10000;
            const testId2 = Date.now() + 10001;
            
            const captureList = JSON.parse(localStorage.getItem('capture-list') || '[]');
            
            // Create two items with same name
            const item1 = {
                id: testId1,
                text: 'Duplicate Name',
                category: 'cleaning',
                status: 'unassigned',
                fromCapture: true
            };
            
            const item2 = {
                id: testId2,
                text: 'Duplicate Name',
                category: 'skincare',
                status: 'unassigned',
                fromCapture: true
            };
            
            captureList.push(item1, item2);
            testItemIds.push(testId1, testId2);
            localStorage.setItem('capture-list', JSON.stringify(captureList));
            
            // Assign both to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const dateKey = formatDate(tomorrow);
            const weekStart = getWeekStart(tomorrow);
            const weekKey = getWeekKey(weekStart);
            let weekData = loadData(weekKey) || generateWeekData(weekStart);
            
            weekData[dateKey].tasks.push({
                id: Date.now(),
                text: 'Duplicate Name',
                category: 'cleaning',
                completed: false,
                fromCapture: true,
                captureItemId: testId1
            });
            
            weekData[dateKey].tasks.push({
                id: Date.now() + 1,
                text: 'Duplicate Name',
                category: 'skincare',
                completed: false,
                fromCapture: true,
                captureItemId: testId2
            });
            
            saveData(weekKey, weekData);
            
            item1.status = 'assigned';
            item1.assignedTo = { dateKey, weekKey };
            item2.status = 'assigned';
            item2.assignedTo = { dateKey, weekKey };
            localStorage.setItem('capture-list', JSON.stringify(captureList));
            
            // Check both exist with different IDs
            const updatedList = JSON.parse(localStorage.getItem('capture-list') || '[]');
            weekData = loadData(weekKey);
            
            const item1Exists = updatedList.find(i => i.id === testId1);
            const item2Exists = updatedList.find(i => i.id === testId2);
            const task1Exists = weekData[dateKey].tasks.find(t => t.captureItemId === testId1);
            const task2Exists = weekData[dateKey].tasks.find(t => t.captureItemId === testId2);
            
            logTest('Multiple items same name', 
                item1Exists && item2Exists && task1Exists && task2Exists,
                'Both items tracked separately despite same name');
        }

        async function testPriorityDisplay() {
            const testId = Date.now() + 11000;
            const captureList = JSON.parse(localStorage.getItem('capture-list') || '[]');
            
            const newItem = {
                id: testId,
                text: 'Priority Test',
                category: 'other',
                priority: 'high',
                status: 'unassigned',
                fromCapture: true
            };
            
            captureList.push(newItem);
            testItemIds.push(testId);
            localStorage.setItem('capture-list', JSON.stringify(captureList));
            
            // Check priority is stored
            const updatedList = JSON.parse(localStorage.getItem('capture-list') || '[]');
            const itemWithPriority = updatedList.find(i => i.id === testId);
            
            logTest('Priority display', 
                itemWithPriority && itemWithPriority.priority === 'high',
                'Priority stored - manual check needed for visual display');
        }

        async function testSpecialCharacters() {
            const testId = Date.now() + 12000;
            const captureList = JSON.parse(localStorage.getItem('capture-list') || '[]');
            
            const specialText = 'Test "quotes" & <html> üéâ √©moji';
            
            const newItem = {
                id: testId,
                text: specialText,
                category: 'other',
                status: 'unassigned',
                fromCapture: true
            };
            
            captureList.push(newItem);
            testItemIds.push(testId);
            localStorage.setItem('capture-list', JSON.stringify(captureList));
            
            // Check special chars persisted
            const updatedList = JSON.parse(localStorage.getItem('capture-list') || '[]');
            const itemWithSpecial = updatedList.find(i => i.id === testId);
            
            logTest('Special characters', 
                itemWithSpecial && itemWithSpecial.text === specialText,
                'Special chars, quotes, emojis handled correctly');
        }

        async function testSimultaneousEdits() {
            // Create item
            const testId = Date.now() + 13000;
            const captureList = JSON.parse(localStorage.getItem('capture-list') || '[]');
            const newItem = {
                id: testId,
                text: 'Simultaneous Test',
                category: 'cleaning',
                status: 'assigned',
                fromCapture: true
            };
            
            const today = new Date();
            const dateKey = formatDate(today);
            const weekStart = getWeekStart(today);
            const weekKey = getWeekKey(weekStart);
            let weekData = loadData(weekKey) || generateWeekData(weekStart);
            
            weekData[dateKey].tasks.push({
                id: Date.now(),
                text: newItem.text,
                category: newItem.category,
                completed: false,
                fromCapture: true,
                captureItemId: testId
            });
            saveData(weekKey, weekData);
            
            newItem.assignedTo = { dateKey, weekKey };
            captureList.push(newItem);
            testItemIds.push(testId);
            localStorage.setItem('capture-list', JSON.stringify(captureList));
            
            // Simulate edit from capture list
            const updatedList = JSON.parse(localStorage.getItem('capture-list') || '[]');
            const item = updatedList.find(i => i.id === testId);
            item.text = 'Edited in Capture';
            localStorage.setItem('capture-list', JSON.stringify(updatedList));
            
            // Simulate simultaneous edit in schedule
            weekData = loadData(weekKey);
            const task = weekData[dateKey].tasks.find(t => t.captureItemId === testId);
            task.text = 'Edited in Schedule';
            saveData(weekKey, weekData);
            
            // Check for conflicts (last write wins)
            const finalList = JSON.parse(localStorage.getItem('capture-list') || '[]');
            const finalWeekData = loadData(weekKey);
            const finalItem = finalList.find(i => i.id === testId);
            const finalTask = finalWeekData[dateKey].tasks.find(t => t.captureItemId === testId);
            
            logTest('Simultaneous edits', 
                finalItem && finalTask,
                'Last write wins - may cause desync if multiple tabs open');
        }
        
    function init() {
        // Check if we're in test mode
            if (window.location.hash === '#test') {
                currentView = 'test';
                document.getElementById('test-view').classList.remove('hidden');
                document.getElementById('today-view').classList.add('hidden');
            }
            loadRoutinesLibrary();
            renderTodayView();
        }

        init();
        setInterval(() => {
            const now = new Date();
            if (now.getHours() === 0 && now.getMinutes() === 0) init();
        }, 60000);
    </script>
</body>
</html>
